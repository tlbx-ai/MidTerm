"use strict";(()=>{var ro=Object.defineProperty;var T=(e,t)=>()=>(e&&(t=e(e=0)),t);var ao=(e,t)=>{for(var n in t)ro(e,n,{get:t[n],enumerable:!0})};var At,E,Mt,Bt,Rt,kt,Nt,De,w,fe,ge,Y,Pt,_t,O,he,ye,ve,Se,G,Ht,A=T(()=>{"use strict";At=typeof BUILD_VERSION<"u"?BUILD_VERSION:"dev",E=9,Mt=1,Bt=2,Rt=3,kt=5,Nt=6,De=7,w={dark:{background:"#06060E",foreground:"#DCDCF5",cursor:"#DCDCF5",cursorAccent:"#06060E",selectionBackground:"#283457"},light:{background:"#D5D6DB",foreground:"#343B58",cursor:"#343B58",cursorAccent:"#D5D6DB",selectionBackground:"#9FA0A5"},solarizedDark:{background:"#002B36",foreground:"#839496",cursor:"#839496",cursorAccent:"#002B36",selectionBackground:"#073642"},solarizedLight:{background:"#FDF6E3",foreground:"#657B83",cursor:"#657B83",cursorAccent:"#FDF6E3",selectionBackground:"#EEE8D5"}},fe=1e3,ge=3e4,Y="'Cascadia Code', 'Cascadia Mono', Consolas, 'Courier New', monospace",Pt=.6,_t=1.2,O=8,he=10,ye=5,ve=300,Se=100,G=500,Ht=768});function Ft(e){m=e}function ee(e){c=e}function $e(e){p=e}function Ee(e){M=e}function Ut(e){B=e}function Xe(e){J=e}function je(e){be=e}function we(e){lo=e}function Ke(e){Q=e}function Dt(e){Oe=e}function Ye(e){We=e}function Ge(e){W=e}function Je(e){S=e}function Ot(e){ze=e}function Qe(e){qe=e}function Ze(e){z=e}function Wt(e){Ve=e}function Te(e){Z=e}function zt(e){xe=e}function qt(){a.sessionList=document.getElementById("session-list"),a.sessionCount=document.getElementById("session-count"),a.terminalsArea=document.querySelector(".terminals-area"),a.emptyState=document.getElementById("empty-state"),a.mobileTitle=document.getElementById("mobile-title"),a.topbarActions=document.getElementById("topbar-actions"),a.app=document.getElementById("app"),a.sidebarOverlay=document.getElementById("sidebar-overlay"),a.settingsView=document.getElementById("settings-view"),a.settingsBtn=document.getElementById("btn-settings"),a.titleBarCustom=document.getElementById("title-bar-custom"),a.titleBarTerminal=document.getElementById("title-bar-terminal"),a.titleBarSeparator=document.getElementById("title-bar-separator")}var m,c,p,M,B,J,be,lo,Q,Oe,We,W,S,ze,qe,z,Ve,xe,u,q,P,C,Z,a,h=T(()=>{"use strict";m=[],c=null,p=null,M=null,B=null,J=!1,be=!1,lo=!1,Q=null,We=1e3,W=!1,S=null,qe=1e3,z=!1,Ve=!1,xe=null,u=new Map,q=new Set,P=new Set,C=new Map,Z=null,a={sessionList:null,sessionCount:null,terminalsArea:null,emptyState:null,mobileTitle:null,topbarActions:null,app:null,sidebarOverlay:null,settingsView:null,settingsBtn:null,titleBarCustom:null,titleBarTerminal:null,titleBarSeparator:null}});function k(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function g(e,t){let n=document.getElementById(e);n&&n.addEventListener("click",t)}var Vt=T(()=>{"use strict"});function et(e){let n=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"))?.[2];return n!==void 0?decodeURIComponent(n):null}function _(e,t,n=365){let o=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${e}=${encodeURIComponent(t)}; expires=${o}; path=/`}function $t(e){if(e!=="auto")return e;let t=navigator.userAgent||"";return/Windows|Win32|Win64/i.test(t)?"windows":"unix"}var Xt=T(()=>{"use strict"});function Ce(e){let t=(e[0]??0)|(e[1]??0)<<8,n=(e[2]??0)|(e[3]??0)<<8,o=e.slice(4),s=t>0&&t<=G&&n>0&&n<=G;return{cols:t,rows:n,data:o,valid:s}}async function jt(e){let t=(e[0]??0)|(e[1]??0)<<8,n=(e[2]??0)|(e[3]??0)<<8,o=t>0&&t<=G&&n>0&&n<=G,s=e.slice(8);try{let i=await co(s);return{cols:t,rows:n,data:i,valid:o}}catch(i){return console.error("Decompression failed:",i),{cols:t,rows:n,data:new Uint8Array(0),valid:!1}}}async function co(e){let n=new Blob([e]).stream().pipeThrough(new DecompressionStream("gzip"));return new Uint8Array(await new Response(n).arrayBuffer())}var Kt=T(()=>{"use strict";A()});function Le(e,t,n,o,s,i){i!==void 0&&clearTimeout(i);let r=window.setTimeout(()=>{o(Math.min(e*1.5,t)),n()},e);s(r)}var Yt=T(()=>{"use strict"});var L=T(()=>{"use strict";Vt();Xt();Kt();Yt()});function b(e,t){let n=document.getElementById(e);n&&(n.value=String(t))}function U(e,t){let n=document.getElementById(e);n&&(n.checked=t)}function x(e,t){let n=document.getElementById(e);return n?n.value:t}function D(e){let t=document.getElementById(e);return t?t.checked:!1}function Fn(e,t,n){let o=l=>"v"+(l.split(/[+-]/)[0]??l),s=document.getElementById("version-server");s&&e&&(s.textContent=o(e));let i=document.getElementById("version-frontend");i&&(i.textContent=n==="dev"?"dev":o(n));let r=document.getElementById("version-host");r&&(r.textContent=t?o(t):"-")}function Un(e,t){let n=document.getElementById("setting-run-as-user");n&&(n.innerHTML='<option value="">Process Owner (default)</option>',e.forEach(o=>{let s=document.createElement("option");s.value=o.username,s.textContent=o.username,o.username===t&&(s.selected=!0),n.appendChild(s)}))}function Dn(e){b("setting-default-shell",e.defaultShell||"Pwsh"),b("setting-working-dir",e.defaultWorkingDirectory||""),b("setting-font-size",e.fontSize||14),b("setting-font-family",e.fontFamily||"Cascadia Code"),b("setting-cursor-style",e.cursorStyle||"bar"),U("setting-cursor-blink",e.cursorBlink!==!1),b("setting-theme",e.theme||"dark"),b("setting-contrast",String(e.minimumContrastRatio||1)),b("setting-scrollback",e.scrollbackLines||1e4),b("setting-bell-style",e.bellStyle||"notification"),U("setting-copy-on-select",e.copyOnSelect===!0),U("setting-right-click-paste",e.rightClickPaste!==!1),b("setting-clipboard-shortcuts",e.clipboardShortcuts||"auto"),U("setting-smooth-scrolling",e.smoothScrolling===!0),U("setting-webgl",e.useWebGL!==!1),b("setting-run-as-user",e.runAsUser||""),U("setting-debug-logging",e.debugLogging===!0)}async function re(){try{let[e,t,n,o]=await Promise.all([fetch("/api/settings").then(s=>s.json()),fetch("/api/users").then(s=>s.json()).catch(()=>[]),fetch("/api/version").then(s=>s.text()).catch(()=>null),fetch("/api/health").then(s=>s.json()).catch(()=>({status:"",memoryMB:0,uptime:"",sessionCount:0,ttyHostVersion:void 0}))]);$e(e),Un(t,e.runAsUser),Dn(e),Fn(n,o.ttyHostVersion??null,At),On()}catch(e){console.error("Error fetching settings:",e)}}function On(){if(!p)return;let e=p,t=w[e.theme]||w.dark,n=`'${e.fontFamily||"Cascadia Code"}', ${Y}`;u.forEach(o=>{if(o.terminal.options.cursorBlink=e.cursorBlink,o.terminal.options.cursorStyle=e.cursorStyle,o.terminal.options.fontFamily=n,o.terminal.options.fontSize=e.fontSize,o.terminal.options.theme=t,o.terminal.options.minimumContrastRatio=e.minimumContrastRatio,o.terminal.options.smoothScrollDuration=e.smoothScrolling?150:0,o.opened)try{let s=o.fitAddon.proposeDimensions();s?.cols&&s?.rows&&o.fitAddon.fit()}catch{}})}function He(){let e=x("setting-run-as-user",""),t={defaultShell:x("setting-default-shell","Pwsh"),defaultCols:p?.defaultCols??120,defaultRows:p?.defaultRows??30,defaultWorkingDirectory:x("setting-working-dir",""),fontSize:parseInt(x("setting-font-size","14"),10)||14,fontFamily:x("setting-font-family","Cascadia Code"),cursorStyle:x("setting-cursor-style","bar"),cursorBlink:D("setting-cursor-blink"),theme:x("setting-theme","dark"),minimumContrastRatio:parseFloat(x("setting-contrast","1"))||1,smoothScrolling:D("setting-smooth-scrolling"),useWebGL:D("setting-webgl"),scrollbackLines:parseInt(x("setting-scrollback","10000"),10)||1e4,bellStyle:x("setting-bell-style","notification"),copyOnSelect:D("setting-copy-on-select"),rightClickPaste:D("setting-right-click-paste"),clipboardShortcuts:x("setting-clipboard-shortcuts","auto"),runAsUser:e||null,debugLogging:D("setting-debug-logging")};_("mm-theme",t.theme),fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(n=>{if(n.ok){$e(t);let o=w[t.theme]||w.dark;document.documentElement.style.setProperty("--terminal-bg",o.background),On()}}).catch(n=>{console.error("Error saving settings:",n)})}function Ho(){let e=a.settingsView;e&&(e.querySelectorAll('select, input[type="checkbox"]').forEach(t=>{t.addEventListener("change",He)}),e.querySelectorAll(".text-input-wrapper").forEach(t=>{let n=t.querySelector("input"),o=t.querySelector(".inline-save-btn");if(!n||!o)return;let s="";n.addEventListener("focus",()=>{s=n.value}),n.addEventListener("input",()=>{t.classList.toggle("unsaved",n.value!==s)}),o.addEventListener("click",()=>{He(),t.classList.remove("unsaved"),s=n.value}),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),He(),t.classList.remove("unsaved"),s=n.value)})}))}var ft=T(()=>{"use strict";A();h();L()});function Fo(){let e=a.app;e&&e.classList.remove("sidebar-open")}function gt(){J?Fe():Wn()}function Wn(){if(Xe(!0),a.settingsBtn&&a.settingsBtn.classList.add("active"),Fo(),c){let e=u.get(c);e&&e.container.classList.add("hidden")}a.emptyState&&a.emptyState.classList.add("hidden"),a.settingsView&&a.settingsView.classList.remove("hidden"),re(),qn()}function Fe(){if(Xe(!1),a.settingsBtn&&a.settingsBtn.classList.remove("active"),a.settingsView&&a.settingsView.classList.add("hidden"),c){let e=u.get(c);e&&(e.container.classList.remove("hidden"),requestAnimationFrame(()=>{e.terminal.focus()}))}else m.length===0&&a.emptyState&&a.emptyState.classList.remove("hidden")}function zn(e){if(e<60)return e+"s";if(e<3600)return Math.floor(e/60)+"m "+e%60+"s";let t=Math.floor(e/3600),n=Math.floor(e%3600/60);return t<24?t+"h "+n+"m":Math.floor(t/24)+"d "+t%24+"h"}function ht(e){let t=document.getElementById("ttyhost-warning");if(!t){t=document.createElement("div"),t.id="ttyhost-warning",t.className="warning-banner";let n=document.querySelector(".app-header");n&&n.parentNode&&n.parentNode.insertBefore(t,n.nextSibling)}e.ttyHostVersion&&e.ttyHostCompatible===!1?(t.innerHTML="<strong>Version mismatch:</strong> mmttyhost is "+e.ttyHostVersion+", expected "+e.ttyHostExpected+". Terminals may not work correctly. Please update mmttyhost.exe or restart the service.",t.style.display="block"):t.style.display="none"}function qn(){let e=document.getElementById("system-status-content");e&&fetch("/api/health").then(t=>t.json()).then(t=>{let n=t.healthy?"status-healthy":"status-error",o=t.healthy?"Healthy":"Unhealthy",s=zn(t.uptimeSeconds||0),i="";t.ttyHostVersion!==null&&t.ttyHostVersion!==void 0&&(i='<div class="status-detail-row"><span class="detail-label">mmttyhost</span><span class="detail-value '+(t.ttyHostCompatible?"":"status-error")+'">'+t.ttyHostVersion+(t.ttyHostCompatible?"":" expected "+t.ttyHostExpected)+"</span></div>"),e.innerHTML='<div class="status-grid"><div class="status-item"><span class="status-label">Status</span><span class="status-value '+n+'">'+o+'</span></div><div class="status-item"><span class="status-label">Mode</span><span class="status-value">'+(t.mode||"")+'</span></div><div class="status-item"><span class="status-label">Sessions</span><span class="status-value">'+t.sessionCount+'</span></div><div class="status-item"><span class="status-label">Uptime</span><span class="status-value">'+s+'</span></div></div><div class="status-details"><div class="status-detail-row"><span class="detail-label">Platform</span><span class="detail-value">'+(t.platform||"")+'</span></div><div class="status-detail-row"><span class="detail-label">Process ID</span><span class="detail-value">'+(t.webProcessId||"")+"</span></div>"+i+"</div>",ht(t)}).catch(t=>{let n=t instanceof Error?t.message:String(t);e.innerHTML='<div class="status-error-msg">Failed to load system status: '+n+"</div>"})}function yt(){fetch("/api/health").then(e=>e.json()).then(e=>{ht(e),e.windowsBuildNumber!==void 0&&zt(e.windowsBuildNumber)}).catch(()=>{})}var Vn=T(()=>{"use strict";h();ft()});var $n={};ao($n,{bindSettingsAutoSave:()=>Ho,checkSystemHealth:()=>yt,closeSettings:()=>Fe,fetchSettings:()=>re,fetchSystemStatus:()=>qn,formatUptime:()=>zn,getElementChecked:()=>D,getElementValue:()=>x,openSettings:()=>Wn,populateSettingsForm:()=>Dn,populateUserDropdown:()=>Un,populateVersionInfo:()=>Fn,saveAllSettings:()=>He,setElementChecked:()=>U,setElementValue:()=>b,toggleSettings:()=>gt,updateTtyHostWarning:()=>ht});var vt=T(()=>{"use strict";Vn();ft()});A();h();L();function Gt(){let e=document.cookie.match(/mm-theme=([^;]+)/)?.[1];e&&w[e]&&document.documentElement.style.setProperty("--terminal-bg",w[e].background)}A();L();h();var Jt=()=>{},Qt=()=>{},Zt=()=>{},en=()=>{},tt=()=>{},tn=()=>{},nn=()=>{};function on(e){e.destroyTerminalForSession&&(Jt=e.destroyTerminalForSession),e.applyTerminalScaling&&(Qt=e.applyTerminalScaling),e.renderSessionList&&(Zt=e.renderSessionList),e.updateEmptyState&&(en=e.updateEmptyState),e.selectSession&&(tt=e.selectSession),e.updateMobileTitle&&(tn=e.updateMobileTitle),e.renderUpdatePanel&&(nn=e.renderUpdatePanel)}function Ie(){Q&&(Q.onclose=null,Q.close(),Ke(null));let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/state`);Ke(t),t.onopen=()=>{Ye(fe),Ge(!0),te()},t.onmessage=n=>{try{let o=JSON.parse(n.data),s=o.sessions?.sessions??[];uo(s),mo(o.update)}catch(o){let s=o instanceof Error?o.message:String(o);console.error("Error parsing state:",s)}},t.onclose=()=>{Ge(!1),te(),po()},t.onerror=n=>{console.error("State WebSocket error:",n)}}function uo(e){let t=new Set(e.map(o=>o.id));u.forEach((o,s)=>{t.has(s)||(Jt(s),q.delete(s))}),e.forEach(o=>{let s=u.get(o.id);s&&s.opened?(s.serverCols!==o.cols||s.serverRows!==o.rows)&&(s.serverCols=o.cols,s.serverRows=o.rows,s.terminal.resize(o.cols,o.rows),Qt(o.id,s)):s&&(s.serverCols=o.cols,s.serverRows=o.rows)}),Ft(e),Zt(),en();let n=m[0];if(!c&&n&&tt(n.id),c&&!m.find(o=>o.id===c)){ee(null);let o=m[0];o&&tt(o.id)}tn()}function mo(e){Ee(e),nn()}function po(){Le(We,ge,Ie,Ye,Dt,Oe)}function te(){let e=document.getElementById("connection-status");if(!e)return;let t,n;W&&z?(t="connected",n=""):!W&&!z?(t="disconnected",n="Server disconnected"):(t="reconnecting",n="Reconnecting..."),e.className=`connection-status ${t}`,e.textContent=n}A();L();h();var sn=()=>{};function rn(e){e.applyTerminalScaling&&(sn=e.applyTerminalScaling)}var fo=1e4,H=[],nt=!1;function go(e,t,n){H.length>=fo&&(console.warn("[Mux] Output queue full, dropping oldest frame"),H.shift()),H.push({sessionId:e,payload:t,compressed:n}),ho()}async function ho(){if(!nt){nt=!0;try{for(;H.length>0;){let e=H.shift();await yo(e)}}finally{nt=!1}}}async function yo(e){try{let t,n,o;if(e.compressed){let i=await jt(e.payload);t=i.cols,n=i.rows,o=i.data}else{let i=Ce(e.payload);t=i.cols,n=i.rows,o=i.data}let s=u.get(e.sessionId);if(s&&s.opened)vo(e.sessionId,s,t,n,o);else if(o.length>0){let i=new Uint8Array(4+o.length);i[0]=t&255,i[1]=t>>8&255,i[2]=n&255,i[3]=n>>8&255,i.set(o,4),C.has(e.sessionId)||C.set(e.sessionId,[]),C.get(e.sessionId).push(i)}}catch(t){console.error("Failed to process frame:",t)}}var ot=new Map;function an(e){return ot.get(e)??!1}function vo(e,t,n,o,s){if(s.length>0){let i=new TextDecoder().decode(s);i.includes("\x1B[?2004h")&&ot.set(e,!0),i.includes("\x1B[?2004l")&&ot.set(e,!1)}if(n>0&&o>0&&n<=500&&o<=500&&t.opened){let i=t.terminal.cols,r=t.terminal.rows;if(i!==n||r!==o)try{t.terminal.resize(n,o),t.serverCols=n,t.serverRows=o,sn(e,t)}catch(l){let d=l instanceof Error?l.message:String(l);console.warn("Terminal resize deferred:",d)}}s.length>0&&t.terminal.write(s)}function Ae(){S&&(S.onclose=null,S.close(),Je(null));let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/mux`);t.binaryType="arraybuffer",Je(t),t.onopen=()=>{let n=Ve&&u.size>0;Qe(fe),Ze(!0),Wt(!0),te(),n?(console.log(`[Mux] Reconnected - refreshing ${u.size} terminals`),C.clear(),H.length=0,u.forEach(o=>{o.opened&&o.terminal.clear(),o.serverCols=0,o.serverRows=0})):console.log("[Mux] Connected (first connection)")},t.onmessage=n=>{if(!(n.data instanceof ArrayBuffer))return;let o=new Uint8Array(n.data);if(o.length<E)return;let s=o[0],i=So(o,1),r=o.slice(E);if(s===kt){console.log("[Resync] Clearing terminals for buffer refresh"),u.forEach(l=>{l.opened&&l.terminal.clear()}),C.clear(),H.length=0;return}(s===Mt||s===De)&&r.length>=4&&go(i,r.slice(),s===De)},t.onclose=()=>{Ze(!1),te(),bo()},t.onerror=n=>{console.error("Mux WebSocket error:",n)}}function Me(e,t){if(!S||S.readyState!==WebSocket.OPEN)return;let n=new TextEncoder().encode(t),o=new Uint8Array(E+n.length);o[0]=Bt,st(o,1,e),o.set(n,E),S.send(o)}function ln(e,t,n){if(!S||S.readyState!==WebSocket.OPEN)return;let o=new Uint8Array(E+4);o[0]=Rt,st(o,1,e),o[E]=t&255,o[E+1]=t>>8&255,o[E+2]=n&255,o[E+3]=n>>8&255,S.send(o);let s=u.get(e);s&&(s.serverCols=t,s.serverRows=n)}function cn(e){if(!S||S.readyState!==WebSocket.OPEN)return;let t=new Uint8Array(E);t[0]=Nt,st(t,1,e),S.send(t)}function st(e,t,n){for(let o=0;o<8;o++)e[t+o]=o<n.length?n.charCodeAt(o):0}function So(e,t){let n=[];for(let o=0;o<8;o++){let s=e[t+o];s!==void 0&&s!==0&&n.push(String.fromCharCode(s))}return n.join("")}function bo(){Le(qe,ge,Ae,Qe,Ot,ze)}A();h();L();A();h();var it=()=>{};function dn(e){e.sendResize&&(it=e.sendResize)}function F(e){let t=u.get(e);if(!t)return;if(!t.opened){(Z??Promise.resolve()).then(()=>{F(e)});return}let n=t.container.querySelector(".xterm");n&&(n.style.zoom="",n.style.transform="",t.container.classList.remove("scaled"));let o=t.container.classList.contains("hidden");o&&t.container.classList.remove("hidden");let s=a.terminalsArea?.getBoundingClientRect();if(!s||s.width<100||s.height<100){o&&t.container.classList.add("hidden");return}let i=t.container.querySelector(".xterm-screen"),r=t.terminal.cols,l=t.terminal.rows,d=null,f=null;if(i&&r>0&&l>0&&(d=i.offsetWidth/r,f=i.offsetHeight/l),!d||!f||d<1||f<1){requestAnimationFrame(()=>{try{let It=t.fitAddon.proposeDimensions();It?.cols&&It?.rows&&(t.fitAddon.fit(),it(e,t.terminal))}catch{}o&&t.container.classList.add("hidden")});return}let y=s.width-O,v=s.height-O,me=Math.floor(y/d),pe=Math.floor(v/f);me=Math.max(he,Math.min(me,ve)),pe=Math.max(ye,Math.min(pe,Se)),requestAnimationFrame(()=>{try{(t.terminal.cols!==me||t.terminal.rows!==pe)&&(t.terminal.resize(me,pe),it(e,t.terminal))}catch{}o&&t.container.classList.add("hidden")})}function V(e,t){let n=t.container,o=n.querySelector(".xterm");o&&requestAnimationFrame(()=>{let s=n.clientWidth-8,i=n.clientHeight-8,r=o.offsetWidth,l=o.offsetHeight,d=s/r,f=i/l,y=Math.min(d,f,1);y<.99?(o.style.zoom=y,o.style.transform="",n.classList.add("scaled")):(o.style.zoom="",o.style.transform="",n.classList.remove("scaled"))})}function ne(){u.forEach((e,t)=>{e.opened&&V(t,e)})}function un(){window.addEventListener("resize",ne)}function mn(){if(!window.visualViewport||!a.terminalsArea)return;let e=0,t=()=>{let n=window.visualViewport.height;if(Math.abs(n-e)<1)return;e=n,document.documentElement.style.setProperty("--visual-vh",n+"px");let o=document.querySelector(".mobile-header"),s=0;o&&window.getComputedStyle(o).display!=="none"&&(s=o.offsetHeight);let i=Math.floor((n-s)*.99);a.terminalsArea.style.height=i+"px"};window.visualViewport.addEventListener("resize",t),t()}h();var xo=40*1024,Eo=new Set([".png",".jpg",".jpeg",".gif",".bmp",".webp",".svg",".ico",".tiff",".tif",".heic",".heif",".avif"]),wo=new Set([".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".odt",".ods",".odp",".rtf",".exe",".dll",".so",".dylib",".app",".msi",".deb",".rpm",".dmg",".iso",".zip",".tar",".gz",".7z",".rar",".bz2",".xz",".tgz",".bin",".dat",".db",".sqlite",".sqlite3",".mp3",".mp4",".wav",".avi",".mov",".mkv",".flac",".ogg",".webm"]),oe=()=>{};function at(e){let t=e.lastIndexOf(".");return t>=0?e.slice(t).toLowerCase():""}function To(e){return Eo.has(at(e))}function Co(e){return wo.has(at(e))}function rt(e){let t=document.querySelector(".drop-toast");t&&t.remove();let n=document.createElement("div");n.className="drop-toast error",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("hiding"),setTimeout(()=>n.remove(),300)},3e3)}async function Lo(e){return new Promise((t,n)=>{let o=new FileReader;o.onload=()=>t(o.result),o.onerror=()=>n(o.error),o.readAsText(e)})}function Be(e){return e.replace(/\r\n/g,`
`).replace(/\r(?!\n)/g,`
`).replace(/\x1b\[[0-9;]*[A-Za-z]/g,"").replace(/\x1b\][^\x07]*\x07/g,"").replace(/\x1b[PX^_][^\x1b]*\x1b\\/g,"").replace(/\x1b[\x20-\x2F]*[\x30-\x7E]/g,"")}function pn(e){e.pasteToTerminal&&(oe=e.pasteToTerminal)}async function fn(e,t){let n=new FormData;n.append("file",t);try{let o=await fetch(`/api/sessions/${e}/upload`,{method:"POST",body:n});return o.ok?(await o.json()).path:(console.error("File upload failed:",o.status),null)}catch(o){return console.error("File upload error:",o),null}}async function Io(e){if(!c||e.length===0)return;let t=[];for(let n of Array.from(e)){if(To(n.name)){let o=await fn(c,n);o&&t.push(o);continue}if(Co(n.name)){let o=at(n.name);rt(`Cannot paste ${o} files`);continue}if(n.size>xo){rt(`File too large (max 40KB): ${n.name}`);continue}try{let o=await Lo(n),s=Be(o);oe(c,s,!1)}catch(o){console.error(`[FileDrop] Failed to read file: ${n.name}`,o),rt(`Failed to read: ${n.name}`)}}if(t.length>0){let n=Be(t.join(" "));oe(c,n,!0)}}function gn(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over")}),e.addEventListener("dragend",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over");let n=t.dataTransfer?.files;n&&n.length>0&&await Io(n)})}async function Re(e){try{let t=await navigator.clipboard.read();for(let n of t){let o=n.types.find(s=>s.startsWith("image/"));if(o){let s=await n.getType(o),i=new Date().toISOString().replace(/[:.]/g,"-"),r=new File([s],`clipboard_${i}.jpg`,{type:o}),l=await fn(e,r);if(l){oe(e,Be(l),!0);return}}}}catch{}try{let t=await navigator.clipboard.readText();if(t){let n=Be(t);oe(e,n)}}catch{}}h();var se=new Map,ct=!1,N=null,R=null,$=null;function yn(e,t){try{let n=new SearchAddon.SearchAddon;t.loadAddon(n),se.set(e,{addon:n,currentIndex:0,totalMatches:0})}catch{}}function vn(e){se.delete(e)}function Sn(){$||($=document.getElementById("terminal-search"),N=document.getElementById("search-input"),R=document.getElementById("search-results")),$&&N&&($.classList.remove("hidden"),ct=!0,N.focus(),N.select())}function ke(){if($&&($.classList.add("hidden"),ct=!1),c){let e=se.get(c);e?.addon&&e.addon.clearDecorations()}if(c){let e=u.get(c);e&&e.terminal.focus()}}function bn(){return ct}function lt(){if(!c||!N)return;let e=N.value;if(!e)return;let t=se.get(c);if(!t?.addon)return;let n=t.addon.findNext(e,{incremental:!1});xn(n)}function hn(){if(!c||!N)return;let e=N.value;if(!e)return;let t=se.get(c);if(!t?.addon)return;let n=t.addon.findPrevious(e);xn(n)}function xn(e){R&&(e?(R.textContent="Found",R.style.color=""):(R.textContent="No matches",R.style.color="var(--accent-red)"))}function En(){let e=document.getElementById("search-input"),t=document.getElementById("search-prev"),n=document.getElementById("search-next"),o=document.getElementById("search-close");e&&(e.addEventListener("input",()=>{c&&e.value?lt():R&&(R.textContent="0/0",R.style.color="")}),e.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),s.shiftKey?hn():lt()):s.key==="Escape"&&(s.preventDefault(),ke())})),t&&t.addEventListener("click",hn),n&&n.addEventListener("click",lt),o&&o.addEventListener("click",ke)}var Ne=()=>{},wn=()=>{},Ao=()=>{},ie=new Map;function Mo(e,t){if(m.find(i=>i.id===e)?.manuallyNamed)return;let o=ie.get(e);o&&window.clearTimeout(o);let s=window.setTimeout(()=>{ie.delete(e),fetch(`/api/sessions/${e}/name?auto=true`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).catch(()=>{})},500);ie.set(e,s)}function Tn(e){e.sendInput&&(Ne=e.sendInput),e.showBellNotification&&(wn=e.showBellNotification),e.requestBufferRefresh&&(Ao=e.requestBufferRefresh)}function Bo(){let e=window.innerWidth<=Ht,t=p?.fontSize??14,n=e?Math.max(t-2,10):t,o=p?.theme??"dark",s=p?.fontFamily??"Cascadia Code",i={cursorBlink:p?.cursorBlink??!0,cursorStyle:p?.cursorStyle??"bar",cursorInactiveStyle:"none",fontFamily:`'${s}', ${Y}`,fontSize:n,letterSpacing:0,lineHeight:1,scrollback:p?.scrollbackLines??1e4,minimumContrastRatio:p?.minimumContrastRatio??1,smoothScrollDuration:p?.smoothScrolling?150:0,allowProposedApi:!0,customGlyphs:!0,rescaleOverlappingGlyphs:!0,theme:w[o]??w.dark},r=/Windows|Win32|Win64/i.test(navigator.userAgent);return xe!==null?i.windowsPty={backend:"conpty",buildNumber:xe}:r&&(i.windowsPty={backend:"conpty",buildNumber:19041}),i}function Cn(e,t){let n=u.get(e);if(n)return n;let o=document.createElement("div");o.className="terminal-container hidden",o.id="terminal-"+e,a.terminalsArea?.appendChild(o),gn(o);let s=new Terminal(Bo()),i=new FitAddon.FitAddon;s.loadAddon(i);let r=t&&t.cols>0?t.cols:0,l=t&&t.rows>0?t.rows:0,d={terminal:s,fitAddon:i,container:o,serverCols:r,serverRows:l,opened:!1};return u.set(e,d),(Z??Promise.resolve()).then(()=>{if(u.has(e)){if(s.open(o),d.opened=!0,p?.useWebGL!==!1)try{let f=new WebglAddon.WebglAddon;f.onContextLost(()=>{f.dispose()}),s.loadAddon(f)}catch{}try{let f=new WebLinksAddon.WebLinksAddon((y,v)=>{(v.startsWith("http://")||v.startsWith("https://"))&&window.open(v,"_blank","noopener,noreferrer")});s.loadAddon(f)}catch{}yn(e,s),Ro(e,d),requestAnimationFrame(()=>{u.has(e)&&(F(e),No(e,s,o))})}}),d}function Ro(e,t){let n=C.get(e);n&&n.length>0&&(n.forEach(o=>{ko(e,t,o)}),C.delete(e))}function ko(e,t,n){let o=Ce(n);if(o.valid&&t.opened){let s=t.terminal.cols,i=t.terminal.rows;if(s!==o.cols||i!==o.rows)try{t.terminal.resize(o.cols,o.rows),t.serverCols=o.cols,t.serverRows=o.rows,V(e,t)}catch{}}o.data.length>0&&t.terminal.write(o.data)}function No(e,t,n){t.onData(r=>{Ne(e,r)}),t.onBell(()=>{wn(e)}),t.onSelectionChange(()=>{p?.copyOnSelect&&t.hasSelection()&&navigator.clipboard.writeText(t.getSelection()).catch(()=>{})}),t.onTitleChange(r=>{r&&r.trim()&&Mo(e,r.trim())}),t.attachCustomKeyEventHandler(r=>{if(r.type!=="keydown")return!0;if(r.ctrlKey&&!r.shiftKey&&!r.altKey&&!r.metaKey&&r.key==="Enter")return Ne(e,`
`),!1;if($t(p?.clipboardShortcuts??"auto")==="windows"){if(r.ctrlKey&&!r.shiftKey&&r.key==="c")return t.hasSelection()?(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection(),!1):!0;if(r.ctrlKey&&!r.shiftKey&&r.key==="v")return Re(e),!1}else{if(r.ctrlKey&&r.shiftKey&&(r.key==="C"||r.key==="c"))return t.hasSelection()&&(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection()),!1;if(r.ctrlKey&&r.shiftKey&&(r.key==="V"||r.key==="v"))return Re(e),!1}return(r.ctrlKey||r.metaKey)&&r.key==="f"?(Sn(),!1):r.key==="Escape"&&bn()?(ke(),!1):!0});let o=r=>{r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation()};n.addEventListener("paste",o,!0);let s=r=>{(!p||p.rightClickPaste!==!1)&&(r.preventDefault(),Re(e))};n.addEventListener("contextmenu",s);let i=u.get(e);i&&(i.contextMenuHandler=s,i.pasteHandler=o)}function dt(e){let t=u.get(e);if(!t)return;t.contextMenuHandler&&t.container.removeEventListener("contextmenu",t.contextMenuHandler),t.pasteHandler&&t.container.removeEventListener("paste",t.pasteHandler,!0),vn(e);let n=ie.get(e);n&&(clearTimeout(n),ie.delete(e)),t.terminal.dispose(),t.container.remove(),u.delete(e),C.delete(e)}function Ln(e,t,n=!1){let o=u.get(e);if(!o)return;let s=an(e),i=o.terminal.modes?.bracketedPasteMode??!1;if(s||i){let d="\x1B[200~"+(n?'"'+t+'"':t)+"\x1B[201~";Ne(e,d)}else o.terminal.paste(t)}function In(){let e=document.fonts.ready.then(()=>{let t=document.createElement("span");return t.style.fontFamily=Y,t.style.position="absolute",t.style.left="-9999px",t.textContent="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",document.body.appendChild(t),new Promise(n=>{requestAnimationFrame(()=>{t.remove(),n()})})});return Te(e),e}h();var I=null;function An(e){I=e}function ut(e){let t=e.terminalTitle||e.shellType;return e.name?{primary:e.name,secondary:t}:{primary:t,secondary:null}}function mt(e){return ut(e).primary}function X(){if(!a.sessionList)return;a.sessionList.innerHTML="",m.forEach(t=>{let n=P.has(t.id),o=document.createElement("div");o.className="session-item"+(t.id===c?" active":"")+(n?" pending":""),o.dataset.sessionId=t.id,n||o.addEventListener("click",()=>{I&&(I.onSelect(t.id),I.onCloseSidebar())});let s=document.createElement("div");if(s.className="session-info",n){let d=document.createElement("span");d.className="session-spinner",s.appendChild(d)}let i=ut(t),r=document.createElement("span");if(r.className="session-title",r.textContent=i.primary,s.appendChild(r),i.secondary){o.classList.add("two-line");let d=document.createElement("span");d.className="session-subtitle",d.textContent=i.secondary,s.appendChild(d)}let l=document.createElement("div");if(l.className="session-actions",!n){let d=document.createElement("button");d.className="session-resize",d.innerHTML="\u2922",d.title="Fit to screen",d.addEventListener("click",v=>{v.stopPropagation(),I&&I.onResize(t.id)});let f=document.createElement("button");f.className="session-rename",f.innerHTML="\u270F\uFE0F",f.title="Rename session",f.addEventListener("click",v=>{v.stopPropagation(),I&&I.onRename(t.id)});let y=document.createElement("button");y.className="session-close",y.innerHTML="&times;",y.title="Close session",y.addEventListener("click",v=>{v.stopPropagation(),I&&I.onDelete(t.id)}),l.appendChild(d),l.appendChild(f),l.appendChild(y)}o.appendChild(s),o.appendChild(l),a.sessionList.appendChild(o)});let e=m.filter(t=>!P.has(t.id)).length;a.sessionCount&&(a.sessionCount.textContent=String(e))}function Pe(){a.emptyState&&(m.length===0?(a.emptyState.classList.remove("hidden"),a.settingsView&&a.settingsView.classList.add("hidden")):J||a.emptyState.classList.add("hidden"))}function j(){if(!a.mobileTitle)return;let e=m.find(t=>t.id===c);a.mobileTitle.textContent=e?mt(e):"MidTerm",a.topbarActions&&(e?a.topbarActions.classList.remove("no-terminal"):a.topbarActions.classList.add("no-terminal")),Po(e)}function Po(e){if(!a.titleBarCustom||!a.titleBarTerminal||!a.titleBarSeparator)return;if(!e){a.titleBarCustom.textContent="MidTerm",a.titleBarTerminal.textContent="",a.titleBarSeparator.style.display="none";return}let t=ut(e);e.name?(a.titleBarCustom.textContent=t.primary,a.titleBarTerminal.textContent=t.secondary||"",a.titleBarSeparator.style.display=t.secondary?"":"none"):(a.titleBarCustom.textContent=t.primary,a.titleBarTerminal.textContent="",a.titleBarSeparator.style.display="none")}h();L();var pt="mm-sidebar-collapsed",Mn="mm-sidebar-width",_o=768,Bn=180,Rn=400;function kn(){je(!be),a.app&&a.app.classList.toggle("sidebar-open",be)}function _e(){je(!1),a.app&&a.app.classList.remove("sidebar-open")}function Nn(){we(!0),a.app&&a.app.classList.add("sidebar-collapsed"),_(pt,"true"),j(),requestAnimationFrame(ne)}function Pn(){we(!1),a.app&&a.app.classList.remove("sidebar-collapsed"),_(pt,"false"),requestAnimationFrame(ne)}function _n(){et(pt)==="true"&&window.innerWidth>_o&&(we(!0),a.app&&a.app.classList.add("sidebar-collapsed"));let e=et(Mn);if(e){let t=parseInt(e,10);if(t>=Bn&&t<=Rn){let n=document.getElementById("sidebar");n&&(n.style.width=t+"px")}}}function Hn(){let e=document.getElementById("sidebar-resize-grip"),t=document.getElementById("sidebar");if(!e||!t)return;let n=!1,o=0,s=0;e.addEventListener("mousedown",i=>{n=!0,o=i.clientX,s=t.offsetWidth,e.classList.add("active"),document.body.style.cursor="ew-resize",document.body.style.userSelect="none",i.preventDefault()}),document.addEventListener("mousemove",i=>{if(!n)return;let r=i.clientX-o,l=Math.max(Bn,Math.min(Rn,s+r));t.style.width=l+"px",ne()}),document.addEventListener("mouseup",()=>{if(!n)return;n=!1,e.classList.remove("active"),document.body.style.cursor="",document.body.style.userSelect="";let i=t.offsetWidth;_(Mn,String(i))})}vt();h();async function ae(){try{let e=await fetch("/api/auth/status");if(e.status===401){window.location.href="/login.html";return}let t=await e.json();Ut(t),Xn(),jn()}catch(e){console.error("Auth status error:",e)}}function Xn(){let e=document.getElementById("security-warning");e&&(B&&B.authenticationEnabled&&!B.passwordSet?e.classList.remove("hidden"):e.classList.add("hidden"))}function jn(){let e=document.getElementById("password-status-text");if(e){if(!B){e.textContent="Checking...",e.className="";return}B.passwordSet?(e.textContent="Password is set",e.className="status-set"):(e.textContent="No password set",e.className="status-missing")}}function St(){let e=document.getElementById("security-warning");e&&e.classList.add("hidden")}h();L();var le=!1;function bt(e){let t=document.getElementById("password-modal"),n=document.getElementById("password-modal-title"),o=document.getElementById("current-password-group"),s=document.getElementById("password-error");if(!t)return;le=B?.passwordSet??!1,n&&(n.textContent=le?"Change Password":"Set Password"),o&&(o.style.display=le?"block":"none"),s&&(s.classList.add("hidden"),s.textContent="");let i=document.getElementById("password-form");i&&i.reset(),t.classList.remove("hidden");let r=le?"current-password":"new-password",l=document.getElementById(r);l&&l.focus()}function ce(){let e=document.getElementById("password-modal");e&&e.classList.add("hidden")}function Kn(e){e.preventDefault();let t=document.getElementById("current-password"),n=document.getElementById("new-password"),o=document.getElementById("confirm-password"),s=document.getElementById("btn-save-password"),i=n?.value??"",r=o?.value??"";if(!i){K("New password is required");return}if(i!==r){K("Passwords do not match");return}if(i.length<4){K("Password must be at least 4 characters");return}let l={currentPassword:le&&t?t.value:null,newPassword:i};s&&(s.disabled=!0,s.textContent="Saving..."),fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).then(d=>d.json().then(f=>({ok:d.ok,data:f}))).then(d=>{s&&(s.disabled=!1,s.textContent="Save"),d.ok&&d.data.success?(ce(),ae()):K(d.data.error||"Failed to change password")}).catch(()=>{s&&(s.disabled=!1,s.textContent="Save"),K("Connection error")})}function K(e){let t=document.getElementById("password-error");t&&(t.textContent=e,t.classList.remove("hidden"))}function xt(){g("btn-set-password-warning",()=>{bt(!0)}),g("btn-dismiss-warning",St),g("btn-change-password",()=>{bt(!1)}),g("btn-close-password",ce),g("btn-cancel-password",ce);let e=document.querySelector("#password-modal .modal-backdrop");e&&e.addEventListener("click",ce);let t=document.getElementById("password-form");t&&t.addEventListener("submit",Kn)}h();var Yn=30,Gn=2e3,Uo=3e3;function Et(){let e=document.getElementById("update-panel");if(!e)return;if(!M||!M.available){e.classList.add("hidden");return}e.classList.remove("hidden");let t=e.querySelector(".update-current"),n=e.querySelector(".update-latest"),o=e.querySelector(".update-note"),s=e.querySelector(".update-header");t&&(t.textContent=M.currentVersion),n&&(n.textContent=M.latestVersion),M.sessionsPreserved?(s&&(s.textContent="Quick Update"),o&&(o.textContent="Sessions will stay alive",o.classList.add("update-note-safe"),o.classList.remove("update-note-warning"))):(s&&(s.textContent="Update Available"),o&&(o.textContent="Save your work - sessions will restart",o.classList.add("update-note-warning"),o.classList.remove("update-note-safe")))}function wt(){if(!M||!M.available)return;let t=document.getElementById("update-panel")?.querySelector(".update-btn");t&&(t.disabled=!0,t.textContent="Updating..."),fetch("/api/update/apply",{method:"POST"}).then(n=>{n.ok?(t&&(t.textContent="Restarting..."),Jn()):(t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update failed"))}).catch(n=>{t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update error:",n)})}function Jn(){let e=0;function t(){e++,fetch("/api/version",{cache:"no-store"}).then(n=>{n.ok?location.reload():e<Yn&&setTimeout(t,Gn)}).catch(()=>{e<Yn&&setTimeout(t,Gn)})}setTimeout(t,Uo)}function Qn(){let e=document.getElementById("btn-check-updates"),t=document.getElementById("update-status"),n=document.getElementById("update-warning");e&&(e.disabled=!0,e.textContent="Checking..."),fetch("/api/update/check").then(o=>o.json()).then(o=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),Ee(o),Et(),Do(o);let s=document.getElementById("btn-apply-update");t&&(t.classList.remove("hidden"),o&&o.available?(t.className="update-status update-status-available",t.textContent="Update available: v"+o.latestVersion,s&&s.classList.remove("hidden"),n&&(n.classList.remove("hidden"),o.sessionsPreserved?(n.textContent="Sessions will stay alive",n.className="update-warning update-warning-safe"):(n.textContent="Save your work - sessions will restart",n.className="update-warning update-warning-warn"))):(t.className="update-status update-status-current",t.textContent="You are running the latest version",s&&s.classList.add("hidden"),n&&n.classList.add("hidden")))}).catch(o=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),t&&(t.classList.remove("hidden"),t.className="update-status update-status-error",t.textContent="Failed to check for updates"),n&&n.classList.add("hidden"),console.error("Update check error:",o)})}function Do(e){let t=document.getElementById("local-update-section");if(!e?.environment){t&&t.remove();return}if(!t){t=Oo();let r=document.getElementById("update-warning");r&&r.after(t)}let n=t.querySelector(".local-update-status"),o=t.querySelector(".btn-apply-local"),s=t.querySelector(".local-update-warning"),i=e.localUpdate;n&&(i?.available?(n.textContent=`Local build available: v${i.version}`,n.className="local-update-status local-update-available",o&&(o.classList.remove("hidden"),o.disabled=!1,o.textContent="Apply Local Build"),s&&(s.classList.remove("hidden"),i.sessionsPreserved?(s.textContent="Sessions will stay alive",s.className="local-update-warning local-warning-safe"):(s.textContent="Save your work - sessions will restart",s.className="local-update-warning local-warning-warn"))):(n.textContent="No local build available",n.className="local-update-status",o&&o.classList.add("hidden"),s&&s.classList.add("hidden")))}function Oo(){let e=document.createElement("div");e.id="local-update-section",e.className="local-update-section",e.innerHTML=`
    <div class="local-update-header">Local Development</div>
    <div class="local-update-status"></div>
    <button class="btn-dev btn-apply-local hidden">Apply Local Build</button>
    <div class="local-update-warning hidden"></div>
  `;let t=e.querySelector(".btn-apply-local");return t&&t.addEventListener("click",Wo),e}function Wo(){let t=document.getElementById("local-update-section")?.querySelector(".btn-apply-local");t&&(t.disabled=!0,t.textContent="Applying..."),fetch("/api/update/apply?source=local",{method:"POST"}).then(n=>{n.ok?(t&&(t.textContent="Restarting..."),Jn()):(t&&(t.disabled=!1,t.textContent="Apply Local Build"),console.error("Local update failed"))}).catch(n=>{t&&(t.disabled=!1,t.textContent="Apply Local Build"),console.error("Local update error:",n)})}function Zn(){fetch("/api/update/result").then(e=>e.json()).then(e=>{e.found&&fetch("/api/update/result",{method:"DELETE"}).catch(()=>{})}).catch(()=>{})}L();var zo="https://api.github.com/repos/AiTlbx/MidTerm/releases",eo=30,qo="https://github.com/AiTlbx/MidTerm/releases",Tt=1,de=!0,ue=!1;function to(){let e=document.getElementById("changelog-modal"),t=document.getElementById("changelog-body");Tt=1,de=!0,ue=!1,e&&e.classList.remove("hidden"),t&&(t.innerHTML='<div class="changelog-loading">Loading changelog...</div>'),no(!0)}function no(e){if(ue)return;ue=!0;let t=document.getElementById("changelog-body");if(!t)return;let n=`${zo}?per_page=${eo}&page=${Tt}`;fetch(n).then(o=>o.json()).then(o=>{if(ue=!1,!o||!Array.isArray(o)){e&&(t.innerHTML="<p>No releases found.</p>"),de=!1;return}if(de=o.length===eo,o.length===0){e&&(t.innerHTML="<p>No releases found.</p>"),de=!1;return}let s="";if(o.forEach(i=>{let r=i.tag_name||"Unknown",l=i.published_at?new Date(i.published_at).toLocaleDateString():"",d=i.body||"No release notes.",f=Vo(d,r);s+='<div class="changelog-release">',s+='<div class="changelog-version">'+k(r)+"</div>",l&&(s+='<div class="changelog-date">'+k(l)+"</div>"),s+='<div class="changelog-notes">'+Xo(f)+"</div>",s+="</div>"}),e)t.innerHTML=s;else{let i=t.querySelector(".changelog-load-more");i&&i.remove(),t.insertAdjacentHTML("beforeend",s)}if(de){let i=document.createElement("button");i.className="changelog-load-more",i.textContent="Load older releases",i.addEventListener("click",()=>{Tt++,i.textContent="Loading...",i.disabled=!0,no(!1)}),t.appendChild(i)}}).catch(o=>{ue=!1,e&&(t.innerHTML='<p class="changelog-error">Failed to load changelog. <a href="'+qo+'" target="_blank">View on GitHub</a></p>'),console.error("Changelog error:",o)})}function Ct(){let e=document.getElementById("changelog-modal");e&&e.classList.add("hidden")}function Vo(e,t){let n=t.replace(/^v/,""),o=new RegExp(`^v?${$o(n)}:\\s*`,"i");return e.replace(o,"").trim()}function $o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Xo(e){return k(e).replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n{3,}/g,`

`).replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")}h();A();L();window.mmDebug={get terminals(){return u},get activeId(){return c},get settings(){return p}};Gt();document.addEventListener("DOMContentLoaded",jo);function jo(){qt(),_n(),Hn();let e=In();Te(e),Ko(),Ie(),Ae(),yt(),ts(),xt(),En(),un(),mn(),Zo(),es(),re(),ae(),Zn(),Jo(),Yo()}function Ko(){on({destroyTerminalForSession:dt,applyTerminalScaling:V,renderSessionList:X,updateEmptyState:Pe,selectSession:Ue,updateMobileTitle:j,renderUpdatePanel:Et}),rn({applyTerminalScaling:V}),Tn({sendInput:Me,showBellNotification:Qo,requestBufferRefresh:cn}),pn({sendInput:Me,pasteToTerminal:Ln}),dn({sendResize:(e,t)=>{ln(e,t.cols,t.rows)}}),An({onSelect:Ue,onDelete:so,onRename:Go,onResize:F,onCloseSidebar:_e})}function Yo(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(W||Ie(),z||Ae())})}function Lt(){let e=a.terminalsArea?.getBoundingClientRect(),t=p?.defaultCols??120,n=p?.defaultRows??30;if(e&&e.width>100&&e.height>100){let i=p?.fontSize??14,r=i*Pt,l=i*_t,d=e.width-O,f=e.height-O,y=Math.floor(d/r),v=Math.floor(f/l);y>he&&v>ye&&(t=Math.min(y,ve),n=Math.min(v,Se))}let o="pending-"+crypto.randomUUID(),s={id:o,name:null,terminalTitle:null,shellType:"Loading...",cols:t,rows:n};m.push(s),P.add(o),X(),_e(),fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Cols:t,Rows:n})}).then(i=>i.json()).then(i=>{P.delete(o);let r=m.findIndex(l=>l.id===o);r>=0&&m.splice(r,1),q.add(i.id),Ue(i.id)}).catch(i=>{P.delete(o);let r=m.findIndex(l=>l.id===o);r>=0&&(m.splice(r,1),X(),Pe()),console.error("Error creating session:",i)})}function Ue(e){Fe(),u.forEach(s=>{s.container.classList.add("hidden")}),ee(e);let t=m.find(s=>s.id===e),n=Cn(e,t),o=q.has(e);n.container.classList.remove("hidden"),requestAnimationFrame(()=>{n.terminal.focus(),o&&q.delete(e)}),X(),j(),a.emptyState?.classList.add("hidden")}function so(e){dt(e);let t=m.findIndex(n=>n.id===e);if(t>=0&&m.splice(t,1),c===e){ee(null);let n=m[0];n&&Ue(n.id)}X(),Pe(),j(),fetch("/api/sessions/"+e,{method:"DELETE"}).catch(n=>{console.error("Error deleting session:",n)})}function io(e,t){let n=m.find(i=>i.id===e);if(!n)return;let o=(t||"").trim(),s=o===""||o===n.shellType?null:o;fetch("/api/sessions/"+e+"/name",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})}).then(()=>{n.manuallyNamed=!0}).catch(i=>{console.error("Error renaming session:",i)})}function Go(e){let t=a.sessionList?.querySelector(`[data-session-id="${e}"]`);if(!t)return;let n=t.querySelector(".session-title");if(!n)return;let o=m.find(l=>l.id===e),s=o?o.name||o.shellType:"",i=document.createElement("input");i.type="text",i.className="session-rename-input",i.value=s;function r(){io(e,i.value),i.replaceWith(n)}i.addEventListener("blur",r),i.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),i.blur()):l.key==="Escape"&&(l.preventDefault(),i.replaceWith(n))}),n.replaceWith(i),i.focus(),i.select()}function oo(e){let t=m.find(s=>s.id===e);if(!t)return;let n=t.name||t.shellType,o=prompt("Rename terminal:",n);o!==null&&io(e,o)}function Jo(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().catch(()=>{})}function Qo(e){if(!p)return;let t=p.bellStyle||"notification",n=m.find(s=>s.id===e),o=n?mt(n):"Terminal";if((t==="notification"||t==="both")&&Notification.permission==="granted"&&document.hidden&&new Notification("Bell: "+o,{body:"Terminal bell triggered",icon:"/favicon.ico"}),t==="visual"||t==="both"){let s=u.get(e);s&&(s.container.classList.add("bell-flash"),setTimeout(()=>{s.container.classList.remove("bell-flash")},200))}}function Zo(){fetch("/api/version").then(e=>e.text()).then(e=>{let t=e.split(/[+-]/)[0]??e,n=document.getElementById("app-version");n&&(n.textContent="v"+t)}).catch(()=>{})}function es(){fetch("/api/networks").then(e=>e.json()).then(e=>{let t=document.getElementById("network-list");if(!t)return;let n=location.protocol,o=location.port;t.innerHTML=e.map(s=>{let i=n+"//"+s.ip+":"+o;return'<div class="network-item"><span class="network-name" title="'+k(s.name)+'">'+k(s.name)+'</span><a class="network-url" href="'+i+'" target="_blank">'+k(s.ip)+":"+o+"</a></div>"}).join("")}).catch(()=>{})}function ts(){g("btn-new-session",Lt),g("btn-new-session-mobile",Lt),g("btn-create-terminal",Lt),g("btn-hamburger",kn),g("btn-collapse-sidebar",Nn),g("btn-expand-sidebar",Pn),a.sidebarOverlay&&a.sidebarOverlay.addEventListener("click",_e),g("btn-ctrlc-mobile",()=>{c&&Me(c,"")}),g("btn-resize-mobile",()=>{c&&F(c)}),g("btn-resize-titlebar",()=>{c&&F(c)}),g("btn-rename-mobile",()=>{c&&oo(c)}),g("btn-rename-titlebar",()=>{c&&oo(c)}),g("btn-close-mobile",()=>{c&&so(c)}),a.settingsBtn&&a.settingsBtn.addEventListener("click",gt),g("update-btn",wt),g("btn-check-updates",Qn),g("btn-apply-update",wt),g("btn-show-changelog",to),g("btn-close-changelog",Ct);let e=document.querySelector("#changelog-modal .modal-backdrop");e&&e.addEventListener("click",Ct),Promise.resolve().then(()=>(vt(),$n)).then(t=>{t.bindSettingsAutoSave()})}})();
