"use strict";(()=>{var Ps=Object.defineProperty;var M=(e,t)=>()=>(e&&(t=e(e=0)),t);var Ns=(e,t)=>{for(var n in t)Ps(e,n,{get:t[n],enumerable:!0})};function Xe(e){return`<span class="icon">${_s[e]}</span>`}var kn,T,G,Q,ye,Rn,Bn,ee,$e,ze,qe,Ve,Se,Pn,_s,k=M(()=>{"use strict";kn="5.10.4.1",T={dark:{background:"#06060E",foreground:"#DCDCF5",cursor:"#DCDCF5",cursorAccent:"#06060E",selectionBackground:"#283457"},light:{background:"#D5D6DB",foreground:"#343B58",cursor:"#343B58",cursorAccent:"#D5D6DB",selectionBackground:"#9FA0A5"},solarizedDark:{background:"#002B36",foreground:"#839496",cursor:"#839496",cursorAccent:"#002B36",selectionBackground:"#073642"},solarizedLight:{background:"#FDF6E3",foreground:"#657B83",cursor:"#657B83",cursorAccent:"#FDF6E3",selectionBackground:"#EEE8D5"}},G=1e3,Q=3e4,ye="'Cascadia Code', 'Cascadia Mono', Consolas, 'Courier New', monospace",Rn=.6,Bn=1.2,ee=8,$e=10,ze=5,qe=300,Ve=100,Se=500,Pn=768,_s={collapse:"\uE913",expand:"\uE910",settings:"\uE991",new:"\uEA81",resize:"\uE989",rename:"\uE91F",close:"\uE909",menu:"\uE919",update:"\uE91B",searchPrev:"\uE913",searchNext:"\uE910",save:"\uE90F",interrupt:"\uE9B5",terminal:"\uEA81",warning:"\uEA07",tabGeneral:"\uEA0C",tabAppearance:"\uE90D",tabBehavior:"\uE993",tabSecurity:"\uE908",tabDiagnostics:"\uE9CE"}});function Nn(e){p=e}function xe(e){c=e}function Te(e){f=e}function Ge(e){O=e}function _n(e){F=e}function Ct(e){_=e}function It(e){je=e}function Ye(e){Ds=e}function At(e){be=e}function Dn(e){Et=e}function Mt(e){xt=e}function kt(e){te=e}function Rt(e){y=e}function Hn(e){Tt=e}function Bt(e){wt=e}function Pt(e){ne=e}function On(e){Lt=e}function Je(e){Ee=e}function Fn(e){Ke=e}function Un(){a.sessionList=document.getElementById("session-list"),a.sessionCount=document.getElementById("session-count"),a.terminalsArea=document.querySelector(".terminals-area"),a.emptyState=document.getElementById("empty-state"),a.mobileTitle=document.getElementById("mobile-title"),a.topbarActions=document.getElementById("topbar-actions"),a.app=document.getElementById("app"),a.sidebarOverlay=document.getElementById("sidebar-overlay"),a.settingsView=document.getElementById("settings-view"),a.settingsBtn=document.getElementById("btn-settings"),a.titleBarCustom=document.getElementById("title-bar-custom"),a.titleBarTerminal=document.getElementById("title-bar-terminal"),a.titleBarSeparator=document.getElementById("title-bar-separator")}var p,c,f,O,F,_,je,Ds,be,Et,xt,te,y,Tt,wt,ne,Lt,Ke,u,oe,Y,I,W,Ee,a,S=M(()=>{"use strict";p=[],c=null,f=null,O=null,F=null,_=!1,je=!1,Ds=!1,be=null,xt=1e3,te=!1,y=null,wt=1e3,ne=!1,Lt=!1,Ke=null,u=new Map,oe=new Set,Y=new Set,I=new Map,W=new Set,Ee=null,a={sessionList:null,sessionCount:null,terminalsArea:null,emptyState:null,mobileTitle:null,topbarActions:null,app:null,sidebarOverlay:null,settingsView:null,settingsBtn:null,titleBarCustom:null,titleBarTerminal:null,titleBarSeparator:null}});function $(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function v(e,t){let n=document.getElementById(e);n&&n.addEventListener("click",t)}var Wn=M(()=>{"use strict"});function Nt(e){let n=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"))?.[2];return n!==void 0?decodeURIComponent(n):null}function z(e,t,n=365){let o=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${e}=${encodeURIComponent(t)}; expires=${o}; path=/`}function $n(e){if(e!=="auto")return e;let t=navigator.userAgent||"";return/Windows|Win32|Win64/i.test(t)?"windows":"unix"}var zn=M(()=>{"use strict"});function Ze(e){let t=(e[0]??0)|(e[1]??0)<<8,n=(e[2]??0)|(e[3]??0)<<8,o=e.slice(4),s=t>0&&t<=Se&&n>0&&n<=Se;return{cols:t,rows:n,data:o,valid:s}}async function qn(e){let t=(e[0]??0)|(e[1]??0)<<8,n=(e[2]??0)|(e[3]??0)<<8,o=t>0&&t<=Se&&n>0&&n<=Se,s=e.slice(8);try{let i=await Hs(s);return{cols:t,rows:n,data:i,valid:o}}catch(i){return console.error("Decompression failed:",i),{cols:t,rows:n,data:new Uint8Array(0),valid:!1}}}async function Hs(e){let n=new Blob([e]).stream().pipeThrough(new DecompressionStream("gzip"));return new Uint8Array(await new Response(n).arrayBuffer())}var Vn=M(()=>{"use strict";k()});function se(e,t,n,o,s,i){i!==void 0&&clearTimeout(i);let r=window.setTimeout(()=>{o(Math.min(e*1.5,t)),n()},e);s(r)}var Xn=M(()=>{"use strict"});var R=M(()=>{"use strict";Wn();zn();Vn();Xn()});function w(e,t){let n=document.getElementById(e);n&&(n.value=String(t))}function me(e,t){let n=document.getElementById(e);n&&(n.checked=t)}function L(e,t){let n=document.getElementById(e);return n?n.value:t}function pe(e){let t=document.getElementById(e);return t?t.checked:!1}function qo(e,t,n){let o=l=>"v"+l.replace(/[+-][a-f0-9]+$/i,""),s=document.getElementById("version-server");s&&e&&(s.textContent=o(e));let i=document.getElementById("version-frontend");i&&(i.textContent=n==="dev"?"dev":o(n));let r=document.getElementById("version-host");r&&(r.textContent=t?o(t):"-")}function Vo(e,t){let n=document.getElementById("setting-run-as-user");n&&(n.innerHTML='<option value="">Process Owner (default)</option>',e.forEach(o=>{let s=document.createElement("option");s.value=o.username,s.textContent=o.username,o.username===t&&(s.selected=!0),n.appendChild(s)}))}function sn(e){w("setting-default-shell",e.defaultShell||"Pwsh"),w("setting-working-dir",e.defaultWorkingDirectory||""),w("setting-font-size",e.fontSize||14),w("setting-font-family",e.fontFamily||"Cascadia Code"),w("setting-cursor-style",e.cursorStyle||"bar"),me("setting-cursor-blink",e.cursorBlink!==!1),w("setting-theme",e.theme||"dark"),w("setting-contrast",String(e.minimumContrastRatio||1)),w("setting-scrollback",e.scrollbackLines||1e4),w("setting-bell-style",e.bellStyle||"notification"),me("setting-copy-on-select",e.copyOnSelect===!0),me("setting-right-click-paste",e.rightClickPaste!==!1),w("setting-clipboard-shortcuts",e.clipboardShortcuts||"auto"),me("setting-smooth-scrolling",e.smoothScrolling===!0),me("setting-webgl",e.useWebGL!==!1),w("setting-run-as-user",e.runAsUser||""),w("setting-log-level",e.logLevel||"warn")}async function Pe(){try{let[e,t,n,o]=await Promise.all([fetch("/api/settings").then(s=>s.json()),fetch("/api/users").then(s=>s.json()).catch(()=>[]),fetch("/api/version").then(s=>s.text()).catch(()=>null),fetch("/api/health").then(s=>s.json()).catch(()=>({status:"",memoryMB:0,uptime:"",sessionCount:0,ttyHostVersion:void 0}))]);Te(e),Vo(t,e.runAsUser),sn(e),qo(n,o.ttyHostVersion??null,kn),ut()}catch(e){console.error("Error fetching settings:",e)}}function ut(){if(!f)return;let e=f,t=T[e.theme]||T.dark,n=`'${e.fontFamily||"Cascadia Code"}', ${ye}`;u.forEach(o=>{if(o.terminal.options.cursorBlink=e.cursorBlink,o.terminal.options.cursorStyle=e.cursorStyle,o.terminal.options.fontFamily=n,o.terminal.options.fontSize=e.fontSize,o.terminal.options.theme=t,o.terminal.options.minimumContrastRatio=e.minimumContrastRatio,o.terminal.options.smoothScrollDuration=e.smoothScrolling?150:0,o.opened)try{let s=o.fitAddon.proposeDimensions();s?.cols&&s?.rows&&o.fitAddon.fit()}catch{}})}function rn(e){_&&sn(e);let t=T[e.theme]||T.dark;document.documentElement.style.setProperty("--terminal-bg",t.background),z("mm-theme",e.theme),ut()}function dt(){let e=L("setting-run-as-user",""),t={defaultShell:L("setting-default-shell","Pwsh"),defaultCols:f?.defaultCols??120,defaultRows:f?.defaultRows??30,defaultWorkingDirectory:L("setting-working-dir",""),fontSize:parseInt(L("setting-font-size","14"),10)||14,fontFamily:L("setting-font-family","Cascadia Code"),cursorStyle:L("setting-cursor-style","bar"),cursorBlink:pe("setting-cursor-blink"),theme:L("setting-theme","dark"),minimumContrastRatio:parseFloat(L("setting-contrast","1"))||1,smoothScrolling:pe("setting-smooth-scrolling"),useWebGL:pe("setting-webgl"),scrollbackLines:parseInt(L("setting-scrollback","10000"),10)||1e4,bellStyle:L("setting-bell-style","notification"),copyOnSelect:pe("setting-copy-on-select"),rightClickPaste:pe("setting-right-click-paste"),clipboardShortcuts:L("setting-clipboard-shortcuts","auto"),runAsUser:e||null,logLevel:L("setting-log-level","warn")};z("mm-theme",t.theme),fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(n=>{if(n.ok){Te(t);let o=T[t.theme]||T.dark;document.documentElement.style.setProperty("--terminal-bg",o.background),ut()}}).catch(n=>{console.error("Error saving settings:",n)})}function Ti(){let e=a.settingsView;e&&(e.querySelectorAll('select, input[type="checkbox"]').forEach(t=>{t.addEventListener("change",dt)}),e.querySelectorAll(".text-input-wrapper").forEach(t=>{let n=t.querySelector("input"),o=t.querySelector(".inline-save-btn");if(!n||!o)return;let s="";n.addEventListener("focus",()=>{s=n.value}),n.addEventListener("input",()=>{t.classList.toggle("unsaved",n.value!==s)}),o.addEventListener("click",()=>{dt(),t.classList.remove("unsaved"),s=n.value}),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),dt(),t.classList.remove("unsaved"),s=n.value)})}))}var an=M(()=>{"use strict";k();S();R()});function ln(){if(Xo){jo();return}Ci(),jo(),Xo=!0}function mt(e){Jo(e)&&(Yo=e,localStorage.setItem(Ko,e),document.querySelectorAll(".settings-tab").forEach(t=>{let n=t.getAttribute("data-tab")===e;t.classList.toggle("active",n),t.setAttribute("aria-selected",String(n))}),document.querySelectorAll(".settings-panel").forEach(t=>{let n=t.getAttribute("data-panel")===e;t.classList.toggle("hidden",!n)}))}function Li(){return Yo}function Ci(){document.querySelectorAll(".settings-tab").forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-tab");t&&mt(t)})})}function jo(){let e=localStorage.getItem(Ko);e&&Jo(e)?mt(e):mt(Go)}function Jo(e){return wi.includes(e)}var Ko,Go,wi,Yo,Xo,cn=M(()=>{"use strict";Ko="settings-tab",Go="general",wi=["general","appearance","behavior","security","diagnostics"],Yo=Go,Xo=!1});function Ii(){let e=a.app;e&&e.classList.remove("sidebar-open")}function dn(){_?pt():Zo()}function Zo(){if(Ct(!0),a.settingsBtn&&a.settingsBtn.classList.add("active"),Ii(),c){let e=u.get(c);e&&e.container.classList.add("hidden")}a.emptyState&&a.emptyState.classList.add("hidden"),a.settingsView&&a.settingsView.classList.remove("hidden"),ln(),Pe(),es()}function pt(){if(Ct(!1),a.settingsBtn&&a.settingsBtn.classList.remove("active"),a.settingsView&&a.settingsView.classList.add("hidden"),c){let e=u.get(c);e&&(e.container.classList.remove("hidden"),requestAnimationFrame(()=>{e.terminal.focus()}))}else p.length===0&&a.emptyState&&a.emptyState.classList.remove("hidden")}function Qo(e){if(e<60)return e+"s";if(e<3600)return Math.floor(e/60)+"m "+e%60+"s";let t=Math.floor(e/3600),n=Math.floor(e%3600/60);return t<24?t+"h "+n+"m":Math.floor(t/24)+"d "+t%24+"h"}function un(e){let t=document.getElementById("ttyhost-warning");if(!t){t=document.createElement("div"),t.id="ttyhost-warning",t.className="warning-banner";let n=document.querySelector(".app-header");n&&n.parentNode&&n.parentNode.insertBefore(t,n.nextSibling)}e.ttyHostVersion&&e.ttyHostCompatible===!1?(t.innerHTML="<strong>Version mismatch:</strong> mmttyhost is "+e.ttyHostVersion+", expected "+e.ttyHostExpected+". Terminals may not work correctly. Please update mmttyhost.exe or restart the service.",t.style.display="block"):t.style.display="none"}function es(){let e=document.getElementById("system-status-content");e&&fetch("/api/health").then(t=>t.json()).then(t=>{let n=t.healthy?"status-healthy":"status-error",o=t.healthy?"Healthy":"Unhealthy",s=Qo(t.uptimeSeconds||0),i="";t.ttyHostVersion!==null&&t.ttyHostVersion!==void 0&&(i='<div class="status-detail-row"><span class="detail-label">mmttyhost</span><span class="detail-value '+(t.ttyHostCompatible?"":"status-error")+'">'+t.ttyHostVersion+(t.ttyHostCompatible?"":" expected "+t.ttyHostExpected)+"</span></div>"),e.innerHTML='<div class="status-grid"><div class="status-item"><span class="status-label">Status</span><span class="status-value '+n+'">'+o+'</span></div><div class="status-item"><span class="status-label">Mode</span><span class="status-value">'+(t.mode||"")+'</span></div><div class="status-item"><span class="status-label">Sessions</span><span class="status-value">'+t.sessionCount+'</span></div><div class="status-item"><span class="status-label">Uptime</span><span class="status-value">'+s+'</span></div></div><div class="status-details"><div class="status-detail-row"><span class="detail-label">Platform</span><span class="detail-value">'+(t.platform||"")+'</span></div><div class="status-detail-row"><span class="detail-label">Process ID</span><span class="detail-value">'+(t.webProcessId||"")+"</span></div>"+i+"</div>",un(t)}).catch(t=>{let n=t instanceof Error?t.message:String(t);e.innerHTML='<div class="status-error-msg">Failed to load system status: '+n+"</div>"})}function mn(){fetch("/api/health").then(e=>e.json()).then(e=>{un(e),e.windowsBuildNumber!==void 0&&Fn(e.windowsBuildNumber)}).catch(()=>{})}var ts=M(()=>{"use strict";S();an();cn()});var ns={};Ns(ns,{applyReceivedSettings:()=>rn,applySettingsToTerminals:()=>ut,bindSettingsAutoSave:()=>Ti,checkSystemHealth:()=>mn,closeSettings:()=>pt,fetchSettings:()=>Pe,fetchSystemStatus:()=>es,formatUptime:()=>Qo,getActiveSettingsTab:()=>Li,getElementChecked:()=>pe,getElementValue:()=>L,initSettingsTabs:()=>ln,openSettings:()=>Zo,populateSettingsForm:()=>sn,populateUserDropdown:()=>Vo,populateVersionInfo:()=>qo,saveAllSettings:()=>dt,setElementChecked:()=>me,setElementValue:()=>w,switchSettingsTab:()=>mt,toggleSettings:()=>dn,updateTtyHostWarning:()=>un});var pn=M(()=>{"use strict";ts();an();cn()});k();S();R();function jn(){let e=document.cookie.match(/mm-theme=([^;]+)/)?.[1];e&&T[e]&&document.documentElement.style.setProperty("--terminal-bg",T[e].background)}var we={0:"EXCEPTION",1:"ERROR",2:"WARN",3:"INFO",4:"VERBOSE"};var Os="midterm-logs",Fs=1,D="logs",Us=1e4,Ws=7*24*60*60*1e3,Qe=null,et=null;function Le(){return Qe?Promise.resolve(Qe):et||(et=new Promise((e,t)=>{let n=indexedDB.open(Os,Fs);n.onerror=()=>{console.error("[LogStorage] Failed to open database:",n.error),t(n.error)},n.onsuccess=()=>{Qe=n.result,e(Qe)},n.onupgradeneeded=o=>{let s=o.target.result;if(!s.objectStoreNames.contains(D)){let i=s.createObjectStore(D,{keyPath:"id",autoIncrement:!0});i.createIndex("by-timestamp","timestamp",{unique:!1}),i.createIndex("by-level","level",{unique:!1}),i.createIndex("by-module","module",{unique:!1})}}}),et)}async function Kn(e){try{(await Le()).transaction(D,"readwrite").objectStore(D).add(e)}catch{}}async function Dt(e){let s=(await Le()).transaction(D,"readonly").objectStore(D).index("by-timestamp");return new Promise((i,r)=>{let l=[],d=e?.limit??1e3,m=0,h=e?.offset??0,g=s.openCursor(null,"prev");g.onsuccess=()=>{let x=g.result;if(!x||l.length>=d){i(l);return}let C=x.value;if(e?.minLevel!==void 0&&C.level>e.minLevel){x.continue();return}if(e?.module&&C.module!==e.module){x.continue();return}if(m<h){m++,x.continue();return}l.push(C),x.continue()},g.onerror=()=>r(g.error)})}async function Ht(){(await Le()).transaction(D,"readwrite").objectStore(D).clear()}async function _t(){let n=(await Le()).transaction(D,"readwrite").objectStore(D),o=n.index("by-timestamp");return new Promise(s=>{let i=0,r=Date.now()-Ws,l=n.count();l.onsuccess=()=>{let d=l.result,m=Math.max(0,d-Us),h=o.openCursor(IDBKeyRange.upperBound(r));if(h.onsuccess=()=>{let g=h.result;g&&(g.delete(),i++,g.continue())},m>0){let g=0,x=o.openCursor();x.onsuccess=()=>{let C=x.result;C&&g<m?(C.delete(),i++,g++,C.continue()):s(i)}}else s(i)}})}async function Ot(){await Le(),await _t(),setInterval(()=>_t(),5*60*1e3)}var re=2,Gn=!1;function Ut(e){re=e}function Wt(e){Gn=e}function $s(e){return`[${new Date(e.timestamp).toISOString().slice(11,23)}] [${we[e.level]}] [${e.module}] ${e.message}`}function ie(e,t,n,o){let s={timestamp:Date.now(),level:e,module:t,message:n,data:o};if(Kn(s),Gn){let i=$s(s);switch(e){case 0:case 1:console.error(i,o??"");break;case 2:console.warn(i,o??"");break;case 3:console.info(i,o??"");break;case 4:console.debug(i,o??"");break}}}function B(e){return{exception(t,n){let o=n?`${n}: ${t.message}`:t.message;ie(0,e,o,{name:t.name,stack:t.stack})},error(t,n){1>re||ie(1,e,t(),n)},warn(t,n){2>re||ie(2,e,t(),n)},info(t,n){3>re||ie(3,e,t(),n)},verbose(t,n){4>re||ie(4,e,t(),n)},log(t,n,o){t>re||ie(t,e,n(),o)}}}k();R();S();var Yn=B("state"),Jn=()=>{},Zn=()=>{},Qn=()=>{},eo=()=>{},to=()=>{},$t=()=>{},no=()=>{},oo=()=>{};function so(e){e.destroyTerminalForSession&&(Jn=e.destroyTerminalForSession),e.applyTerminalScaling&&(Zn=e.applyTerminalScaling),e.createTerminalForSession&&(Qn=e.createTerminalForSession),e.renderSessionList&&(eo=e.renderSessionList),e.updateEmptyState&&(to=e.updateEmptyState),e.selectSession&&($t=e.selectSession),e.updateMobileTitle&&(no=e.updateMobileTitle),e.renderUpdatePanel&&(oo=e.renderUpdatePanel)}function tt(){be&&(be.onclose=null,be.close(),At(null));let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/state`);At(t),t.onopen=()=>{Mt(G),kt(!0),Ce()},t.onmessage=n=>{try{let o=JSON.parse(n.data),s=o.sessions?.sessions??[];zs(s),qs(o.update)}catch(o){let s=o instanceof Error?o.message:String(o);Yn.error(()=>`Error parsing state: ${s}`)}},t.onclose=()=>{kt(!1),Ce(),Vs()},t.onerror=n=>{Yn.error(()=>`WebSocket error: ${n}`)}}function zs(e){let t=new Set(e.map(o=>o.id));u.forEach((o,s)=>{t.has(s)||(Jn(s),oe.delete(s))}),e.forEach(o=>{let s=u.get(o.id);s&&s.opened?(s.serverCols!==o.cols||s.serverRows!==o.rows)&&(s.serverCols=o.cols,s.serverRows=o.rows,s.terminal.resize(o.cols,o.rows),Zn(o.id,s)):s?(s.serverCols=o.cols,s.serverRows=o.rows):Qn(o.id,o)}),Nn(e),eo(),to();let n=p[0];if(!c&&n&&!_&&$t(n.id,{closeSettingsPanel:!1}),c&&!p.find(o=>o.id===c)){xe(null);let o=p[0];o&&!_&&$t(o.id,{closeSettingsPanel:!1})}no()}function qs(e){Ge(e),oo()}function Vs(){se(xt,Q,tt,Mt,Dn,Et)}function Ce(){let e=document.getElementById("connection-status");if(!e)return;let t,n;te&&ne?(t="connected",n=""):!te&&!ne?(t="disconnected",n="Server disconnected"):(t="reconnecting",n="Reconnecting..."),e.className=`connection-status ${t}`,e.textContent=n}k();R();S();var q=B("mux"),ro=()=>{};function ao(e){e.applyTerminalScaling&&(ro=e.applyTerminalScaling)}var Zs=1e4,Qs=1e3,J=[],zt=!1;function ei(e,t,n){J.length>=Zs&&(q.warn(()=>"Output queue full, dropping oldest frame"),J.shift()),J.push({sessionId:e,payload:t,compressed:n}),ti()}async function ti(){if(!zt){zt=!0;try{for(;J.length>0;){let e=J.shift();await ni(e)}}finally{zt=!1}}}async function ni(e){try{let t,n,o;if(e.compressed){let i=await qn(e.payload);t=i.cols,n=i.rows,o=i.data}else{let i=Ze(e.payload);t=i.cols,n=i.rows,o=i.data}let s=u.get(e.sessionId);if(s&&s.opened)oi(e.sessionId,s,t,n,o);else if(o.length>0){let i=new Uint8Array(4+o.length);i[0]=t&255,i[1]=t>>8&255,i[2]=n&255,i[3]=n>>8&255,i.set(o,4),I.has(e.sessionId)||I.set(e.sessionId,[]);let r=I.get(e.sessionId);if(r.length>=Qs){q.warn(()=>`Pending frames overflow for ${e.sessionId}, scheduling resync`),W.add(e.sessionId),I.delete(e.sessionId);return}r.push(i)}}catch(t){q.error(()=>`Failed to process frame: ${t}`)}}var qt=new Map;function lo(e){return qt.get(e)??!1}function oi(e,t,n,o,s){if(s.length>0){let i=new TextDecoder().decode(s);i.includes("\x1B[?2004h")&&qt.set(e,!0),i.includes("\x1B[?2004l")&&qt.set(e,!1)}if(n>0&&o>0&&n<=500&&o<=500&&t.opened){let i=t.terminal.cols,r=t.terminal.rows;if(i!==n||r!==o)try{t.terminal.resize(n,o),t.serverCols=n,t.serverRows=o,ro(e,t)}catch(l){let d=l instanceof Error?l.message:String(l);q.warn(()=>`Terminal resize deferred: ${d}`)}}s.length>0&&t.terminal.write(s)}function nt(){y&&(y.onclose=null,y.close(),Rt(null));let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/mux`);t.binaryType="arraybuffer",Rt(t),t.onopen=()=>{let n=Lt&&u.size>0;Bt(G),Pt(!0),On(!0),Ce(),n?(q.info(()=>`Reconnected - refreshing ${u.size} terminals`),I.clear(),W.clear(),J.length=0,u.forEach(o=>{o.opened&&o.terminal.clear(),o.serverCols=0,o.serverRows=0})):q.info(()=>"Connected (first connection)"),c&&Vt(c)},t.onmessage=n=>{if(!(n.data instanceof ArrayBuffer))return;let o=new Uint8Array(n.data);if(o.length<9)return;let s=o[0],i=si(o,1),r=o.slice(9);if(s===5){q.info(()=>"Resync: clearing terminals for buffer refresh"),u.forEach(l=>{l.opened&&l.terminal.clear()}),I.clear(),W.clear(),J.length=0;return}(s===1||s===7)&&r.length>=4&&ei(i,r.slice(),s===7)},t.onclose=()=>{Pt(!1),Ce(),ii()},t.onerror=n=>{q.error(()=>`WebSocket error: ${n}`)}}function ot(e,t){if(!y||y.readyState!==WebSocket.OPEN)return;let n=new TextEncoder().encode(t),o=new Uint8Array(9+n.length);o[0]=2,st(o,1,e),o.set(n,9),y.send(o)}function co(e,t,n){if(!y||y.readyState!==WebSocket.OPEN)return;let o=new Uint8Array(13);o[0]=3,st(o,1,e),o[9]=t&255,o[10]=t>>8&255,o[11]=n&255,o[12]=n>>8&255,y.send(o);let s=u.get(e);s&&(s.serverCols=t,s.serverRows=n)}function uo(e){if(!y||y.readyState!==WebSocket.OPEN)return;let t=new Uint8Array(9);t[0]=6,st(t,1,e),y.send(t)}function Vt(e){if(!y||y.readyState!==WebSocket.OPEN)return;let t=new Uint8Array(9);t[0]=8,e&&st(t,1,e),y.send(t)}function st(e,t,n){for(let o=0;o<8;o++)e[t+o]=o<n.length?n.charCodeAt(o):0}function si(e,t){let n=[];for(let o=0;o<8;o++){let s=e[t+o];s!==void 0&&s!==0&&n.push(String.fromCharCode(s))}return n.join("")}function ii(){se(wt,Q,nt,Bt,Hn,Tt)}k();R();S();var it=B("settings-ws"),Ie=null,mo,Xt=G,po=!1,fo=()=>{};function go(e){e.applyReceivedSettings&&(fo=e.applyReceivedSettings)}function jt(){Ie&&(Ie.onclose=null,Ie.close(),Ie=null);let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/settings`);Ie=t,t.onopen=()=>{Xt=G,po=!0,it.info(()=>"Settings WebSocket connected")},t.onmessage=n=>{try{let o=JSON.parse(n.data);ri(o)}catch(o){let s=o instanceof Error?o.message:String(o);it.error(()=>`Error parsing settings: ${s}`)}},t.onclose=()=>{po=!1,it.info(()=>"Settings WebSocket disconnected"),ai()},t.onerror=n=>{it.error(()=>`Settings WebSocket error: ${n}`)}}function ri(e){Te(e),fo(e)}function ai(){se(Xt,Q,jt,e=>{Xt=e},e=>{mo=e},mo)}k();S();R();k();S();var Kt=()=>{};function vo(e){e.sendResize&&(Kt=e.sendResize)}function Z(e){let t=u.get(e);if(!t)return;if(!t.opened){(Ee??Promise.resolve()).then(()=>{Z(e)});return}let n=t.container.querySelector(".xterm");n&&(n.style.zoom="",n.style.transform="",t.container.classList.remove("scaled"));let o=t.container.classList.contains("hidden");o&&t.container.classList.remove("hidden");let s=a.terminalsArea?.getBoundingClientRect();if(!s||s.width<100||s.height<100){o&&t.container.classList.add("hidden");return}let i=t.container.querySelector(".xterm-screen"),r=t.terminal.cols,l=t.terminal.rows,d=null,m=null;if(i&&r>0&&l>0&&(d=i.offsetWidth/r,m=i.offsetHeight/l),!d||!m||d<1||m<1){requestAnimationFrame(()=>{try{let Mn=t.fitAddon.proposeDimensions();Mn?.cols&&Mn?.rows&&(t.fitAddon.fit(),Kt(e,t.terminal))}catch{}o&&t.container.classList.add("hidden")});return}let h=s.width-ee,g=s.height-ee,x=Math.floor(h/d),C=Math.floor(g/m);x=Math.max($e,Math.min(x,qe)),C=Math.max(ze,Math.min(C,Ve)),requestAnimationFrame(()=>{try{(t.terminal.cols!==x||t.terminal.rows!==C)&&(t.terminal.resize(x,C),Kt(e,t.terminal))}catch{}o&&t.container.classList.add("hidden")})}function ae(e,t){let n=t.container,o=n.querySelector(".xterm");o&&requestAnimationFrame(()=>{let s=n.clientWidth-8,i=n.clientHeight-8,r=o.offsetWidth,l=o.offsetHeight,d=s/r,m=i/l,h=Math.min(d,m,1);h<.99?(o.style.zoom=h,o.style.transform="",n.classList.add("scaled")):(o.style.zoom="",o.style.transform="",n.classList.remove("scaled"))})}function Ae(){u.forEach((e,t)=>{e.opened&&ae(t,e)})}function ho(){window.addEventListener("resize",Ae)}function yo(){if(!window.visualViewport||!a.terminalsArea)return;let e=0,t=()=>{let n=window.visualViewport.height;if(Math.abs(n-e)<1)return;e=n,document.documentElement.style.setProperty("--visual-vh",n+"px");let o=document.querySelector(".mobile-header"),s=0;o&&window.getComputedStyle(o).display!=="none"&&(s=o.offsetHeight);let i=Math.floor((n-s)*.99);a.terminalsArea.style.height=i+"px"};window.visualViewport.addEventListener("resize",t),t()}S();var li=40*1024,ci=new Set([".png",".jpg",".jpeg",".gif",".bmp",".webp",".svg",".ico",".tiff",".tif",".heic",".heif",".avif"]),di=new Set([".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".odt",".ods",".odp",".rtf",".exe",".dll",".so",".dylib",".app",".msi",".deb",".rpm",".dmg",".iso",".zip",".tar",".gz",".7z",".rar",".bz2",".xz",".tgz",".bin",".dat",".db",".sqlite",".sqlite3",".mp3",".mp4",".wav",".avi",".mov",".mkv",".flac",".ogg",".webm"]),Me=()=>{};function Gt(e){let t=e.lastIndexOf(".");return t>=0?e.slice(t).toLowerCase():""}function ui(e){return ci.has(Gt(e))}function mi(e){return di.has(Gt(e))}function V(e){let t=document.querySelector(".drop-toast");t&&t.remove();let n=document.createElement("div");n.className="drop-toast error",n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.classList.add("hiding"),setTimeout(()=>n.remove(),300)},3e3)}async function pi(e){return new Promise((t,n)=>{let o=new FileReader;o.onload=()=>t(o.result),o.onerror=()=>n(o.error),o.readAsText(e)})}function le(e){return e.replace(/\r\n/g,`
`).replace(/\r(?!\n)/g,`
`).replace(/\x1b\[[0-9;]*[A-Za-z]/g,"").replace(/\x1b\][^\x07]*\x07/g,"").replace(/\x1b[PX^_][^\x1b]*\x1b\\/g,"").replace(/\x1b[\x20-\x2F]*[\x30-\x7E]/g,"")}function So(e){e.pasteToTerminal&&(Me=e.pasteToTerminal)}async function bo(e,t){let n=new FormData;n.append("file",t);try{let o=await fetch(`/api/sessions/${e}/upload`,{method:"POST",body:n});return o.ok?(await o.json()).path:(o.status===401?V("Upload failed: not authenticated"):o.status===404?V("Upload failed: session not found"):V(`Upload failed: ${o.status}`),null)}catch{return V("Upload failed: network error"),null}}async function fi(e){if(!c||e.length===0)return;let t=[];for(let n of Array.from(e)){if(ui(n.name)){let o=await bo(c,n);o&&t.push(o);continue}if(mi(n.name)){let o=Gt(n.name);V(`Cannot paste ${o} files`);continue}if(n.size>li){V(`File too large (max 40KB): ${n.name}`);continue}try{let o=await pi(n),s=le(o);Me(c,s,!1)}catch(o){console.error(`[FileDrop] Failed to read file: ${n.name}`,o),V(`Failed to read: ${n.name}`)}}if(t.length>0){let n=le(t.join(" "));Me(c,n,!0)}}function Eo(e){e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over")}),e.addEventListener("dragend",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",async t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drag-over");let n=t.dataTransfer?.files;n&&n.length>0&&await fi(n)})}async function rt(e){if(!window.isSecureContext){V("Paste requires HTTPS or localhost");return}try{let t=await navigator.clipboard.read();for(let n of t){let o=n.types.find(s=>s.startsWith("image/"));if(o){let s=await n.getType(o),i=new Date().toISOString().replace(/[:.]/g,"-"),r=new File([s],`clipboard_${i}.jpg`,{type:o}),l=await bo(e,r);if(l){Me(e,le(l),!0);return}}}}catch{}try{let t=await navigator.clipboard.readText();if(t){let n=le(t);Me(e,n)}}catch{}}S();var ke=new Map,Jt=!1,X=null,U=null,ce=null;function To(e,t){try{let n=new SearchAddon.SearchAddon;t.loadAddon(n),ke.set(e,{addon:n,currentIndex:0,totalMatches:0})}catch{}}function wo(e){ke.delete(e)}function Lo(){ce||(ce=document.getElementById("terminal-search"),X=document.getElementById("search-input"),U=document.getElementById("search-results")),ce&&X&&(ce.classList.remove("hidden"),Jt=!0,X.focus(),X.select())}function at(){if(ce&&(ce.classList.add("hidden"),Jt=!1),c){let e=ke.get(c);e?.addon&&e.addon.clearDecorations()}if(c){let e=u.get(c);e&&e.terminal.focus()}}function Co(){return Jt}function Yt(){if(!c||!X)return;let e=X.value;if(!e)return;let t=ke.get(c);if(!t?.addon)return;let n=t.addon.findNext(e,{incremental:!1});Io(n)}function xo(){if(!c||!X)return;let e=X.value;if(!e)return;let t=ke.get(c);if(!t?.addon)return;let n=t.addon.findPrevious(e);Io(n)}function Io(e){U&&(e?(U.textContent="Found",U.style.color=""):(U.textContent="No matches",U.style.color="var(--accent-red)"))}function Ao(){let e=document.getElementById("search-input"),t=document.getElementById("search-prev"),n=document.getElementById("search-next"),o=document.getElementById("search-close");e&&(e.addEventListener("input",()=>{c&&e.value?Yt():U&&(U.textContent="0/0",U.style.color="")}),e.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),s.shiftKey?xo():Yt()):s.key==="Escape"&&(s.preventDefault(),at())})),t&&t.addEventListener("click",xo),n&&n.addEventListener("click",Yt),o&&o.addEventListener("click",at)}var j=()=>{},ko=()=>{},Ro=()=>{},Re=new Map;function gi(e,t){if(p.find(i=>i.id===e)?.manuallyNamed)return;let o=Re.get(e);o&&window.clearTimeout(o);let s=window.setTimeout(()=>{Re.delete(e),fetch(`/api/sessions/${e}/name?auto=true`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).catch(()=>{})},500);Re.set(e,s)}function Bo(e){e.sendInput&&(j=e.sendInput),e.showBellNotification&&(ko=e.showBellNotification),e.requestBufferRefresh&&(Ro=e.requestBufferRefresh)}function vi(){let e=window.innerWidth<=Pn,t=f?.fontSize??14,n=e?Math.max(t-2,10):t,o=f?.theme??"dark",s=f?.fontFamily??"Cascadia Code",i={cursorBlink:f?.cursorBlink??!0,cursorStyle:f?.cursorStyle??"bar",cursorInactiveStyle:"none",fontFamily:`'${s}', ${ye}`,fontSize:n,letterSpacing:0,lineHeight:1,scrollback:f?.scrollbackLines??1e4,minimumContrastRatio:f?.minimumContrastRatio??1,smoothScrollDuration:f?.smoothScrolling?150:0,allowProposedApi:!0,customGlyphs:!0,rescaleOverlappingGlyphs:!0,theme:T[o]??T.dark},r=/Windows|Win32|Win64/i.test(navigator.userAgent);return Ke!==null?i.windowsPty={backend:"conpty",buildNumber:Ke}:r&&(i.windowsPty={backend:"conpty",buildNumber:19041}),i}function Zt(e,t){let n=u.get(e);if(n)return n;let o=document.createElement("div");o.className="terminal-container hidden",o.id="terminal-"+e,a.terminalsArea?.appendChild(o),Eo(o);let s=new Terminal(vi()),i=new FitAddon.FitAddon;s.loadAddon(i);let r=t&&t.cols>0?t.cols:0,l=t&&t.rows>0?t.rows:0,d={terminal:s,fitAddon:i,container:o,serverCols:r,serverRows:l,opened:!1};return u.set(e,d),(Ee??Promise.resolve()).then(()=>{if(u.has(e)){if(s.open(o),d.opened=!0,f?.useWebGL!==!1)try{let m=new WebglAddon.WebglAddon;m.onContextLost(()=>{m.dispose()}),s.loadAddon(m)}catch{}try{let m=new WebLinksAddon.WebLinksAddon((h,g)=>{(g.startsWith("http://")||g.startsWith("https://"))&&window.open(g,"_blank","noopener,noreferrer")});s.loadAddon(m)}catch{}To(e,s),hi(e,d),requestAnimationFrame(()=>{u.has(e)&&(Z(e),Si(e,s,o))})}}),d}function hi(e,t){if(W.has(e)){W.delete(e),I.delete(e),Ro(e);return}let n=I.get(e);n&&n.length>0&&(n.forEach(o=>{yi(e,t,o)}),I.delete(e))}function yi(e,t,n){let o=Ze(n);if(o.valid&&t.opened){let s=t.terminal.cols,i=t.terminal.rows;if(s!==o.cols||i!==o.rows)try{t.terminal.resize(o.cols,o.rows),t.serverCols=o.cols,t.serverRows=o.rows,ae(e,t)}catch{}}o.data.length>0&&t.terminal.write(o.data)}function Si(e,t,n){t.onData(r=>{j(e,r)}),t.onBell(()=>{ko(e)}),t.onSelectionChange(()=>{f?.copyOnSelect&&t.hasSelection()&&navigator.clipboard.writeText(t.getSelection()).catch(()=>{})}),t.onTitleChange(r=>{r&&r.trim()&&gi(e,r.trim())}),t.attachCustomKeyEventHandler(r=>{if(r.type!=="keydown")return!0;if(r.ctrlKey&&!r.shiftKey&&!r.altKey&&!r.metaKey&&r.key==="Enter")return j(e,`
`),!1;if($n(f?.clipboardShortcuts??"auto")==="windows"){if(r.ctrlKey&&!r.shiftKey&&r.key==="c")return t.hasSelection()?(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection(),!1):!0;if(r.ctrlKey&&!r.shiftKey&&r.key==="v")return window.isSecureContext?(rt(e),!1):!0}else{if(r.ctrlKey&&r.shiftKey&&(r.key==="C"||r.key==="c"))return t.hasSelection()&&(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection()),!1;if(r.ctrlKey&&r.shiftKey&&(r.key==="V"||r.key==="v"))return window.isSecureContext?(rt(e),!1):!0}return(r.ctrlKey||r.metaKey)&&r.key==="f"?(Lo(),!1):r.key==="Escape"&&Co()?(at(),!1):!0});let o=r=>{if(r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),!window.isSecureContext&&r.clipboardData){let l=r.clipboardData.getData("text/plain");l&&en(e,le(l))}};n.addEventListener("paste",o,!0);let s=r=>{(!f||f.rightClickPaste!==!1)&&(r.preventDefault(),rt(e))};n.addEventListener("contextmenu",s);let i=u.get(e);i&&(i.contextMenuHandler=s,i.pasteHandler=o)}function Qt(e){let t=u.get(e);if(!t)return;t.contextMenuHandler&&t.container.removeEventListener("contextmenu",t.contextMenuHandler),t.pasteHandler&&t.container.removeEventListener("paste",t.pasteHandler,!0),wo(e);let n=Re.get(e);n&&(clearTimeout(n),Re.delete(e)),t.terminal.dispose(),t.container.remove(),u.delete(e),I.delete(e),W.delete(e)}var Be=128,bi=100;async function Mo(e,t){for(let n=0;n<t.length;n+=Be){let o=t.slice(n,n+Be);j(e,o),n+Be<t.length&&await new Promise(s=>setTimeout(s,bi))}}function en(e,t,n=!1){let o=u.get(e);if(!o)return;let s=lo(e),i=o.terminal.modes?.bracketedPasteMode??!1,r=s||i,l=n?'"'+t+'"':t;if(r){let d="\x1B[200~"+l+"\x1B[201~";d.length>Be?(j(e,"\x1B[200~"),Mo(e,l).then(()=>{j(e,"\x1B[201~")})):j(e,d)}else l.length>Be?Mo(e,l):j(e,l)}function Po(e){let t=u.get(e);!t||!t.opened||t.terminal.scrollToBottom()}function No(){let e=document.fonts.ready.then(()=>{let t=document.createElement("span");return t.style.fontFamily=ye,t.style.position="absolute",t.style.left="-9999px",t.textContent="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",document.body.appendChild(t),new Promise(n=>{requestAnimationFrame(()=>{t.remove(),n()})})});return Je(e),e}S();k();var H=null;function _o(e){H=e}function tn(e){let t=e.terminalTitle||e.shellType;return e.name?{primary:e.name,secondary:t}:{primary:t,secondary:null}}function nn(e){return tn(e).primary}function de(){if(!a.sessionList)return;a.sessionList.innerHTML="",p.forEach(t=>{let n=Y.has(t.id),o=document.createElement("div");o.className="session-item"+(t.id===c?" active":"")+(n?" pending":""),o.dataset.sessionId=t.id,n||o.addEventListener("click",()=>{H&&(H.onSelect(t.id),H.onCloseSidebar())});let s=document.createElement("div");if(s.className="session-info",n){let d=document.createElement("span");d.className="session-spinner",s.appendChild(d)}let i=tn(t),r=document.createElement("span");if(r.className="session-title",r.textContent=i.primary,s.appendChild(r),i.secondary){o.classList.add("two-line");let d=document.createElement("span");d.className="session-subtitle",d.textContent=i.secondary,s.appendChild(d)}let l=document.createElement("div");if(l.className="session-actions",!n){let d=document.createElement("button");d.className="session-resize",d.innerHTML=Xe("resize"),d.title="Fit to screen",d.addEventListener("click",g=>{g.stopPropagation(),H&&H.onResize(t.id)});let m=document.createElement("button");m.className="session-rename",m.innerHTML=Xe("rename"),m.title="Rename session",m.addEventListener("click",g=>{g.stopPropagation(),H&&H.onRename(t.id)});let h=document.createElement("button");h.className="session-close",h.innerHTML=Xe("close"),h.title="Close session",h.addEventListener("click",g=>{g.stopPropagation(),H&&H.onDelete(t.id)}),l.appendChild(d),l.appendChild(m),l.appendChild(h)}o.appendChild(s),o.appendChild(l),a.sessionList.appendChild(o)});let e=p.filter(t=>!Y.has(t.id)).length;a.sessionCount&&(a.sessionCount.textContent=String(e))}function lt(){a.emptyState&&(p.length===0?(a.emptyState.classList.remove("hidden"),a.settingsView&&a.settingsView.classList.add("hidden")):_||a.emptyState.classList.add("hidden"))}function ue(){if(!a.mobileTitle)return;let e=p.find(t=>t.id===c);a.mobileTitle.textContent=e?nn(e):"MidTerm",a.topbarActions&&(e?a.topbarActions.classList.remove("no-terminal"):a.topbarActions.classList.add("no-terminal")),Ei(e)}function Ei(e){if(!a.titleBarCustom||!a.titleBarTerminal||!a.titleBarSeparator)return;if(!e){a.titleBarCustom.textContent="MidTerm",a.titleBarTerminal.textContent="",a.titleBarSeparator.style.display="none";return}let t=tn(e);e.name?(a.titleBarCustom.textContent=t.primary,a.titleBarTerminal.textContent=t.secondary||"",a.titleBarSeparator.style.display=t.secondary?"":"none"):(a.titleBarCustom.textContent=t.primary,a.titleBarTerminal.textContent="",a.titleBarSeparator.style.display="none")}S();R();var on="mm-sidebar-collapsed",Do="mm-sidebar-width",xi=768,Ho=180,Oo=400;function Fo(){It(!je),a.app&&a.app.classList.toggle("sidebar-open",je)}function ct(){It(!1),a.app&&a.app.classList.remove("sidebar-open")}function Uo(){Ye(!0),a.app&&a.app.classList.add("sidebar-collapsed"),z(on,"true"),ue(),requestAnimationFrame(Ae)}function Wo(){Ye(!1),a.app&&a.app.classList.remove("sidebar-collapsed"),z(on,"false"),requestAnimationFrame(Ae)}function $o(){Nt(on)==="true"&&window.innerWidth>xi&&(Ye(!0),a.app&&a.app.classList.add("sidebar-collapsed"));let e=Nt(Do);if(e){let t=parseInt(e,10);if(t>=Ho&&t<=Oo){let n=document.getElementById("sidebar");n&&(n.style.width=t+"px")}}}function zo(){let e=document.getElementById("sidebar-resize-grip"),t=document.getElementById("sidebar");if(!e||!t)return;let n=!1,o=0,s=0;e.addEventListener("mousedown",i=>{n=!0,o=i.clientX,s=t.offsetWidth,e.classList.add("active"),document.body.style.cursor="ew-resize",document.body.style.userSelect="none",i.preventDefault()}),document.addEventListener("mousemove",i=>{if(!n)return;let r=i.clientX-o,l=Math.max(Ho,Math.min(Oo,s+r));t.style.width=l+"px",Ae()}),document.addEventListener("mouseup",()=>{if(!n)return;n=!1,e.classList.remove("active"),document.body.style.cursor="",document.body.style.userSelect="";let i=t.offsetWidth;z(Do,String(i))})}pn();S();async function Ne(){try{let e=await fetch("/api/auth/status");if(e.status===401){window.location.href="/login.html";return}let t=await e.json();_n(t),os(),ss()}catch(e){console.error("Auth status error:",e)}}function os(){let e=document.getElementById("security-warning");e&&(F&&F.authenticationEnabled&&!F.passwordSet?e.classList.remove("hidden"):e.classList.add("hidden"))}function ss(){let e=document.getElementById("password-status-text");if(e){if(!F){e.textContent="Checking...",e.className="";return}F.passwordSet?(e.textContent="Password is set",e.className="status-set"):(e.textContent="No password set",e.className="status-missing")}}function fn(){let e=document.getElementById("security-warning");e&&e.classList.add("hidden")}S();R();var _e=!1;function gn(e){let t=document.getElementById("password-modal"),n=document.getElementById("password-modal-title"),o=document.getElementById("current-password-group"),s=document.getElementById("password-error");if(!t)return;_e=F?.passwordSet??!1,n&&(n.textContent=_e?"Change Password":"Set Password"),o&&(o.style.display=_e?"block":"none"),s&&(s.classList.add("hidden"),s.textContent="");let i=document.getElementById("password-form");i&&i.reset(),t.classList.remove("hidden");let r=_e?"current-password":"new-password",l=document.getElementById(r);l&&l.focus()}function De(){let e=document.getElementById("password-modal");e&&e.classList.add("hidden")}function is(e){e.preventDefault();let t=document.getElementById("current-password"),n=document.getElementById("new-password"),o=document.getElementById("confirm-password"),s=document.getElementById("btn-save-password"),i=n?.value??"",r=o?.value??"";if(!i){fe("New password is required");return}if(i!==r){fe("Passwords do not match");return}if(i.length<4){fe("Password must be at least 4 characters");return}let l={currentPassword:_e&&t?t.value:null,newPassword:i};s&&(s.disabled=!0,s.textContent="Saving..."),fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}).then(d=>d.json().then(m=>({ok:d.ok,data:m}))).then(d=>{s&&(s.disabled=!1,s.textContent="Save"),d.ok&&d.data.success?(De(),Ne()):fe(d.data.error||"Failed to change password")}).catch(()=>{s&&(s.disabled=!1,s.textContent="Save"),fe("Connection error")})}function fe(e){let t=document.getElementById("password-error");t&&(t.textContent=e,t.classList.remove("hidden"))}function vn(){v("btn-set-password-warning",()=>{gn(!0)}),v("btn-dismiss-warning",fn),v("btn-change-password",()=>{gn(!1)}),v("btn-close-password",De),v("btn-cancel-password",De);let e=document.querySelector("#password-modal .modal-backdrop");e&&e.addEventListener("click",De);let t=document.getElementById("password-form");t&&t.addEventListener("submit",is)}S();var rs=30,as=2e3,Ai=3e3;function hn(){let e=document.getElementById("update-panel");if(!e)return;if(!O||!O.available){e.classList.add("hidden");return}e.classList.remove("hidden");let t=e.querySelector(".update-current"),n=e.querySelector(".update-latest"),o=e.querySelector(".update-note"),s=e.querySelector(".update-header");t&&(t.textContent=O.currentVersion),n&&(n.textContent=O.latestVersion),O.sessionsPreserved?(s&&(s.textContent="Quick Update"),o&&(o.textContent="Sessions will stay alive",o.classList.add("update-note-safe"),o.classList.remove("update-note-warning"))):(s&&(s.textContent="Update Available"),o&&(o.textContent="Save your work - sessions will restart",o.classList.add("update-note-warning"),o.classList.remove("update-note-safe")))}function ft(){if(!O||!O.available)return;let t=document.getElementById("update-panel")?.querySelector(".update-btn");t&&(t.disabled=!0,t.textContent="Updating..."),fetch("/api/update/apply",{method:"POST"}).then(n=>{n.ok?(t&&(t.textContent="Restarting..."),ds()):(t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update failed"))}).catch(n=>{t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update error:",n)})}function ds(){let e=0;function t(){e++,fetch("/api/version",{cache:"no-store"}).then(n=>{n.ok?location.reload():e<rs&&setTimeout(t,as)}).catch(()=>{e<rs&&setTimeout(t,as)})}setTimeout(t,Ai)}function us(){let e=document.getElementById("btn-check-updates");e&&(e.disabled=!0,e.textContent="Checking..."),fetch("/api/update/check").then(t=>t.json()).then(t=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),Ge(t),hn(),ls(t)}).catch(t=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),ls(null,"Failed to check for updates"),console.error("Update check error:",t)})}function ls(e,t){let n=document.getElementById("update-cards"),o=document.getElementById("update-status-none");if(!n)return;if(n.innerHTML="",t){o&&o.classList.add("hidden"),n.innerHTML=`<div class="update-status-error">${t}</div>`;return}let s=e?.available??!1,i=e?.environment&&e?.localUpdate?.available;if(!s&&!i){o&&o.classList.remove("hidden");return}if(o&&o.classList.add("hidden"),s&&e){let r=cs({type:"github",title:"GitHub Release",version:e.latestVersion,sessionsPreserved:e.sessionsPreserved,onApply:ft});n.appendChild(r)}if(i&&e?.localUpdate){let r=cs({type:"local",title:"Local Build",version:e.localUpdate.version,sessionsPreserved:e.localUpdate.sessionsPreserved,onApply:Mi});n.appendChild(r)}}function cs(e){let t=document.createElement("div");t.className=`update-card ${e.type}`,t.id=`update-card-${e.type}`;let n=e.sessionsPreserved?"safe":"warn",o=e.sessionsPreserved?"Sessions will stay alive":"Sessions will restart";t.innerHTML=`
    <div class="update-card-header">
      <span class="update-card-title">${e.title}</span>
      <span class="update-card-version">v${e.version}</span>
    </div>
    <div class="update-card-footer">
      <span class="update-card-warning ${n}">${o}</span>
      <button class="btn-update">Apply</button>
    </div>
  `;let s=t.querySelector(".btn-update");return s&&s.addEventListener("click",()=>{s.disabled=!0,s.textContent="Applying...",e.onApply()}),t}function Mi(){fetch("/api/update/apply?source=local",{method:"POST"}).then(e=>{let t=document.querySelector("#update-card-local .btn-update");e.ok?(t&&(t.textContent="Restarting..."),ds()):(t&&(t.disabled=!1,t.textContent="Apply"),console.error("Local update failed"))}).catch(e=>{let t=document.querySelector("#update-card-local .btn-update");t&&(t.disabled=!1,t.textContent="Apply"),console.error("Local update error:",e)})}function ms(){fetch("/api/update/result").then(e=>e.json()).then(e=>{e.found&&fetch("/api/update/result",{method:"DELETE"}).catch(()=>{})}).catch(()=>{})}R();var ki="https://api.github.com/repos/AiTlbx/MidTerm/releases",ps=30,Ri="https://github.com/AiTlbx/MidTerm/releases",yn=1,He=!0,Oe=!1;function fs(){let e=document.getElementById("changelog-modal"),t=document.getElementById("changelog-body");yn=1,He=!0,Oe=!1,e&&e.classList.remove("hidden"),t&&(t.innerHTML='<div class="changelog-loading">Loading changelog...</div>'),gs(!0)}function gs(e){if(Oe)return;Oe=!0;let t=document.getElementById("changelog-body");if(!t)return;let n=`${ki}?per_page=${ps}&page=${yn}`;fetch(n).then(o=>o.json()).then(o=>{if(Oe=!1,!o||!Array.isArray(o)){e&&(t.innerHTML="<p>No releases found.</p>"),He=!1;return}if(He=o.length===ps,o.length===0){e&&(t.innerHTML="<p>No releases found.</p>"),He=!1;return}let s="";if(o.forEach(i=>{let r=i.tag_name||"Unknown",l=i.published_at?new Date(i.published_at).toLocaleDateString():"",d=i.body||"No release notes.",m=Bi(d,r);s+='<div class="changelog-release">',s+='<div class="changelog-version">'+$(r)+"</div>",l&&(s+='<div class="changelog-date">'+$(l)+"</div>"),s+='<div class="changelog-notes">'+Ni(m)+"</div>",s+="</div>"}),e)t.innerHTML=s;else{let i=t.querySelector(".changelog-load-more");i&&i.remove(),t.insertAdjacentHTML("beforeend",s)}if(He){let i=document.createElement("button");i.className="changelog-load-more",i.textContent="Load older releases",i.addEventListener("click",()=>{yn++,i.textContent="Loading...",i.disabled=!0,gs(!1)}),t.appendChild(i)}}).catch(o=>{Oe=!1,e&&(t.innerHTML='<p class="changelog-error">Failed to load changelog. <a href="'+Ri+'" target="_blank">View on GitHub</a></p>'),console.error("Changelog error:",o)})}function Sn(){let e=document.getElementById("changelog-modal");e&&e.classList.add("hidden")}function Bi(e,t){let n=t.replace(/^v/,""),o=new RegExp(`^v?${Pi(n)}:\\s*`,"i");return e.replace(o,"").trim()}function Pi(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ni(e){return $(e).replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n{3,}/g,`

`).replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")}var gt=B("logs-ws"),E=null,bn=null,vt=1e3,_i=3e4,vs=null,hs=null,ys=null,En=null;function Ss(e){vs=e}function bs(e){hs=e}function Es(e){ys=e}function xs(e){En=e}function ht(){if(E&&E.readyState===WebSocket.OPEN)return;E&&(E.onclose=null,E.close());let e=location.protocol==="https:"?"wss:":"ws:";E=new WebSocket(`${e}//${location.host}/ws/logs`),E.onopen=()=>{gt.info(()=>"Connected to logs WebSocket"),vt=1e3,En?.(!0)},E.onmessage=t=>{try{let n=JSON.parse(t.data);Di(n)}catch(n){gt.error(()=>`Failed to parse log message: ${n}`)}},E.onclose=()=>{gt.info(()=>"Logs WebSocket closed"),En?.(!1),Hi()},E.onerror=()=>{gt.error(()=>"Logs WebSocket error")}}function xn(){ve({action:"subscribe",type:"mt"})}function Ts(){ve({action:"unsubscribe",type:"mt"})}function yt(e){ve({action:"subscribe",type:"mthost",sessionId:e})}function Tn(e){ve({action:"unsubscribe",type:"mthost",sessionId:e})}function ge(e,t,n=100){ve({action:"history",type:e,sessionId:t,limit:n})}function wn(){ve({action:"sessions"})}function Fe(){return E!==null&&E.readyState===WebSocket.OPEN}function ve(e){!E||E.readyState!==WebSocket.OPEN||E.send(JSON.stringify(e))}function Di(e){switch(e.messageType){case"log":vs?.(e);break;case"history":hs?.(e);break;case"sessions":ys?.(e);break;case"ping":break}}function Hi(){bn||(bn=window.setTimeout(()=>{bn=null,vt=Math.min(vt*2,_i),ht()},vt))}var A="frontend",St=2,K="",Ue=!0,N=[],ws=null,b=null,Is=[];function Ln(){Ui(),$i(),Fi(),ji()}function Fi(){Ss(zi),bs(qi),Es(Vi),xs(e=>{e&&(A==="server"?(xn(),ge("mt")):A==="sessions"&&b&&(yt(b),ge("mthost",b)),wn())})}function Ui(){document.querySelectorAll(".diag-tab").forEach(t=>{t.addEventListener("click",()=>{let n=t.getAttribute("data-tab");n&&Wi(n)})})}function Wi(e){A==="server"?Ts():A==="sessions"&&b&&Tn(b),A=e,document.querySelectorAll(".diag-tab").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-tab")===e)});let t=document.getElementById("diag-session-select");t&&t.classList.toggle("hidden",e!=="sessions");let n=document.getElementById("diag-clear");n&&(n.style.display=e==="frontend"?"":"none"),N=[],(e==="server"||e==="sessions")&&(Fe()||ht(),e==="server"?(xn(),ge("mt")):e==="sessions"&&(wn(),b&&(yt(b),ge("mthost",b)))),he()}function $i(){let e=document.getElementById("diag-level-filter");e&&e.addEventListener("change",()=>{St=parseInt(e.value,10),he()});let t=document.getElementById("diag-search");if(t){let r=null;t.addEventListener("input",()=>{r&&clearTimeout(r),r=window.setTimeout(()=>{K=t.value.toLowerCase(),he()},200)})}let n=document.getElementById("diag-live-tail");n&&n.addEventListener("change",()=>{Ue=n.checked,Ue&&In()});let o=document.getElementById("diag-copy-all");o&&o.addEventListener("click",Gi);let s=document.getElementById("diag-clear");s&&s.addEventListener("click",async()=>{A==="frontend"&&(await Ht(),N=[],he())});let i=document.getElementById("diag-session-picker");i&&i.addEventListener("change",()=>{b&&Tn(b),b=i.value||null,N=[],b&&(yt(b),ge("mthost",b)),he()})}function zi(e){(A==="server"&&e.source==="mt"||A==="sessions"&&e.source==="mthost"&&e.sessionId===b)&&Ls(e)}function Ls(e){if(As(e.level)>St)return;let n={timestamp:e.timestamp,level:e.level,module:e.source==="mt"?"mt":`mthost-${e.sessionId?.slice(0,4)||""}`,message:e.message};K&&!Ms(n)||(N.push(n),Cn(),Ue&&In())}function qi(e){N=e.entries.filter(n=>{if(As(n.level)>St)return!1;let s={timestamp:n.timestamp,level:n.level,module:n.source==="mt"?"mt":`mthost-${n.sessionId?.slice(0,4)||""}`,message:n.message};return!K||Ms(s)}).map(n=>({timestamp:n.timestamp,level:n.level,module:n.source==="mt"?"mt":`mthost-${n.sessionId?.slice(0,4)||""}`,message:n.message})),Cn(),Ue&&In()}function Vi(e){Is=e.sessions,Xi()}function Xi(){let e=document.getElementById("diag-session-picker");if(!e)return;let t=e.value;e.innerHTML='<option value="">Select session...</option>',Is.forEach(n=>{let o=document.createElement("option");o.value=n.id,o.textContent=`${n.id} ${n.active?"(active)":""} - ${n.logCount} entries`,n.id===t&&(o.selected=!0),e.appendChild(o)})}function As(e){switch(e.toLowerCase()){case"exception":return 0;case"error":return 1;case"warn":return 2;case"info":return 3;case"verbose":return 4;default:return 4}}function Ms(e){return e.message.toLowerCase().includes(K)||e.module.toLowerCase().includes(K)}function ji(){ws||(ws=window.setInterval(()=>{Ue&&A==="frontend"&&he()},1e3))}async function he(){let e=document.getElementById("diag-log-content"),t=document.getElementById("diag-entry-count");if(e){if(A==="frontend")try{let n=await Dt({minLevel:St,limit:500}),o=n;K&&(o=n.filter(s=>s.message.toLowerCase().includes(K)||s.module.toLowerCase().includes(K))),N=o.reverse().map(s=>({timestamp:new Date(s.timestamp).toISOString(),level:we[s.level].toLowerCase(),module:s.module,message:s.message}))}catch{N=[]}else if(A==="server"){if(!Fe()){e.innerHTML='<div class="diag-connecting">Connecting to server...</div>',t&&(t.textContent="0 entries");return}}else if(A==="sessions"){if(!b){e.innerHTML='<div class="diag-empty">Select a session to view logs</div>',t&&(t.textContent="0 entries");return}if(!Fe()){e.innerHTML='<div class="diag-connecting">Connecting to server...</div>',t&&(t.textContent="0 entries");return}}Cn()}}function Cn(){let e=document.getElementById("diag-log-content"),t=document.getElementById("diag-entry-count");if(e){if(N.length===0){e.innerHTML='<div class="diag-empty">No log entries</div>',t&&(t.textContent="0 entries");return}e.innerHTML=N.map(Ki).join(""),t&&(t.textContent=`${N.length} entries`)}}function Ki(e){let t=e.timestamp.slice(11,23),n=e.level.toLowerCase(),o=Cs(e.message),s=Cs(e.module);return`<div class="diag-log-entry">
    <span class="diag-log-time">${t}</span>
    <span class="diag-log-level ${n}">${e.level.toUpperCase()}</span>
    <span class="diag-log-module">${s}</span>
    <span class="diag-log-message">${o}</span>
  </div>`}function Cs(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function In(){let e=document.getElementById("diag-log-content");e&&(e.scrollTop=e.scrollHeight)}async function Gi(){let t=N.map(n=>`[${n.timestamp}] [${n.level.toUpperCase()}] [${n.module}] ${n.message}`).join(`
`);try{await navigator.clipboard.writeText(t)}catch{let n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}}S();k();R();var We=B("main");window.mmDebug={get terminals(){return u},get activeId(){return c},get settings(){return f}};jn();document.addEventListener("DOMContentLoaded",Yi);async function Yi(){await Ot(),Ut(3),Wt(!1),We.info(()=>"MidTerm frontend initializing"),Un(),$o(),zo();let e=No();Je(e),Ji(),tt(),nt(),jt(),mn(),sr(),vn(),Ao(),ho(),yo(),nr(),or(),Pe(),Ne(),ms(),er(),Ln(),Zi(),We.info(()=>"MidTerm frontend initialized")}function Ji(){so({destroyTerminalForSession:Qt,applyTerminalScaling:ae,createTerminalForSession:Zt,renderSessionList:de,updateEmptyState:lt,selectSession:bt,updateMobileTitle:ue,renderUpdatePanel:hn}),ao({applyTerminalScaling:ae}),go({applyReceivedSettings:rn}),Bo({sendInput:ot,showBellNotification:tr,requestBufferRefresh:uo}),So({sendInput:ot,pasteToTerminal:en}),vo({sendResize:(e,t)=>{co(e,t.cols,t.rows)}}),_o({onSelect:bt,onDelete:Rs,onRename:Qi,onResize:Z,onCloseSidebar:ct})}function Zi(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(te||tt(),ne||nt())})}function An(){let e=a.terminalsArea?.getBoundingClientRect(),t=f?.defaultCols??120,n=f?.defaultRows??30;if(e&&e.width>100&&e.height>100){let i=f?.fontSize??14,r=i*Rn,l=i*Bn,d=e.width-ee,m=e.height-ee,h=Math.floor(d/r),g=Math.floor(m/l);h>$e&&g>ze&&(t=Math.min(h,qe),n=Math.min(g,Ve))}let o="pending-"+crypto.randomUUID(),s={id:o,name:null,terminalTitle:null,shellType:"Loading...",cols:t,rows:n};p.push(s),Y.add(o),de(),ct(),fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Cols:t,Rows:n})}).then(i=>i.json()).then(i=>{Y.delete(o);let r=p.findIndex(l=>l.id===o);r>=0&&p.splice(r,1),oe.add(i.id),bt(i.id)}).catch(i=>{Y.delete(o);let r=p.findIndex(l=>l.id===o);r>=0&&(p.splice(r,1),de(),lt()),We.error(()=>`Failed to create session: ${i}`)})}function bt(e,t){t?.closeSettingsPanel!==!1&&pt(),u.forEach(i=>{i.container.classList.add("hidden")}),xe(e),Vt(e);let n=p.find(i=>i.id===e),o=Zt(e,n),s=oe.has(e);o.container.classList.remove("hidden"),requestAnimationFrame(()=>{o.terminal.focus(),Po(e),s&&oe.delete(e)}),de(),ue(),a.emptyState?.classList.add("hidden")}function Rs(e){Qt(e);let t=p.findIndex(n=>n.id===e);if(t>=0&&p.splice(t,1),c===e){xe(null);let n=p[0];n&&bt(n.id)}de(),lt(),ue(),fetch("/api/sessions/"+e,{method:"DELETE"}).catch(n=>{We.error(()=>`Failed to delete session ${e}: ${n}`)})}function Bs(e,t){let n=p.find(i=>i.id===e);if(!n)return;let o=(t||"").trim(),s=o===""||o===n.shellType?null:o;fetch("/api/sessions/"+e+"/name",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})}).then(()=>{n.manuallyNamed=!0}).catch(i=>{We.error(()=>`Failed to rename session ${e}: ${i}`)})}function Qi(e){let t=a.sessionList?.querySelector(`[data-session-id="${e}"]`);if(!t)return;let n=t.querySelector(".session-title");if(!n)return;let o=p.find(l=>l.id===e),s=o?o.name||o.shellType:"",i=document.createElement("input");i.type="text",i.className="session-rename-input",i.value=s;function r(){Bs(e,i.value),i.replaceWith(n)}i.addEventListener("blur",r),i.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),i.blur()):l.key==="Escape"&&(l.preventDefault(),i.replaceWith(n))}),n.replaceWith(i),i.focus(),i.select()}function ks(e){let t=p.find(s=>s.id===e);if(!t)return;let n=t.name||t.shellType,o=prompt("Rename terminal:",n);o!==null&&Bs(e,o)}function er(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().catch(()=>{})}function tr(e){if(!f)return;let t=f.bellStyle||"notification",n=p.find(s=>s.id===e),o=n?nn(n):"Terminal";if((t==="notification"||t==="both")&&Notification.permission==="granted"&&document.hidden&&new Notification("Bell: "+o,{body:"Terminal bell triggered",icon:"/favicon.ico"}),t==="visual"||t==="both"){let s=u.get(e);s&&(s.container.classList.add("bell-flash"),setTimeout(()=>{s.container.classList.remove("bell-flash")},200))}}function nr(){fetch("/api/version").then(e=>e.text()).then(e=>{let t=e.replace(/[+-][a-f0-9]+$/i,""),n=document.getElementById("app-version");n&&(n.textContent="v"+t)}).catch(()=>{})}function or(){fetch("/api/networks").then(e=>e.json()).then(e=>{let t=document.getElementById("network-list");if(!t)return;let n=location.protocol,o=location.port;t.innerHTML=e.map(s=>{let i=n+"//"+s.ip+":"+o;return'<div class="network-item"><span class="network-name" title="'+$(s.name)+'">'+$(s.name)+'</span><a class="network-url" href="'+i+'" target="_blank">'+$(s.ip)+":"+o+"</a></div>"}).join("")}).catch(()=>{})}function sr(){v("btn-new-session",An),v("btn-new-session-mobile",An),v("btn-create-terminal",An),v("btn-hamburger",Fo),v("btn-collapse-sidebar",Uo),v("btn-expand-sidebar",Wo),a.sidebarOverlay&&a.sidebarOverlay.addEventListener("click",ct),v("btn-ctrlc-mobile",()=>{c&&ot(c,"")}),v("btn-resize-mobile",()=>{c&&Z(c)}),v("btn-resize-titlebar",()=>{c&&Z(c)}),v("btn-rename-mobile",()=>{c&&ks(c)}),v("btn-rename-titlebar",()=>{c&&ks(c)}),v("btn-close-mobile",()=>{c&&Rs(c)}),a.settingsBtn&&a.settingsBtn.addEventListener("click",dn),v("update-btn",ft),v("btn-check-updates",us),v("btn-apply-update",ft),v("btn-show-changelog",fs),v("btn-close-changelog",Sn);let e=document.querySelector("#changelog-modal .modal-backdrop");e&&e.addEventListener("click",Sn),Promise.resolve().then(()=>(pn(),ns)).then(t=>{t.bindSettingsAutoSave()})}})();
