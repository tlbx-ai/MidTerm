{
  "version": 3,
  "sources": ["../../src/ts/constants.ts", "../../src/ts/state.ts", "../../src/ts/utils/dom.ts", "../../src/ts/utils/cookies.ts", "../../src/ts/utils/protocol.ts", "../../src/ts/utils/reconnect.ts", "../../src/ts/utils/index.ts", "../../src/ts/modules/settings/persistence.ts", "../../src/ts/modules/settings/panel.ts", "../../src/ts/modules/settings/index.ts", "../../src/ts/modules/theming/themes.ts", "../../src/ts/modules/logging/types.ts", "../../src/ts/modules/logging/storage.ts", "../../src/ts/modules/logging/logger.ts", "../../src/ts/modules/comms/stateChannel.ts", "../../src/ts/modules/comms/muxChannel.ts", "../../src/ts/modules/comms/settingsChannel.ts", "../../src/ts/modules/terminal/manager.ts", "../../src/ts/modules/terminal/scaling.ts", "../../src/ts/modules/terminal/fileDrop.ts", "../../src/ts/modules/terminal/search.ts", "../../src/ts/modules/sidebar/sessionList.ts", "../../src/ts/modules/sidebar/collapse.ts", "../../src/ts/main.ts", "../../src/ts/modules/auth/status.ts", "../../src/ts/modules/auth/password.ts", "../../src/ts/modules/updating/checker.ts", "../../src/ts/modules/updating/changelog.ts", "../../src/ts/modules/diagnostics/logsChannel.ts", "../../src/ts/modules/diagnostics/panel.ts"],
  "sourcesContent": ["/**\r\n * Constants\r\n *\r\n * Protocol constants, theme definitions, and configuration values.\r\n */\r\n\r\nimport type { TerminalTheme, ThemeName } from './types';\r\n\r\n// =============================================================================\r\n// Build Version (injected at compile time via esbuild --define)\r\n// =============================================================================\r\n\r\n/** Version injected at build time - DO NOT MODIFY, replaced by esbuild */\r\ndeclare const BUILD_VERSION: string;\r\n\r\n/** The version this JavaScript was compiled for */\r\nexport const JS_BUILD_VERSION: string = typeof BUILD_VERSION !== 'undefined' ? BUILD_VERSION : 'dev';\r\n\r\n// =============================================================================\r\n// Mux Protocol Constants\r\n// =============================================================================\r\n\r\n/** Mux protocol header size (1 byte type + 8 byte session ID) */\r\nexport const MUX_HEADER_SIZE = 9;\r\n\r\n/** Mux protocol message types */\r\nexport const MUX_TYPE_OUTPUT = 0x01;  // Server -> Client: Terminal output (includes dimensions)\r\nexport const MUX_TYPE_INPUT = 0x02;   // Client -> Server: Terminal input\r\nexport const MUX_TYPE_RESIZE = 0x03;  // Client -> Server: Terminal resize\r\nexport const MUX_TYPE_RESYNC = 0x05;  // Server -> Client: Clear terminals, buffer refresh follows\r\nexport const MUX_TYPE_BUFFER_REQUEST = 0x06; // Client -> Server: Request buffer refresh\r\nexport const MUX_TYPE_COMPRESSED_OUTPUT = 0x07; // Server -> Client: GZip compressed output\r\nexport const MUX_TYPE_ACTIVE_HINT = 0x08; // Client -> Server: Hint which session is active\r\n\r\n// =============================================================================\r\n// Terminal Themes\r\n// =============================================================================\r\n\r\n/** Terminal color themes */\r\nexport const THEMES: Record<ThemeName, TerminalTheme> = {\r\n  dark: {\r\n    background: '#06060E',\r\n    foreground: '#DCDCF5',\r\n    cursor: '#DCDCF5',\r\n    cursorAccent: '#06060E',\r\n    selectionBackground: '#283457'\r\n  },\r\n  light: {\r\n    background: '#D5D6DB',\r\n    foreground: '#343B58',\r\n    cursor: '#343B58',\r\n    cursorAccent: '#D5D6DB',\r\n    selectionBackground: '#9FA0A5'\r\n  },\r\n  solarizedDark: {\r\n    background: '#002B36',\r\n    foreground: '#839496',\r\n    cursor: '#839496',\r\n    cursorAccent: '#002B36',\r\n    selectionBackground: '#073642'\r\n  },\r\n  solarizedLight: {\r\n    background: '#FDF6E3',\r\n    foreground: '#657B83',\r\n    cursor: '#657B83',\r\n    cursorAccent: '#FDF6E3',\r\n    selectionBackground: '#EEE8D5'\r\n  }\r\n};\r\n\r\n// =============================================================================\r\n// Default Settings\r\n// =============================================================================\r\n\r\n/** Default terminal settings */\r\nexport const DEFAULT_SETTINGS = {\r\n  fontSize: 14,\r\n  scrollbackLines: 10000,\r\n  cursorStyle: 'bar' as const,\r\n  cursorBlink: true,\r\n  theme: 'dark' as ThemeName,\r\n  bellStyle: 'notification' as const,\r\n  copyOnSelect: false,\r\n  rightClickPaste: true,\r\n  clipboardShortcuts: 'auto' as const\r\n};\r\n\r\n// =============================================================================\r\n// WebSocket Configuration\r\n// =============================================================================\r\n\r\n/** Initial reconnect delay in milliseconds */\r\nexport const INITIAL_RECONNECT_DELAY = 1000;\r\n\r\n/** Maximum reconnect delay in milliseconds */\r\nexport const MAX_RECONNECT_DELAY = 30000;\r\n\r\n// =============================================================================\r\n// Terminal Rendering Constants\r\n// =============================================================================\r\n\r\n/** Terminal font stack for monospace rendering */\r\nexport const TERMINAL_FONT_STACK = \"'Cascadia Code', 'Cascadia Mono', Consolas, 'Courier New', monospace\";\r\n\r\n/** Character width as ratio of font size (empirical for monospace fonts) */\r\nexport const FONT_CHAR_WIDTH_RATIO = 0.6;\r\n\r\n/** Line height as ratio of font size */\r\nexport const FONT_LINE_HEIGHT_RATIO = 1.2;\r\n\r\n/** Padding around terminal content in pixels */\r\nexport const TERMINAL_PADDING = 8;\r\n\r\n/** Minimum terminal columns */\r\nexport const MIN_TERMINAL_COLS = 10;\r\n\r\n/** Minimum terminal rows */\r\nexport const MIN_TERMINAL_ROWS = 5;\r\n\r\n/** Maximum terminal columns */\r\nexport const MAX_TERMINAL_COLS = 300;\r\n\r\n/** Maximum terminal rows */\r\nexport const MAX_TERMINAL_ROWS = 100;\r\n\r\n/** Maximum frame dimension for validation */\r\nexport const MAX_FRAME_DIMENSION = 500;\r\n\r\n/** Mobile breakpoint in pixels */\r\nexport const MOBILE_BREAKPOINT = 768;\r\n\r\n// =============================================================================\r\n// Icon Font (midFont) - Unicode characters\r\n// =============================================================================\r\n\r\nexport const ICONS = {\r\n  collapse: '\\ue913',      // keyboard_arrow_up\r\n  expand: '\\ue910',        // keyboard_arrow_down\r\n  settings: '\\ue991',      // wrench\r\n  new: '\\uea81',           // terminal\r\n  resize: '\\ue989',        // enlarge\r\n  rename: '\\ue91f',        // drive_file_rename_outline\r\n  close: '\\ue909',         // bomb\r\n  menu: '\\ue919',          // menu (hamburger)\r\n  update: '\\ue91b',        // arrow_right\r\n  searchPrev: '\\ue913',    // keyboard_arrow_up\r\n  searchNext: '\\ue910',    // keyboard_arrow_down\r\n  save: '\\ue90f',          // save\r\n  interrupt: '\\ue9b5',     // power\r\n  terminal: '\\uea81',      // terminal\r\n  warning: '\\uea07',       // warning\r\n} as const;\r\n\r\n/** Creates an icon span element */\r\nexport function icon(name: keyof typeof ICONS): string {\r\n  return `<span class=\"icon\">${ICONS[name]}</span>`;\r\n}\r\n", "/**\r\n * Application State\r\n *\r\n * Centralized state management for the application.\r\n * Replaces the global variables from the original JavaScript.\r\n */\r\n\r\nimport type {\r\n  Session,\r\n  TerminalState,\r\n  Settings,\r\n  UpdateInfo,\r\n  AuthStatus,\r\n  DOMElements\r\n} from './types';\r\n\r\n// =============================================================================\r\n// State Store\r\n// =============================================================================\r\n\r\n/** Sessions from server */\r\nexport let sessions: Session[] = [];\r\n\r\n/** Currently active session ID */\r\nexport let activeSessionId: string | null = null;\r\n\r\n/** User settings from server */\r\nexport let currentSettings: Settings | null = null;\r\n\r\n/** Update info from server */\r\nexport let updateInfo: UpdateInfo | null = null;\r\n\r\n/** Auth status from server */\r\nexport let authStatus: AuthStatus | null = null;\r\n\r\n// =============================================================================\r\n// UI State\r\n// =============================================================================\r\n\r\n/** Settings panel visibility */\r\nexport let settingsOpen = false;\r\n\r\n/** Mobile sidebar visibility */\r\nexport let sidebarOpen = false;\r\n\r\n/** Desktop sidebar collapsed state */\r\nexport let sidebarCollapsed = false;\r\n\r\n// =============================================================================\r\n// WebSocket State\r\n// =============================================================================\r\n\r\n/** State WebSocket connection */\r\nexport let stateWs: WebSocket | null = null;\r\n\r\n/** State WebSocket reconnect timer */\r\nexport let stateReconnectTimer: number | undefined;\r\n\r\n/** State WebSocket reconnect delay */\r\nexport let stateReconnectDelay = 1000;\r\n\r\n/** State WebSocket connected flag */\r\nexport let stateWsConnected = false;\r\n\r\n/** Mux WebSocket connection */\r\nexport let muxWs: WebSocket | null = null;\r\n\r\n/** Mux WebSocket reconnect timer */\r\nexport let muxReconnectTimer: number | undefined;\r\n\r\n/** Mux WebSocket reconnect delay */\r\nexport let muxReconnectDelay = 1000;\r\n\r\n/** Mux WebSocket connected flag */\r\nexport let muxWsConnected = false;\r\n\r\n/** Tracks if mux WebSocket has ever connected (for reconnect detection) */\r\nexport let muxHasConnected = false;\r\n\r\n// =============================================================================\r\n// Terminal State\r\n// =============================================================================\r\n\r\n/** Windows build number for ConPTY configuration (null on non-Windows) */\r\nexport let windowsBuildNumber: number | null = null;\r\n\r\n/** Per-session terminal state */\r\nexport const sessionTerminals = new Map<string, TerminalState>();\r\n\r\n/** Sessions created in this browser session (use WebSocket buffering) */\r\nexport const newlyCreatedSessions = new Set<string>();\r\n\r\n/** Pending sessions being created (for optimistic UI) */\r\nexport const pendingSessions = new Set<string>();\r\n\r\n/** Buffer WebSocket output frames for terminals not yet opened */\r\nexport const pendingOutputFrames = new Map<string, Uint8Array[]>();\r\n\r\n/** Font loading promise */\r\nexport let fontsReadyPromise: Promise<void> | null = null;\r\n\r\n// =============================================================================\r\n// DOM Element Cache\r\n// =============================================================================\r\n\r\n/** Cached DOM elements */\r\nexport const dom: DOMElements = {\r\n  sessionList: null,\r\n  sessionCount: null,\r\n  terminalsArea: null,\r\n  emptyState: null,\r\n  mobileTitle: null,\r\n  topbarActions: null,\r\n  app: null,\r\n  sidebarOverlay: null,\r\n  settingsView: null,\r\n  settingsBtn: null,\r\n  titleBarCustom: null,\r\n  titleBarTerminal: null,\r\n  titleBarSeparator: null\r\n};\r\n\r\n// =============================================================================\r\n// State Setters\r\n// =============================================================================\r\n\r\nexport function setSessions(newSessions: Session[]): void {\r\n  sessions = newSessions;\r\n}\r\n\r\nexport function setActiveSessionId(id: string | null): void {\r\n  activeSessionId = id;\r\n}\r\n\r\nexport function setCurrentSettings(settings: Settings | null): void {\r\n  currentSettings = settings;\r\n}\r\n\r\nexport function setUpdateInfo(info: UpdateInfo | null): void {\r\n  updateInfo = info;\r\n}\r\n\r\nexport function setAuthStatus(status: AuthStatus | null): void {\r\n  authStatus = status;\r\n}\r\n\r\nexport function setSettingsOpen(open: boolean): void {\r\n  settingsOpen = open;\r\n}\r\n\r\nexport function setSidebarOpen(open: boolean): void {\r\n  sidebarOpen = open;\r\n}\r\n\r\nexport function setSidebarCollapsed(collapsed: boolean): void {\r\n  sidebarCollapsed = collapsed;\r\n}\r\n\r\nexport function setStateWs(ws: WebSocket | null): void {\r\n  stateWs = ws;\r\n}\r\n\r\nexport function setStateReconnectTimer(timer: number | undefined): void {\r\n  stateReconnectTimer = timer;\r\n}\r\n\r\nexport function setStateReconnectDelay(delay: number): void {\r\n  stateReconnectDelay = delay;\r\n}\r\n\r\nexport function setStateWsConnected(connected: boolean): void {\r\n  stateWsConnected = connected;\r\n}\r\n\r\nexport function setMuxWs(ws: WebSocket | null): void {\r\n  muxWs = ws;\r\n}\r\n\r\nexport function setMuxReconnectTimer(timer: number | undefined): void {\r\n  muxReconnectTimer = timer;\r\n}\r\n\r\nexport function setMuxReconnectDelay(delay: number): void {\r\n  muxReconnectDelay = delay;\r\n}\r\n\r\nexport function setMuxWsConnected(connected: boolean): void {\r\n  muxWsConnected = connected;\r\n}\r\n\r\nexport function setMuxHasConnected(connected: boolean): void {\r\n  muxHasConnected = connected;\r\n}\r\n\r\nexport function setFontsReadyPromise(promise: Promise<void>): void {\r\n  fontsReadyPromise = promise;\r\n}\r\n\r\nexport function setWindowsBuildNumber(build: number | null): void {\r\n  windowsBuildNumber = build;\r\n}\r\n\r\n// =============================================================================\r\n// DOM Element Cache Initialization\r\n// =============================================================================\r\n\r\n/**\r\n * Cache DOM elements for quick access\r\n */\r\nexport function cacheDOMElements(): void {\r\n  dom.sessionList = document.getElementById('session-list');\r\n  dom.sessionCount = document.getElementById('session-count');\r\n  dom.terminalsArea = document.querySelector('.terminals-area');\r\n  dom.emptyState = document.getElementById('empty-state');\r\n  dom.mobileTitle = document.getElementById('mobile-title');\r\n  dom.topbarActions = document.getElementById('topbar-actions');\r\n  dom.app = document.getElementById('app');\r\n  dom.sidebarOverlay = document.getElementById('sidebar-overlay');\r\n  dom.settingsView = document.getElementById('settings-view');\r\n  dom.settingsBtn = document.getElementById('btn-settings');\r\n  dom.titleBarCustom = document.getElementById('title-bar-custom');\r\n  dom.titleBarTerminal = document.getElementById('title-bar-terminal');\r\n  dom.titleBarSeparator = document.getElementById('title-bar-separator');\r\n}\r\n", "/**\r\n * DOM Utilities\r\n *\r\n * Helper functions for DOM manipulation and event handling.\r\n */\r\n\r\n/**\r\n * Escape HTML special characters to prevent XSS\r\n */\r\nexport function escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Bind a click event to an element by ID\r\n */\r\nexport function bindClick(id: string, handler: (e: MouseEvent) => void): void {\r\n  const el = document.getElementById(id);\r\n  if (el) {\r\n    el.addEventListener('click', handler);\r\n  }\r\n}\r\n\r\n/**\r\n * Create a debounced version of a function\r\n */\r\nexport function debounce<T extends (...args: unknown[]) => void>(\r\n  fn: T,\r\n  delay: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeoutId: number | undefined;\r\n  return (...args: Parameters<T>) => {\r\n    if (timeoutId !== undefined) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = window.setTimeout(() => fn(...args), delay);\r\n  };\r\n}\r\n\r\n/**\r\n * Format bytes as human-readable string\r\n */\r\nexport function formatBytes(bytes: number): string {\r\n  if (bytes < 1024) return bytes + ' B';\r\n  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\r\n  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\r\n}\r\n", "/**\r\n * Cookie Utilities\r\n *\r\n * Functions for reading and writing browser cookies.\r\n */\r\n\r\n/**\r\n * Get a cookie value by name\r\n */\r\nexport function getCookie(name: string): string | null {\r\n  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));\r\n  const value = match?.[2];\r\n  return value !== undefined ? decodeURIComponent(value) : null;\r\n}\r\n\r\n/**\r\n * Set a cookie value\r\n */\r\nexport function setCookie(name: string, value: string, days: number = 365): void {\r\n  const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();\r\n  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;\r\n}\r\n\r\n/**\r\n * Delete a cookie by name\r\n */\r\nexport function deleteCookie(name: string): void {\r\n  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;\r\n}\r\n\r\n/**\r\n * Detect clipboard shortcut style based on platform\r\n */\r\nexport function getClipboardStyle(setting: 'auto' | 'windows' | 'unix'): 'windows' | 'unix' {\r\n  if (setting !== 'auto') return setting;\r\n  const ua = navigator.userAgent || '';\r\n  return /Windows|Win32|Win64/i.test(ua) ? 'windows' : 'unix';\r\n}\r\n", "/**\r\n * Protocol Utilities\r\n *\r\n * Binary protocol helpers for mux WebSocket communication.\r\n */\r\n\r\nimport { MAX_FRAME_DIMENSION } from '../constants';\r\n\r\n/** Parsed output frame from server */\r\nexport interface OutputFrame {\r\n  cols: number;\r\n  rows: number;\r\n  data: Uint8Array;\r\n  valid: boolean;\r\n}\r\n\r\n/**\r\n * Parse output frame from binary payload.\r\n * Frame format: [cols:2][rows:2][data]\r\n */\r\nexport function parseOutputFrame(payload: Uint8Array): OutputFrame {\r\n  const cols = (payload[0] ?? 0) | ((payload[1] ?? 0) << 8);\r\n  const rows = (payload[2] ?? 0) | ((payload[3] ?? 0) << 8);\r\n  const data = payload.slice(4);\r\n  const valid = cols > 0 && cols <= MAX_FRAME_DIMENSION && rows > 0 && rows <= MAX_FRAME_DIMENSION;\r\n\r\n  return { cols, rows, data, valid };\r\n}\r\n\r\n/**\r\n * Parse compressed output frame and decompress.\r\n * Frame format: [cols:2][rows:2][uncompressedLen:4][gzip-data...]\r\n */\r\nexport async function parseCompressedOutputFrame(payload: Uint8Array): Promise<OutputFrame> {\r\n  const cols = (payload[0] ?? 0) | ((payload[1] ?? 0) << 8);\r\n  const rows = (payload[2] ?? 0) | ((payload[3] ?? 0) << 8);\r\n  const valid = cols > 0 && cols <= MAX_FRAME_DIMENSION && rows > 0 && rows <= MAX_FRAME_DIMENSION;\r\n\r\n  // Skip uncompressedLen (bytes 4-7) - we don't need it, DecompressionStream handles sizing\r\n  const compressedData = payload.slice(8);\r\n\r\n  try {\r\n    const data = await decompressGzip(compressedData);\r\n    return { cols, rows, data, valid };\r\n  } catch (e) {\r\n    console.error('Decompression failed:', e);\r\n    return { cols, rows, data: new Uint8Array(0), valid: false };\r\n  }\r\n}\r\n\r\n/**\r\n * Decompress GZip data using native DecompressionStream API.\r\n * Uses Blob/Response pipeline to avoid backpressure deadlock.\r\n */\r\nexport async function decompressGzip(compressed: Uint8Array): Promise<Uint8Array> {\r\n  const blob = new Blob([compressed as BlobPart]);\r\n  const stream = blob.stream().pipeThrough(new DecompressionStream('gzip'));\r\n  return new Uint8Array(await new Response(stream).arrayBuffer());\r\n}\r\n", "/**\r\n * Reconnection Utilities\r\n *\r\n * Exponential backoff reconnection logic for WebSocket connections.\r\n */\r\n\r\n/**\r\n * Schedule a reconnection with exponential backoff.\r\n * Returns the timer ID for cancellation.\r\n */\r\nexport function scheduleReconnect(\r\n  currentDelay: number,\r\n  maxDelay: number,\r\n  connect: () => void,\r\n  setDelay: (delay: number) => void,\r\n  setTimer: (timer: number | undefined) => void,\r\n  existingTimer: number | undefined\r\n): void {\r\n  if (existingTimer !== undefined) {\r\n    clearTimeout(existingTimer);\r\n  }\r\n\r\n  const timer = window.setTimeout(() => {\r\n    setDelay(Math.min(currentDelay * 1.5, maxDelay));\r\n    connect();\r\n  }, currentDelay);\r\n\r\n  setTimer(timer);\r\n}\r\n", "/**\r\n * Utils Module\r\n *\r\n * Re-exports all utility functions.\r\n */\r\n\r\nexport * from './dom';\r\nexport * from './cookies';\r\nexport * from './protocol';\r\nexport * from './reconnect';\r\n", "/**\r\n * Settings Persistence Module\r\n *\r\n * Handles loading, saving, and form binding for application settings.\r\n * Communicates with the server API to persist settings changes.\r\n */\r\n\r\nimport type { Settings, ThemeName, TerminalState, HealthResponse } from '../../types';\r\nimport { THEMES, TERMINAL_FONT_STACK, JS_BUILD_VERSION } from '../../constants';\r\nimport { currentSettings, setCurrentSettings, dom, sessionTerminals, settingsOpen } from '../../state';\r\nimport { setCookie } from '../../utils';\r\n\r\n/**\r\n * Set the value of a form element by ID\r\n */\r\nexport function setElementValue(id: string, value: string | number): void {\r\n  const el = document.getElementById(id) as HTMLInputElement | HTMLSelectElement | null;\r\n  if (el) el.value = String(value);\r\n}\r\n\r\n/**\r\n * Set the checked state of a checkbox by ID\r\n */\r\nexport function setElementChecked(id: string, checked: boolean): void {\r\n  const el = document.getElementById(id) as HTMLInputElement | null;\r\n  if (el) el.checked = checked;\r\n}\r\n\r\n/**\r\n * Get the value of a form element by ID\r\n */\r\nexport function getElementValue(id: string, defaultValue: string): string {\r\n  const el = document.getElementById(id) as HTMLInputElement | HTMLSelectElement | null;\r\n  return el ? el.value : defaultValue;\r\n}\r\n\r\n/**\r\n * Get the checked state of a checkbox by ID\r\n */\r\nexport function getElementChecked(id: string): boolean {\r\n  const el = document.getElementById(id) as HTMLInputElement | null;\r\n  return el ? el.checked : false;\r\n}\r\n\r\n/**\r\n * Populate version info in the about section\r\n */\r\nexport function populateVersionInfo(serverVersion: string | null, hostVersion: string | null, frontendVersion: string): void {\r\n  // Strip git hash suffix but preserve (DEV) indicator\r\n  const formatVersion = (v: string) => 'v' + v.replace(/[+-][a-f0-9]+$/i, '');\r\n\r\n  const serverEl = document.getElementById('version-server');\r\n  if (serverEl && serverVersion) {\r\n    serverEl.textContent = formatVersion(serverVersion);\r\n  }\r\n\r\n  const frontendEl = document.getElementById('version-frontend');\r\n  if (frontendEl) {\r\n    frontendEl.textContent = frontendVersion === 'dev' ? 'dev' : formatVersion(frontendVersion);\r\n  }\r\n\r\n  const hostEl = document.getElementById('version-host');\r\n  if (hostEl) {\r\n    hostEl.textContent = hostVersion ? formatVersion(hostVersion) : '-';\r\n  }\r\n}\r\n\r\n/**\r\n * Populate user dropdown for run-as-user selection\r\n */\r\nexport function populateUserDropdown(\r\n  users: Array<{ username: string }>,\r\n  selectedUser: string | null\r\n): void {\r\n  const select = document.getElementById('setting-run-as-user') as HTMLSelectElement | null;\r\n  if (!select) return;\r\n\r\n  select.innerHTML = '<option value=\"\">Process Owner (default)</option>';\r\n\r\n  users.forEach((user) => {\r\n    const option = document.createElement('option');\r\n    option.value = user.username;\r\n    option.textContent = user.username;\r\n    if (user.username === selectedUser) {\r\n      option.selected = true;\r\n    }\r\n    select.appendChild(option);\r\n  });\r\n}\r\n\r\n/**\r\n * Populate the settings form with current settings\r\n */\r\nexport function populateSettingsForm(settings: Settings): void {\r\n  setElementValue('setting-default-shell', settings.defaultShell || 'Pwsh');\r\n  setElementValue('setting-working-dir', settings.defaultWorkingDirectory || '');\r\n  setElementValue('setting-font-size', settings.fontSize || 14);\r\n  setElementValue('setting-font-family', settings.fontFamily || 'Cascadia Code');\r\n  setElementValue('setting-cursor-style', settings.cursorStyle || 'bar');\r\n  setElementChecked('setting-cursor-blink', settings.cursorBlink !== false);\r\n  setElementValue('setting-theme', settings.theme || 'dark');\r\n  setElementValue('setting-contrast', String(settings.minimumContrastRatio || 1));\r\n  setElementValue('setting-scrollback', settings.scrollbackLines || 10000);\r\n  setElementValue('setting-bell-style', settings.bellStyle || 'notification');\r\n  setElementChecked('setting-copy-on-select', settings.copyOnSelect === true);\r\n  setElementChecked('setting-right-click-paste', settings.rightClickPaste !== false);\r\n  setElementValue('setting-clipboard-shortcuts', settings.clipboardShortcuts || 'auto');\r\n  setElementChecked('setting-smooth-scrolling', settings.smoothScrolling === true);\r\n  setElementChecked('setting-webgl', settings.useWebGL !== false);\r\n  setElementValue('setting-run-as-user', settings.runAsUser || '');\r\n  setElementValue('setting-log-level', settings.logLevel || 'warn');\r\n}\r\n\r\n/**\r\n * Fetch settings, users, version, and health from server and populate the form\r\n */\r\nexport async function fetchSettings(): Promise<void> {\r\n  try {\r\n    const [settings, users, version, health] = await Promise.all([\r\n      fetch('/api/settings').then((r) => r.json() as Promise<Settings>),\r\n      fetch('/api/users')\r\n        .then((r) => r.json() as Promise<Array<{ username: string }>>)\r\n        .catch(() => [] as Array<{ username: string }>),\r\n      fetch('/api/version')\r\n        .then((r) => r.text())\r\n        .catch(() => null),\r\n      fetch('/api/health')\r\n        .then((r) => r.json() as Promise<HealthResponse>)\r\n        .catch(() => ({ status: '', memoryMB: 0, uptime: '', sessionCount: 0, ttyHostVersion: undefined }))\r\n    ]);\r\n\r\n    setCurrentSettings(settings);\r\n    populateUserDropdown(users, settings.runAsUser);\r\n    populateSettingsForm(settings);\r\n    populateVersionInfo(version, health.ttyHostVersion ?? null, JS_BUILD_VERSION);\r\n\r\n    // Apply settings to any terminals that were created before settings loaded\r\n    applySettingsToTerminals();\r\n  } catch (e) {\r\n    console.error('Error fetching settings:', e);\r\n  }\r\n}\r\n\r\n/**\r\n * Apply current settings to all open terminals\r\n */\r\nexport function applySettingsToTerminals(): void {\r\n  if (!currentSettings) return;\r\n  const settings = currentSettings;\r\n\r\n  const theme = THEMES[settings.theme] || THEMES.dark;\r\n  const fontFamily = `'${settings.fontFamily || 'Cascadia Code'}', ${TERMINAL_FONT_STACK}`;\r\n\r\n  sessionTerminals.forEach((state: TerminalState) => {\r\n    state.terminal.options.cursorBlink = settings.cursorBlink;\r\n    state.terminal.options.cursorStyle = settings.cursorStyle;\r\n    state.terminal.options.fontFamily = fontFamily;\r\n    state.terminal.options.fontSize = settings.fontSize;\r\n    state.terminal.options.theme = theme;\r\n    state.terminal.options.minimumContrastRatio = settings.minimumContrastRatio;\r\n    state.terminal.options.smoothScrollDuration = settings.smoothScrolling ? 150 : 0;\r\n\r\n    // Trigger re-render after font changes\r\n    if (state.opened) {\r\n      try {\r\n        const dims = state.fitAddon.proposeDimensions();\r\n        if (dims?.cols && dims?.rows) {\r\n          state.fitAddon.fit();\r\n        }\r\n      } catch {\r\n        // FitAddon may fail if terminal render service isn't initialized\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Apply settings received from WebSocket sync.\r\n * Updates the form if settings panel is open, applies to terminals, and updates theme.\r\n */\r\nexport function applyReceivedSettings(settings: Settings): void {\r\n  if (settingsOpen) {\r\n    populateSettingsForm(settings);\r\n  }\r\n\r\n  const theme = THEMES[settings.theme] || THEMES.dark;\r\n  document.documentElement.style.setProperty('--terminal-bg', theme.background);\r\n  setCookie('mm-theme', settings.theme);\r\n\r\n  applySettingsToTerminals();\r\n}\r\n\r\n/**\r\n * Save all settings to the server\r\n */\r\nexport function saveAllSettings(): void {\r\n  const runAsUserValue = getElementValue('setting-run-as-user', '');\r\n  const settings: Settings = {\r\n    defaultShell: getElementValue('setting-default-shell', 'Pwsh'),\r\n    defaultCols: currentSettings?.defaultCols ?? 120,\r\n    defaultRows: currentSettings?.defaultRows ?? 30,\r\n    defaultWorkingDirectory: getElementValue('setting-working-dir', ''),\r\n    fontSize: parseInt(getElementValue('setting-font-size', '14'), 10) || 14,\r\n    fontFamily: getElementValue('setting-font-family', 'Cascadia Code'),\r\n    cursorStyle: getElementValue('setting-cursor-style', 'bar') as Settings['cursorStyle'],\r\n    cursorBlink: getElementChecked('setting-cursor-blink'),\r\n    theme: getElementValue('setting-theme', 'dark') as ThemeName,\r\n    minimumContrastRatio: parseFloat(getElementValue('setting-contrast', '1')) || 1,\r\n    smoothScrolling: getElementChecked('setting-smooth-scrolling'),\r\n    useWebGL: getElementChecked('setting-webgl'),\r\n    scrollbackLines: parseInt(getElementValue('setting-scrollback', '10000'), 10) || 10000,\r\n    bellStyle: getElementValue('setting-bell-style', 'notification') as Settings['bellStyle'],\r\n    copyOnSelect: getElementChecked('setting-copy-on-select'),\r\n    rightClickPaste: getElementChecked('setting-right-click-paste'),\r\n    clipboardShortcuts: getElementValue(\r\n      'setting-clipboard-shortcuts',\r\n      'auto'\r\n    ) as Settings['clipboardShortcuts'],\r\n    runAsUser: runAsUserValue || null,\r\n    logLevel: getElementValue('setting-log-level', 'warn') as Settings['logLevel']\r\n  };\r\n\r\n  setCookie('mm-theme', settings.theme);\r\n\r\n  fetch('/api/settings', {\r\n    method: 'PUT',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(settings)\r\n  })\r\n    .then((r) => {\r\n      if (r.ok) {\r\n        setCurrentSettings(settings);\r\n        const theme = THEMES[settings.theme] || THEMES.dark;\r\n        document.documentElement.style.setProperty('--terminal-bg', theme.background);\r\n        applySettingsToTerminals();\r\n      }\r\n    })\r\n    .catch((e) => {\r\n      console.error('Error saving settings:', e);\r\n    });\r\n}\r\n\r\n/**\r\n * Bind auto-save behavior to settings form elements\r\n */\r\nexport function bindSettingsAutoSave(): void {\r\n  const settingsView = dom.settingsView;\r\n  if (!settingsView) return;\r\n\r\n  settingsView.querySelectorAll('select, input[type=\"checkbox\"]').forEach((el) => {\r\n    el.addEventListener('change', saveAllSettings);\r\n  });\r\n\r\n  settingsView.querySelectorAll('.text-input-wrapper').forEach((wrapper) => {\r\n    const input = wrapper.querySelector('input') as HTMLInputElement | null;\r\n    const saveBtn = wrapper.querySelector('.inline-save-btn') as HTMLButtonElement | null;\r\n    if (!input || !saveBtn) return;\r\n\r\n    let originalValue = '';\r\n\r\n    input.addEventListener('focus', () => {\r\n      originalValue = input.value;\r\n    });\r\n\r\n    input.addEventListener('input', () => {\r\n      wrapper.classList.toggle('unsaved', input.value !== originalValue);\r\n    });\r\n\r\n    saveBtn.addEventListener('click', () => {\r\n      saveAllSettings();\r\n      wrapper.classList.remove('unsaved');\r\n      originalValue = input.value;\r\n    });\r\n\r\n    input.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        e.preventDefault();\r\n        saveAllSettings();\r\n        wrapper.classList.remove('unsaved');\r\n        originalValue = input.value;\r\n      }\r\n    });\r\n  });\r\n}\r\n", "/**\r\n * Settings Panel Module\r\n *\r\n * Handles the settings panel UI visibility, system status display,\r\n * and health check functionality.\r\n */\r\n\r\nimport type { HealthResponse } from '../../types';\r\nimport {\r\n  settingsOpen,\r\n  setSettingsOpen,\r\n  activeSessionId,\r\n  sessionTerminals,\r\n  sessions,\r\n  dom,\r\n  setWindowsBuildNumber\r\n} from '../../state';\r\nimport { fetchSettings } from './persistence';\r\n\r\n/**\r\n * Close the mobile sidebar\r\n */\r\nfunction closeSidebar(): void {\r\n  const app = dom.app;\r\n  if (app) app.classList.remove('sidebar-open');\r\n}\r\n\r\n/**\r\n * Toggle the settings panel visibility\r\n */\r\nexport function toggleSettings(): void {\r\n  if (settingsOpen) {\r\n    closeSettings();\r\n  } else {\r\n    openSettings();\r\n  }\r\n}\r\n\r\n/**\r\n * Open the settings panel\r\n */\r\nexport function openSettings(): void {\r\n  setSettingsOpen(true);\r\n  if (dom.settingsBtn) dom.settingsBtn.classList.add('active');\r\n  closeSidebar();\r\n\r\n  if (activeSessionId) {\r\n    const state = sessionTerminals.get(activeSessionId);\r\n    if (state) state.container.classList.add('hidden');\r\n  }\r\n\r\n  if (dom.emptyState) dom.emptyState.classList.add('hidden');\r\n  if (dom.settingsView) dom.settingsView.classList.remove('hidden');\r\n\r\n  fetchSettings();\r\n  fetchSystemStatus();\r\n}\r\n\r\n/**\r\n * Close the settings panel\r\n */\r\nexport function closeSettings(): void {\r\n  setSettingsOpen(false);\r\n  if (dom.settingsBtn) dom.settingsBtn.classList.remove('active');\r\n  if (dom.settingsView) dom.settingsView.classList.add('hidden');\r\n\r\n  if (activeSessionId) {\r\n    const state = sessionTerminals.get(activeSessionId);\r\n    if (state) {\r\n      state.container.classList.remove('hidden');\r\n      requestAnimationFrame(() => {\r\n        state.terminal.focus();\r\n      });\r\n    }\r\n  } else if (sessions.length === 0 && dom.emptyState) {\r\n    dom.emptyState.classList.remove('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Format uptime seconds into human-readable string\r\n */\r\nexport function formatUptime(seconds: number): string {\r\n  if (seconds < 60) return seconds + 's';\r\n  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';\r\n\r\n  const hours = Math.floor(seconds / 3600);\r\n  const mins = Math.floor((seconds % 3600) / 60);\r\n\r\n  if (hours < 24) return hours + 'h ' + mins + 'm';\r\n\r\n  const days = Math.floor(hours / 24);\r\n  return days + 'd ' + (hours % 24) + 'h';\r\n}\r\n\r\n/**\r\n * Update the ttyhost version mismatch warning banner\r\n */\r\nexport function updateTtyHostWarning(health: HealthResponse): void {\r\n  let banner = document.getElementById('ttyhost-warning');\r\n\r\n  if (!banner) {\r\n    banner = document.createElement('div');\r\n    banner.id = 'ttyhost-warning';\r\n    banner.className = 'warning-banner';\r\n    const header = document.querySelector('.app-header');\r\n    if (header && header.parentNode) {\r\n      header.parentNode.insertBefore(banner, header.nextSibling);\r\n    }\r\n  }\r\n\r\n  if (health.ttyHostVersion && health.ttyHostCompatible === false) {\r\n    banner.innerHTML =\r\n      '<strong>Version mismatch:</strong> mmttyhost is ' +\r\n      health.ttyHostVersion +\r\n      ', expected ' +\r\n      health.ttyHostExpected +\r\n      '. Terminals may not work correctly. Please update mmttyhost.exe or restart the service.';\r\n    banner.style.display = 'block';\r\n  } else {\r\n    banner.style.display = 'none';\r\n  }\r\n}\r\n\r\n/**\r\n * Fetch and display system status in the settings panel\r\n */\r\nexport function fetchSystemStatus(): void {\r\n  const container = document.getElementById('system-status-content');\r\n  if (!container) return;\r\n\r\n  fetch('/api/health')\r\n    .then((response) => response.json() as Promise<HealthResponse>)\r\n    .then((health) => {\r\n      const statusClass = health.healthy ? 'status-healthy' : 'status-error';\r\n      const statusText = health.healthy ? 'Healthy' : 'Unhealthy';\r\n      const uptimeStr = formatUptime(health.uptimeSeconds || 0);\r\n\r\n      let ttyHostHtml = '';\r\n      if (health.ttyHostVersion !== null && health.ttyHostVersion !== undefined) {\r\n        const versionClass = health.ttyHostCompatible ? '' : 'status-error';\r\n        ttyHostHtml =\r\n          '<div class=\"status-detail-row\">' +\r\n          '<span class=\"detail-label\">mmttyhost</span>' +\r\n          '<span class=\"detail-value ' +\r\n          versionClass +\r\n          '\">' +\r\n          health.ttyHostVersion +\r\n          (health.ttyHostCompatible ? '' : ' expected ' + health.ttyHostExpected) +\r\n          '</span>' +\r\n          '</div>';\r\n      }\r\n\r\n      container.innerHTML =\r\n        '<div class=\"status-grid\">' +\r\n        '<div class=\"status-item\">' +\r\n        '<span class=\"status-label\">Status</span>' +\r\n        '<span class=\"status-value ' +\r\n        statusClass +\r\n        '\">' +\r\n        statusText +\r\n        '</span>' +\r\n        '</div>' +\r\n        '<div class=\"status-item\">' +\r\n        '<span class=\"status-label\">Mode</span>' +\r\n        '<span class=\"status-value\">' +\r\n        (health.mode || '') +\r\n        '</span>' +\r\n        '</div>' +\r\n        '<div class=\"status-item\">' +\r\n        '<span class=\"status-label\">Sessions</span>' +\r\n        '<span class=\"status-value\">' +\r\n        health.sessionCount +\r\n        '</span>' +\r\n        '</div>' +\r\n        '<div class=\"status-item\">' +\r\n        '<span class=\"status-label\">Uptime</span>' +\r\n        '<span class=\"status-value\">' +\r\n        uptimeStr +\r\n        '</span>' +\r\n        '</div>' +\r\n        '</div>' +\r\n        '<div class=\"status-details\">' +\r\n        '<div class=\"status-detail-row\">' +\r\n        '<span class=\"detail-label\">Platform</span>' +\r\n        '<span class=\"detail-value\">' +\r\n        (health.platform || '') +\r\n        '</span>' +\r\n        '</div>' +\r\n        '<div class=\"status-detail-row\">' +\r\n        '<span class=\"detail-label\">Process ID</span>' +\r\n        '<span class=\"detail-value\">' +\r\n        (health.webProcessId || '') +\r\n        '</span>' +\r\n        '</div>' +\r\n        ttyHostHtml +\r\n        '</div>';\r\n\r\n      updateTtyHostWarning(health);\r\n    })\r\n    .catch((err: unknown) => {\r\n      const message = err instanceof Error ? err.message : String(err);\r\n      container.innerHTML =\r\n        '<div class=\"status-error-msg\">Failed to load system status: ' + message + '</div>';\r\n    });\r\n}\r\n\r\n/**\r\n * Check system health on startup for version mismatches\r\n */\r\nexport function checkSystemHealth(): void {\r\n  fetch('/api/health')\r\n    .then((response) => response.json() as Promise<HealthResponse>)\r\n    .then((health) => {\r\n      updateTtyHostWarning(health);\r\n      if (health.windowsBuildNumber !== undefined) {\r\n        setWindowsBuildNumber(health.windowsBuildNumber);\r\n      }\r\n    })\r\n    .catch(() => {});\r\n}\r\n", "/**\r\n * Settings Module\r\n *\r\n * Re-exports settings panel and persistence functionality.\r\n */\r\n\r\nexport * from './panel';\r\nexport * from './persistence';\r\n", "/**\r\n * Theming Module\r\n *\r\n * Theme definitions and application to xterm.js terminals.\r\n */\r\n\r\nimport type { ThemeName, TerminalTheme } from '../../types';\r\nimport { THEMES } from '../../constants';\r\nimport { sessionTerminals, currentSettings } from '../../state';\r\nimport { setCookie } from '../../utils';\r\n\r\n/**\r\n * Get the current theme based on settings\r\n */\r\nexport function getCurrentTheme(): TerminalTheme {\r\n  const themeName = currentSettings?.theme || 'dark';\r\n  return THEMES[themeName] || THEMES.dark;\r\n}\r\n\r\n/**\r\n * Apply theme to all terminals\r\n */\r\nexport function applyThemeToTerminals(themeName: ThemeName): void {\r\n  const theme = THEMES[themeName];\r\n  if (!theme) return;\r\n\r\n  sessionTerminals.forEach((state) => {\r\n    state.terminal.options.theme = theme;\r\n  });\r\n}\r\n\r\n/**\r\n * Apply theme and persist to cookie\r\n */\r\nexport function setTheme(themeName: ThemeName): void {\r\n  setCookie('mm-theme', themeName);\r\n  applyThemeToTerminals(themeName);\r\n\r\n  // Update CSS variable for flash prevention\r\n  document.documentElement.style.setProperty('--terminal-bg', THEMES[themeName].background);\r\n}\r\n\r\n/**\r\n * Initialize theme from saved cookie\r\n */\r\nexport function initThemeFromCookie(): void {\r\n  const savedTheme = document.cookie.match(/mm-theme=([^;]+)/)?.[1] as ThemeName | undefined;\r\n  if (savedTheme && THEMES[savedTheme]) {\r\n    document.documentElement.style.setProperty('--terminal-bg', THEMES[savedTheme].background);\r\n  }\r\n}\r\n", "/**\r\n * Logging Types\r\n *\r\n * Type definitions for the frontend logging system.\r\n */\r\n\r\n/** Log severity levels (matching backend LogLevel enum) */\r\nexport const enum LogLevel {\r\n  Exception = 0,\r\n  Error = 1,\r\n  Warn = 2,\r\n  Info = 3,\r\n  Verbose = 4\r\n}\r\n\r\n/** Log level display names */\r\nexport const LOG_LEVEL_NAMES: Record<LogLevel, string> = {\r\n  [LogLevel.Exception]: 'EXCEPTION',\r\n  [LogLevel.Error]: 'ERROR',\r\n  [LogLevel.Warn]: 'WARN',\r\n  [LogLevel.Info]: 'INFO',\r\n  [LogLevel.Verbose]: 'VERBOSE'\r\n};\r\n\r\n/** A single log entry */\r\nexport interface LogEntry {\r\n  id?: number;\r\n  timestamp: number;\r\n  level: LogLevel;\r\n  module: string;\r\n  message: string;\r\n  data?: unknown;\r\n}\r\n\r\n/** Logger interface */\r\nexport interface Logger {\r\n  exception: (error: Error, context?: string) => void;\r\n  error: (messageFactory: () => string, data?: unknown) => void;\r\n  warn: (messageFactory: () => string, data?: unknown) => void;\r\n  info: (messageFactory: () => string, data?: unknown) => void;\r\n  verbose: (messageFactory: () => string, data?: unknown) => void;\r\n  log: (level: LogLevel, messageFactory: () => string, data?: unknown) => void;\r\n}\r\n", "/**\r\n * Log Storage Module\r\n *\r\n * IndexedDB-based storage for frontend logs with automatic\r\n * cleanup of old entries.\r\n */\r\n\r\nimport type { LogEntry } from './types';\r\nimport { LogLevel } from './types';\r\n\r\nconst DB_NAME = 'midterm-logs';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'logs';\r\nconst MAX_ENTRIES = 10000;\r\nconst MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000; // 7 days\r\n\r\nlet db: IDBDatabase | null = null;\r\nlet initPromise: Promise<IDBDatabase> | null = null;\r\n\r\n/**\r\n * Initialize the IndexedDB database\r\n */\r\nfunction initDb(): Promise<IDBDatabase> {\r\n  if (db) return Promise.resolve(db);\r\n  if (initPromise) return initPromise;\r\n\r\n  initPromise = new Promise((resolve, reject) => {\r\n    const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n    request.onerror = () => {\r\n      console.error('[LogStorage] Failed to open database:', request.error);\r\n      reject(request.error);\r\n    };\r\n\r\n    request.onsuccess = () => {\r\n      db = request.result;\r\n      resolve(db);\r\n    };\r\n\r\n    request.onupgradeneeded = (event) => {\r\n      const database = (event.target as IDBOpenDBRequest).result;\r\n\r\n      if (!database.objectStoreNames.contains(STORE_NAME)) {\r\n        const store = database.createObjectStore(STORE_NAME, {\r\n          keyPath: 'id',\r\n          autoIncrement: true\r\n        });\r\n\r\n        store.createIndex('by-timestamp', 'timestamp', { unique: false });\r\n        store.createIndex('by-level', 'level', { unique: false });\r\n        store.createIndex('by-module', 'module', { unique: false });\r\n      }\r\n    };\r\n  });\r\n\r\n  return initPromise;\r\n}\r\n\r\n/**\r\n * Write a log entry to storage\r\n */\r\nexport async function writeLogEntry(entry: Omit<LogEntry, 'id'>): Promise<void> {\r\n  try {\r\n    const database = await initDb();\r\n    const transaction = database.transaction(STORE_NAME, 'readwrite');\r\n    const store = transaction.objectStore(STORE_NAME);\r\n    store.add(entry);\r\n  } catch (error) {\r\n    // Silent fail - logging should never break the app\r\n  }\r\n}\r\n\r\n/**\r\n * Read log entries with optional filtering\r\n */\r\nexport async function readLogEntries(options?: {\r\n  minLevel?: LogLevel;\r\n  module?: string;\r\n  limit?: number;\r\n  offset?: number;\r\n}): Promise<LogEntry[]> {\r\n  const database = await initDb();\r\n  const transaction = database.transaction(STORE_NAME, 'readonly');\r\n  const store = transaction.objectStore(STORE_NAME);\r\n  const index = store.index('by-timestamp');\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const entries: LogEntry[] = [];\r\n    const limit = options?.limit ?? 1000;\r\n    let skipped = 0;\r\n    const offset = options?.offset ?? 0;\r\n\r\n    const request = index.openCursor(null, 'prev'); // newest first\r\n\r\n    request.onsuccess = () => {\r\n      const cursor = request.result;\r\n      if (!cursor || entries.length >= limit) {\r\n        resolve(entries);\r\n        return;\r\n      }\r\n\r\n      const entry = cursor.value as LogEntry;\r\n\r\n      // Apply filters\r\n      if (options?.minLevel !== undefined && entry.level > options.minLevel) {\r\n        cursor.continue();\r\n        return;\r\n      }\r\n      if (options?.module && entry.module !== options.module) {\r\n        cursor.continue();\r\n        return;\r\n      }\r\n\r\n      // Apply offset\r\n      if (skipped < offset) {\r\n        skipped++;\r\n        cursor.continue();\r\n        return;\r\n      }\r\n\r\n      entries.push(entry);\r\n      cursor.continue();\r\n    };\r\n\r\n    request.onerror = () => reject(request.error);\r\n  });\r\n}\r\n\r\n/**\r\n * Clear all log entries\r\n */\r\nexport async function clearLogs(): Promise<void> {\r\n  const database = await initDb();\r\n  const transaction = database.transaction(STORE_NAME, 'readwrite');\r\n  const store = transaction.objectStore(STORE_NAME);\r\n  store.clear();\r\n}\r\n\r\n/**\r\n * Get total log entry count\r\n */\r\nexport async function getLogCount(): Promise<number> {\r\n  const database = await initDb();\r\n  const transaction = database.transaction(STORE_NAME, 'readonly');\r\n  const store = transaction.objectStore(STORE_NAME);\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const request = store.count();\r\n    request.onsuccess = () => resolve(request.result);\r\n    request.onerror = () => reject(request.error);\r\n  });\r\n}\r\n\r\n/**\r\n * Clean up old entries to enforce limits\r\n */\r\nexport async function cleanupOldEntries(): Promise<number> {\r\n  const database = await initDb();\r\n  const transaction = database.transaction(STORE_NAME, 'readwrite');\r\n  const store = transaction.objectStore(STORE_NAME);\r\n  const index = store.index('by-timestamp');\r\n\r\n  return new Promise((resolve) => {\r\n    let deleted = 0;\r\n    const cutoff = Date.now() - MAX_AGE_MS;\r\n    const countRequest = store.count();\r\n\r\n    countRequest.onsuccess = () => {\r\n      const count = countRequest.result;\r\n      const excessCount = Math.max(0, count - MAX_ENTRIES);\r\n\r\n      // Delete old entries (by age)\r\n      const ageRequest = index.openCursor(IDBKeyRange.upperBound(cutoff));\r\n      ageRequest.onsuccess = () => {\r\n        const cursor = ageRequest.result;\r\n        if (cursor) {\r\n          cursor.delete();\r\n          deleted++;\r\n          cursor.continue();\r\n        }\r\n      };\r\n\r\n      // Delete excess entries (by count) - oldest first\r\n      if (excessCount > 0) {\r\n        let excessDeleted = 0;\r\n        const excessRequest = index.openCursor();\r\n        excessRequest.onsuccess = () => {\r\n          const cursor = excessRequest.result;\r\n          if (cursor && excessDeleted < excessCount) {\r\n            cursor.delete();\r\n            deleted++;\r\n            excessDeleted++;\r\n            cursor.continue();\r\n          } else {\r\n            resolve(deleted);\r\n          }\r\n        };\r\n      } else {\r\n        resolve(deleted);\r\n      }\r\n    };\r\n  });\r\n}\r\n\r\n/**\r\n * Initialize storage and schedule cleanup\r\n */\r\nexport async function initLogStorage(): Promise<void> {\r\n  await initDb();\r\n  // Run cleanup on init\r\n  await cleanupOldEntries();\r\n  // Schedule periodic cleanup (every 5 minutes)\r\n  setInterval(() => cleanupOldEntries(), 5 * 60 * 1000);\r\n}\r\n", "/**\r\n * Logger Module\r\n *\r\n * Provides lazy-evaluated logging with IndexedDB persistence.\r\n * The messageFactory lambda is only called if the log level is enabled,\r\n * avoiding string allocation overhead for disabled levels.\r\n */\r\n\r\nimport type { Logger, LogEntry } from './types';\r\nimport { LogLevel, LOG_LEVEL_NAMES } from './types';\r\nimport { writeLogEntry } from './storage';\r\n\r\n/** Current minimum log level (default: Warn) */\r\nlet minLevel: LogLevel = LogLevel.Warn;\r\n\r\n/** Whether to also log to console (development mode) */\r\nlet consoleEnabled = false;\r\n\r\n/**\r\n * Set the minimum log level\r\n */\r\nexport function setLogLevel(level: LogLevel): void {\r\n  minLevel = level;\r\n}\r\n\r\n/**\r\n * Get the current minimum log level\r\n */\r\nexport function getLogLevel(): LogLevel {\r\n  return minLevel;\r\n}\r\n\r\n/**\r\n * Enable or disable console logging\r\n */\r\nexport function setConsoleLogging(enabled: boolean): void {\r\n  consoleEnabled = enabled;\r\n}\r\n\r\n/**\r\n * Format a log entry for console output\r\n */\r\nfunction formatConsoleMessage(entry: Omit<LogEntry, 'id'>): string {\r\n  const date = new Date(entry.timestamp);\r\n  const time = date.toISOString().slice(11, 23);\r\n  return `[${time}] [${LOG_LEVEL_NAMES[entry.level]}] [${entry.module}] ${entry.message}`;\r\n}\r\n\r\n/**\r\n * Write a log entry (internal)\r\n */\r\nfunction writeLog(level: LogLevel, module: string, message: string, data?: unknown): void {\r\n  const entry: Omit<LogEntry, 'id'> = {\r\n    timestamp: Date.now(),\r\n    level,\r\n    module,\r\n    message,\r\n    data\r\n  };\r\n\r\n  // Write to IndexedDB (async, fire-and-forget)\r\n  writeLogEntry(entry);\r\n\r\n  // Also log to console if enabled\r\n  if (consoleEnabled) {\r\n    const formatted = formatConsoleMessage(entry);\r\n    switch (level) {\r\n      case LogLevel.Exception:\r\n      case LogLevel.Error:\r\n        console.error(formatted, data ?? '');\r\n        break;\r\n      case LogLevel.Warn:\r\n        console.warn(formatted, data ?? '');\r\n        break;\r\n      case LogLevel.Info:\r\n        console.info(formatted, data ?? '');\r\n        break;\r\n      case LogLevel.Verbose:\r\n        console.debug(formatted, data ?? '');\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Create a logger instance for a specific module\r\n */\r\nexport function createLogger(module: string): Logger {\r\n  return {\r\n    exception(error: Error, context?: string): void {\r\n      // Exceptions always log regardless of level\r\n      const message = context\r\n        ? `${context}: ${error.message}`\r\n        : error.message;\r\n      writeLog(LogLevel.Exception, module, message, {\r\n        name: error.name,\r\n        stack: error.stack\r\n      });\r\n    },\r\n\r\n    error(messageFactory: () => string, data?: unknown): void {\r\n      if (LogLevel.Error > minLevel) return;\r\n      writeLog(LogLevel.Error, module, messageFactory(), data);\r\n    },\r\n\r\n    warn(messageFactory: () => string, data?: unknown): void {\r\n      if (LogLevel.Warn > minLevel) return;\r\n      writeLog(LogLevel.Warn, module, messageFactory(), data);\r\n    },\r\n\r\n    info(messageFactory: () => string, data?: unknown): void {\r\n      if (LogLevel.Info > minLevel) return;\r\n      writeLog(LogLevel.Info, module, messageFactory(), data);\r\n    },\r\n\r\n    verbose(messageFactory: () => string, data?: unknown): void {\r\n      if (LogLevel.Verbose > minLevel) return;\r\n      writeLog(LogLevel.Verbose, module, messageFactory(), data);\r\n    },\r\n\r\n    log(level: LogLevel, messageFactory: () => string, data?: unknown): void {\r\n      if (level > minLevel) return;\r\n      writeLog(level, module, messageFactory(), data);\r\n    }\r\n  };\r\n}\r\n", "/**\r\n * State Channel Module\r\n *\r\n * Manages the state WebSocket connection for real-time session list updates.\r\n * Handles automatic reconnection with exponential backoff.\r\n */\r\n\r\nimport type { Session, UpdateInfo, TerminalState } from '../../types';\r\nimport { INITIAL_RECONNECT_DELAY, MAX_RECONNECT_DELAY } from '../../constants';\r\nimport { scheduleReconnect } from '../../utils';\r\nimport { createLogger } from '../logging';\r\n\r\nconst log = createLogger('state');\r\nimport {\r\n  sessions,\r\n  activeSessionId,\r\n  settingsOpen,\r\n  stateWs,\r\n  stateReconnectTimer,\r\n  stateReconnectDelay,\r\n  stateWsConnected,\r\n  muxWsConnected,\r\n  sessionTerminals,\r\n  newlyCreatedSessions,\r\n  setStateWs,\r\n  setStateReconnectTimer,\r\n  setStateReconnectDelay,\r\n  setStateWsConnected,\r\n  setSessions,\r\n  setActiveSessionId,\r\n  setUpdateInfo\r\n} from '../../state';\r\n\r\n// Forward declarations for functions from other modules\r\n// These will be imported when those modules are created\r\nlet destroyTerminalForSession: (sessionId: string) => void = () => {};\r\nlet applyTerminalScaling: (sessionId: string, state: TerminalState) => void = () => {};\r\nlet renderSessionList: () => void = () => {};\r\nlet updateEmptyState: () => void = () => {};\r\nlet selectSession: (sessionId: string) => void = () => {};\r\nlet updateMobileTitle: () => void = () => {};\r\nlet renderUpdatePanel: () => void = () => {};\r\n\r\n/**\r\n * Register callbacks from other modules\r\n */\r\nexport function registerStateCallbacks(callbacks: {\r\n  destroyTerminalForSession?: (sessionId: string) => void;\r\n  applyTerminalScaling?: (sessionId: string, state: TerminalState) => void;\r\n  renderSessionList?: () => void;\r\n  updateEmptyState?: () => void;\r\n  selectSession?: (sessionId: string) => void;\r\n  updateMobileTitle?: () => void;\r\n  renderUpdatePanel?: () => void;\r\n}): void {\r\n  if (callbacks.destroyTerminalForSession) destroyTerminalForSession = callbacks.destroyTerminalForSession;\r\n  if (callbacks.applyTerminalScaling) applyTerminalScaling = callbacks.applyTerminalScaling;\r\n  if (callbacks.renderSessionList) renderSessionList = callbacks.renderSessionList;\r\n  if (callbacks.updateEmptyState) updateEmptyState = callbacks.updateEmptyState;\r\n  if (callbacks.selectSession) selectSession = callbacks.selectSession;\r\n  if (callbacks.updateMobileTitle) updateMobileTitle = callbacks.updateMobileTitle;\r\n  if (callbacks.renderUpdatePanel) renderUpdatePanel = callbacks.renderUpdatePanel;\r\n}\r\n\r\n/**\r\n * Connect to the state WebSocket for real-time session updates.\r\n * Automatically reconnects with exponential backoff on disconnect.\r\n */\r\nexport function connectStateWebSocket(): void {\r\n  // Close existing WebSocket before creating new one\r\n  if (stateWs) {\r\n    stateWs.onclose = null; // Prevent reconnect loop\r\n    stateWs.close();\r\n    setStateWs(null);\r\n  }\r\n\r\n  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n  const ws = new WebSocket(`${protocol}//${location.host}/ws/state`);\r\n  setStateWs(ws);\r\n\r\n  ws.onopen = () => {\r\n    setStateReconnectDelay(INITIAL_RECONNECT_DELAY);\r\n    setStateWsConnected(true);\r\n    updateConnectionStatus();\r\n  };\r\n\r\n  ws.onmessage = (event) => {\r\n    try {\r\n      const data = JSON.parse(event.data);\r\n      const sessionList = data.sessions?.sessions ?? [];\r\n      handleStateUpdate(sessionList);\r\n      handleUpdateInfo(data.update);\r\n    } catch (e: unknown) {\r\n      const message = e instanceof Error ? e.message : String(e);\r\n      log.error(() => `Error parsing state: ${message}`);\r\n    }\r\n  };\r\n\r\n  ws.onclose = () => {\r\n    setStateWsConnected(false);\r\n    updateConnectionStatus();\r\n    scheduleStateReconnect();\r\n  };\r\n\r\n  ws.onerror = (e) => {\r\n    log.error(() => `WebSocket error: ${e}`);\r\n  };\r\n}\r\n\r\n/**\r\n * Handle session list updates from server.\r\n * Removes terminals for deleted sessions, updates dimensions, and manages selection.\r\n */\r\nexport function handleStateUpdate(newSessions: Session[]): void {\r\n  // Remove terminals for deleted sessions\r\n  const newIds = new Set(newSessions.map(s => s.id));\r\n  sessionTerminals.forEach((_, id) => {\r\n    if (!newIds.has(id)) {\r\n      destroyTerminalForSession(id);\r\n      newlyCreatedSessions.delete(id);\r\n    }\r\n  });\r\n\r\n  // Update dimensions and resize terminals when server dimensions change\r\n  newSessions.forEach((session) => {\r\n    const state = sessionTerminals.get(session.id);\r\n    if (state && state.opened) {\r\n      const dimensionsChanged = state.serverCols !== session.cols || state.serverRows !== session.rows;\r\n      if (dimensionsChanged) {\r\n        state.serverCols = session.cols;\r\n        state.serverRows = session.rows;\r\n        state.terminal.resize(session.cols, session.rows);\r\n        applyTerminalScaling(session.id, state);\r\n      }\r\n    } else if (state) {\r\n      state.serverCols = session.cols;\r\n      state.serverRows = session.rows;\r\n    }\r\n  });\r\n\r\n  setSessions(newSessions);\r\n  renderSessionList();\r\n  updateEmptyState();\r\n\r\n  // Auto-select first session if none active (but not if settings are open)\r\n  const firstSession = sessions[0];\r\n  if (!activeSessionId && firstSession && !settingsOpen) {\r\n    selectSession(firstSession.id);\r\n  }\r\n\r\n  // Handle active session being deleted (but not if settings are open)\r\n  if (activeSessionId && !sessions.find(s => s.id === activeSessionId)) {\r\n    setActiveSessionId(null);\r\n    const nextSession = sessions[0];\r\n    if (nextSession && !settingsOpen) {\r\n      selectSession(nextSession.id);\r\n    }\r\n  }\r\n\r\n  updateMobileTitle();\r\n}\r\n\r\n/**\r\n * Handle update info from server.\r\n * Updates the stored update info and renders the update panel.\r\n */\r\nexport function handleUpdateInfo(update: UpdateInfo | null): void {\r\n  setUpdateInfo(update);\r\n  renderUpdatePanel();\r\n}\r\n\r\n/**\r\n * Schedule state WebSocket reconnection with exponential backoff.\r\n */\r\nexport function scheduleStateReconnect(): void {\r\n  scheduleReconnect(\r\n    stateReconnectDelay,\r\n    MAX_RECONNECT_DELAY,\r\n    connectStateWebSocket,\r\n    setStateReconnectDelay,\r\n    setStateReconnectTimer,\r\n    stateReconnectTimer\r\n  );\r\n}\r\n\r\n/**\r\n * Update the connection status indicator in the UI.\r\n */\r\nexport function updateConnectionStatus(): void {\r\n  const indicator = document.getElementById('connection-status');\r\n  if (!indicator) return;\r\n\r\n  let status: string;\r\n  let text: string;\r\n\r\n  if (stateWsConnected && muxWsConnected) {\r\n    status = 'connected';\r\n    text = '';\r\n  } else if (!stateWsConnected && !muxWsConnected) {\r\n    status = 'disconnected';\r\n    text = 'Server disconnected';\r\n  } else {\r\n    status = 'reconnecting';\r\n    text = 'Reconnecting...';\r\n  }\r\n\r\n  indicator.className = `connection-status ${status}`;\r\n  indicator.textContent = text;\r\n}\r\n", "/**\r\n * Mux Channel Module\r\n *\r\n * Manages the mux WebSocket connection for terminal I/O.\r\n * Uses a binary protocol with 9-byte header (1 byte type + 8 byte session ID).\r\n *\r\n * CRITICAL: All output frames are processed strictly in order through a single queue.\r\n * This ensures TUI apps receive escape sequences in the correct order.\r\n */\r\n\r\nimport type { TerminalState } from '../../types';\r\nimport { createLogger } from '../logging';\r\nimport {\r\n  MUX_HEADER_SIZE,\r\n  MUX_TYPE_OUTPUT,\r\n  MUX_TYPE_INPUT,\r\n  MUX_TYPE_RESIZE,\r\n  MUX_TYPE_RESYNC,\r\n  MUX_TYPE_BUFFER_REQUEST,\r\n  MUX_TYPE_COMPRESSED_OUTPUT,\r\n  MUX_TYPE_ACTIVE_HINT,\r\n  INITIAL_RECONNECT_DELAY,\r\n  MAX_RECONNECT_DELAY\r\n} from '../../constants';\r\nimport { parseOutputFrame, parseCompressedOutputFrame, scheduleReconnect } from '../../utils';\r\nimport {\r\n  muxWs,\r\n  muxReconnectTimer,\r\n  muxReconnectDelay,\r\n  muxHasConnected,\r\n  sessionTerminals,\r\n  pendingOutputFrames,\r\n  activeSessionId,\r\n  setMuxWs,\r\n  setMuxReconnectTimer,\r\n  setMuxReconnectDelay,\r\n  setMuxWsConnected,\r\n  setMuxHasConnected\r\n} from '../../state';\r\nimport { updateConnectionStatus } from './stateChannel';\r\n\r\nconst log = createLogger('mux');\r\n\r\n// Forward declarations for functions from other modules\r\nlet applyTerminalScaling: (sessionId: string, state: TerminalState) => void = () => {};\r\n\r\n/**\r\n * Register callbacks from other modules\r\n */\r\nexport function registerMuxCallbacks(callbacks: {\r\n  applyTerminalScaling?: (sessionId: string, state: TerminalState) => void;\r\n}): void {\r\n  if (callbacks.applyTerminalScaling) applyTerminalScaling = callbacks.applyTerminalScaling;\r\n}\r\n\r\n// =============================================================================\r\n// Strictly Ordered Output Queue\r\n// =============================================================================\r\n\r\ninterface OutputFrameItem {\r\n  sessionId: string;\r\n  payload: Uint8Array;\r\n  compressed: boolean;\r\n}\r\n\r\nconst MAX_QUEUE_SIZE = 10000;\r\nconst outputQueue: OutputFrameItem[] = [];\r\nlet processingQueue = false;\r\n\r\n/**\r\n * Queue an output frame and trigger processing.\r\n * ALL frames go through this queue to guarantee strict ordering.\r\n * Drops oldest frames when queue is full to prevent OOM.\r\n */\r\nfunction queueOutputFrame(sessionId: string, payload: Uint8Array, compressed: boolean): void {\r\n  if (outputQueue.length >= MAX_QUEUE_SIZE) {\r\n    log.warn(() => 'Output queue full, dropping oldest frame');\r\n    outputQueue.shift();\r\n  }\r\n  outputQueue.push({ sessionId, payload, compressed });\r\n  processOutputQueue();\r\n}\r\n\r\n/**\r\n * Process output frames strictly in order.\r\n * Frames are processed one at a time - compressed frames block until decompressed.\r\n */\r\nasync function processOutputQueue(): Promise<void> {\r\n  if (processingQueue) return;\r\n  processingQueue = true;\r\n\r\n  try {\r\n    while (outputQueue.length > 0) {\r\n      const item = outputQueue.shift()!;\r\n      await processOneFrame(item);\r\n    }\r\n  } finally {\r\n    processingQueue = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Process a single frame - decompress if needed, then write to terminal.\r\n */\r\nasync function processOneFrame(item: OutputFrameItem): Promise<void> {\r\n  try {\r\n    let cols: number;\r\n    let rows: number;\r\n    let data: Uint8Array;\r\n\r\n    if (item.compressed) {\r\n      const frame = await parseCompressedOutputFrame(item.payload);\r\n      cols = frame.cols;\r\n      rows = frame.rows;\r\n      data = frame.data;\r\n    } else {\r\n      const frame = parseOutputFrame(item.payload);\r\n      cols = frame.cols;\r\n      rows = frame.rows;\r\n      data = frame.data;\r\n    }\r\n\r\n    const state = sessionTerminals.get(item.sessionId);\r\n    if (state && state.opened) {\r\n      writeToTerminal(item.sessionId, state, cols, rows, data);\r\n    } else if (data.length > 0) {\r\n      // Buffer for later replay\r\n      const bufferedPayload = new Uint8Array(4 + data.length);\r\n      bufferedPayload[0] = cols & 0xff;\r\n      bufferedPayload[1] = (cols >> 8) & 0xff;\r\n      bufferedPayload[2] = rows & 0xff;\r\n      bufferedPayload[3] = (rows >> 8) & 0xff;\r\n      bufferedPayload.set(data, 4);\r\n\r\n      if (!pendingOutputFrames.has(item.sessionId)) {\r\n        pendingOutputFrames.set(item.sessionId, []);\r\n      }\r\n      pendingOutputFrames.get(item.sessionId)!.push(bufferedPayload);\r\n    }\r\n  } catch (e) {\r\n    log.error(() => `Failed to process frame: ${e}`);\r\n  }\r\n}\r\n\r\n// Track bracketed paste mode per session\r\nconst bracketedPasteState = new Map<string, boolean>();\r\n\r\n/** Check if session has bracketed paste mode enabled */\r\nexport function isBracketedPasteEnabled(sessionId: string): boolean {\r\n  return bracketedPasteState.get(sessionId) ?? false;\r\n}\r\n\r\n/**\r\n * Write data to terminal, resizing if dimensions changed.\r\n */\r\nfunction writeToTerminal(\r\n  sessionId: string,\r\n  state: TerminalState,\r\n  cols: number,\r\n  rows: number,\r\n  data: Uint8Array\r\n): void {\r\n  // Track bracketed paste mode by detecting escape sequences\r\n  if (data.length > 0) {\r\n    const text = new TextDecoder().decode(data);\r\n    if (text.includes('\\x1b[?2004h')) {\r\n      bracketedPasteState.set(sessionId, true);\r\n    }\r\n    if (text.includes('\\x1b[?2004l')) {\r\n      bracketedPasteState.set(sessionId, false);\r\n    }\r\n  }\r\n\r\n  // Resize if dimensions are valid and different\r\n  if (cols > 0 && rows > 0 && cols <= 500 && rows <= 500 && state.opened) {\r\n    const currentCols = state.terminal.cols;\r\n    const currentRows = state.terminal.rows;\r\n\r\n    if (currentCols !== cols || currentRows !== rows) {\r\n      try {\r\n        state.terminal.resize(cols, rows);\r\n        state.serverCols = cols;\r\n        state.serverRows = rows;\r\n        applyTerminalScaling(sessionId, state);\r\n      } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e);\r\n        log.warn(() => `Terminal resize deferred: ${message}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Always write data if present\r\n  if (data.length > 0) {\r\n    state.terminal.write(data);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// WebSocket Connection\r\n// =============================================================================\r\n\r\n/**\r\n * Connect to the mux WebSocket for terminal I/O.\r\n * Uses a binary protocol with 9-byte header.\r\n */\r\nexport function connectMuxWebSocket(): void {\r\n  // Close existing WebSocket before creating new one\r\n  if (muxWs) {\r\n    muxWs.onclose = null; // Prevent reconnect loop\r\n    muxWs.close();\r\n    setMuxWs(null);\r\n  }\r\n\r\n  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n  const ws = new WebSocket(`${protocol}//${location.host}/ws/mux`);\r\n  ws.binaryType = 'arraybuffer';\r\n  setMuxWs(ws);\r\n\r\n  ws.onopen = () => {\r\n    // Detect reconnect: we've connected before AND have terminals to refresh\r\n    const isReconnect = muxHasConnected && sessionTerminals.size > 0;\r\n\r\n    setMuxReconnectDelay(INITIAL_RECONNECT_DELAY);\r\n    setMuxWsConnected(true);\r\n    setMuxHasConnected(true);\r\n    updateConnectionStatus();\r\n\r\n    // On reconnect, clear all terminals and request buffer refresh for each\r\n    // This handles mt.exe restarts where sessions survive but connection is new\r\n    if (isReconnect) {\r\n      log.info(() => `Reconnected - refreshing ${sessionTerminals.size} terminals`);\r\n      pendingOutputFrames.clear();\r\n      outputQueue.length = 0;\r\n      sessionTerminals.forEach((state) => {\r\n        if (state.opened) {\r\n          state.terminal.clear();\r\n        }\r\n        state.serverCols = 0;\r\n        state.serverRows = 0;\r\n        // Server pushes all buffers on connect via SendInitialBuffersAsync\r\n      });\r\n    } else {\r\n      log.info(() => 'Connected (first connection)');\r\n    }\r\n\r\n    // Send active session hint so server knows which session to prioritize\r\n    if (activeSessionId) {\r\n      sendActiveSessionHint(activeSessionId);\r\n    }\r\n  };\r\n\r\n  ws.onmessage = (event) => {\r\n    if (!(event.data instanceof ArrayBuffer)) return;\r\n\r\n    const data = new Uint8Array(event.data);\r\n    if (data.length < MUX_HEADER_SIZE) return;\r\n\r\n    const type = data[0];\r\n    const sessionId = decodeSessionId(data, 1);\r\n    const payload = data.slice(MUX_HEADER_SIZE);\r\n\r\n    if (type === MUX_TYPE_RESYNC) {\r\n      // Server is resyncing due to dropped frames - clear all terminals\r\n      log.info(() => 'Resync: clearing terminals for buffer refresh');\r\n      sessionTerminals.forEach((state) => {\r\n        if (state.opened) {\r\n          state.terminal.clear();\r\n        }\r\n      });\r\n      pendingOutputFrames.clear();\r\n      outputQueue.length = 0; // Clear pending queue too\r\n      return;\r\n    }\r\n\r\n    if (type === MUX_TYPE_OUTPUT || type === MUX_TYPE_COMPRESSED_OUTPUT) {\r\n      // Queue ALL output frames to guarantee strict ordering\r\n      if (payload.length >= 4) {\r\n        queueOutputFrame(sessionId, payload.slice(), type === MUX_TYPE_COMPRESSED_OUTPUT);\r\n      }\r\n    }\r\n  };\r\n\r\n  ws.onclose = () => {\r\n    setMuxWsConnected(false);\r\n    updateConnectionStatus();\r\n    scheduleMuxReconnect();\r\n  };\r\n\r\n  ws.onerror = (e) => {\r\n    log.error(() => `WebSocket error: ${e}`);\r\n  };\r\n}\r\n\r\n/**\r\n * Send terminal input to server.\r\n */\r\nexport function sendInput(sessionId: string, data: string): void {\r\n  if (!muxWs || muxWs.readyState !== WebSocket.OPEN) return;\r\n\r\n  const payload = new TextEncoder().encode(data);\r\n  const frame = new Uint8Array(MUX_HEADER_SIZE + payload.length);\r\n  frame[0] = MUX_TYPE_INPUT;\r\n  encodeSessionId(frame, 1, sessionId);\r\n  frame.set(payload, MUX_HEADER_SIZE);\r\n  muxWs.send(frame);\r\n}\r\n\r\n/**\r\n * Send terminal resize to server.\r\n */\r\nexport function sendResize(sessionId: string, cols: number, rows: number): void {\r\n  if (!muxWs || muxWs.readyState !== WebSocket.OPEN) return;\r\n\r\n  const frame = new Uint8Array(MUX_HEADER_SIZE + 4);\r\n  frame[0] = MUX_TYPE_RESIZE;\r\n  encodeSessionId(frame, 1, sessionId);\r\n  frame[MUX_HEADER_SIZE] = cols & 0xff;\r\n  frame[MUX_HEADER_SIZE + 1] = (cols >> 8) & 0xff;\r\n  frame[MUX_HEADER_SIZE + 2] = rows & 0xff;\r\n  frame[MUX_HEADER_SIZE + 3] = (rows >> 8) & 0xff;\r\n  muxWs.send(frame);\r\n\r\n  const state = sessionTerminals.get(sessionId);\r\n  if (state) {\r\n    state.serverCols = cols;\r\n    state.serverRows = rows;\r\n  }\r\n}\r\n\r\n/**\r\n * Request buffer refresh for a session via WebSocket.\r\n */\r\nexport function requestBufferRefresh(sessionId: string): void {\r\n  if (!muxWs || muxWs.readyState !== WebSocket.OPEN) return;\r\n\r\n  const frame = new Uint8Array(MUX_HEADER_SIZE);\r\n  frame[0] = MUX_TYPE_BUFFER_REQUEST;\r\n  encodeSessionId(frame, 1, sessionId);\r\n  muxWs.send(frame);\r\n}\r\n\r\n/**\r\n * Send active session hint to server for priority delivery.\r\n */\r\nexport function sendActiveSessionHint(sessionId: string | null): void {\r\n  if (!muxWs || muxWs.readyState !== WebSocket.OPEN) return;\r\n\r\n  const frame = new Uint8Array(MUX_HEADER_SIZE);\r\n  frame[0] = MUX_TYPE_ACTIVE_HINT;\r\n  if (sessionId) {\r\n    encodeSessionId(frame, 1, sessionId);\r\n  }\r\n  muxWs.send(frame);\r\n}\r\n\r\n/**\r\n * Encode 8-character session ID into buffer at offset.\r\n */\r\nexport function encodeSessionId(buffer: Uint8Array, offset: number, sessionId: string): void {\r\n  for (let i = 0; i < 8; i++) {\r\n    buffer[offset + i] = i < sessionId.length ? sessionId.charCodeAt(i) : 0;\r\n  }\r\n}\r\n\r\n/**\r\n * Decode 8-character session ID from buffer at offset.\r\n */\r\nexport function decodeSessionId(buffer: Uint8Array, offset: number): string {\r\n  const chars: string[] = [];\r\n  for (let i = 0; i < 8; i++) {\r\n    const byte = buffer[offset + i];\r\n    if (byte !== undefined && byte !== 0) {\r\n      chars.push(String.fromCharCode(byte));\r\n    }\r\n  }\r\n  return chars.join('');\r\n}\r\n\r\n/**\r\n * Schedule mux WebSocket reconnection with exponential backoff.\r\n */\r\nexport function scheduleMuxReconnect(): void {\r\n  scheduleReconnect(\r\n    muxReconnectDelay,\r\n    MAX_RECONNECT_DELAY,\r\n    connectMuxWebSocket,\r\n    setMuxReconnectDelay,\r\n    setMuxReconnectTimer,\r\n    muxReconnectTimer\r\n  );\r\n}\r\n\r\n/**\r\n * Write output frame to terminal (used by manager.ts for replay).\r\n */\r\nexport function writeOutputFrame(sessionId: string, state: TerminalState, payload: Uint8Array): void {\r\n  const frame = parseOutputFrame(payload);\r\n  writeToTerminal(sessionId, state, frame.cols, frame.rows, frame.data);\r\n}\r\n", "/**\r\n * Settings Channel Module\r\n *\r\n * Manages the settings WebSocket connection for real-time settings sync.\r\n * When settings are changed on any client, all connected clients receive the update.\r\n */\r\n\r\nimport type { Settings } from '../../types';\r\nimport { INITIAL_RECONNECT_DELAY, MAX_RECONNECT_DELAY } from '../../constants';\r\nimport { scheduleReconnect } from '../../utils';\r\nimport { createLogger } from '../logging';\r\nimport { setCurrentSettings } from '../../state';\r\n\r\nconst log = createLogger('settings-ws');\r\n\r\nlet settingsWs: WebSocket | null = null;\r\nlet settingsReconnectTimer: number | undefined;\r\nlet settingsReconnectDelay = INITIAL_RECONNECT_DELAY;\r\nlet settingsWsConnected = false;\r\n\r\nlet applyReceivedSettings: (settings: Settings) => void = () => {};\r\n\r\n/**\r\n * Register callbacks from other modules\r\n */\r\nexport function registerSettingsCallbacks(callbacks: {\r\n  applyReceivedSettings?: (settings: Settings) => void;\r\n}): void {\r\n  if (callbacks.applyReceivedSettings) applyReceivedSettings = callbacks.applyReceivedSettings;\r\n}\r\n\r\n/**\r\n * Connect to the settings WebSocket for real-time settings sync.\r\n * Automatically reconnects with exponential backoff on disconnect.\r\n */\r\nexport function connectSettingsWebSocket(): void {\r\n  if (settingsWs) {\r\n    settingsWs.onclose = null;\r\n    settingsWs.close();\r\n    settingsWs = null;\r\n  }\r\n\r\n  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n  const ws = new WebSocket(`${protocol}//${location.host}/ws/settings`);\r\n  settingsWs = ws;\r\n\r\n  ws.onopen = () => {\r\n    settingsReconnectDelay = INITIAL_RECONNECT_DELAY;\r\n    settingsWsConnected = true;\r\n    log.info(() => 'Settings WebSocket connected');\r\n  };\r\n\r\n  ws.onmessage = (event) => {\r\n    try {\r\n      const settings = JSON.parse(event.data) as Settings;\r\n      handleSettingsUpdate(settings);\r\n    } catch (e: unknown) {\r\n      const message = e instanceof Error ? e.message : String(e);\r\n      log.error(() => `Error parsing settings: ${message}`);\r\n    }\r\n  };\r\n\r\n  ws.onclose = () => {\r\n    settingsWsConnected = false;\r\n    log.info(() => 'Settings WebSocket disconnected');\r\n    scheduleSettingsReconnect();\r\n  };\r\n\r\n  ws.onerror = (e) => {\r\n    log.error(() => `Settings WebSocket error: ${e}`);\r\n  };\r\n}\r\n\r\nfunction handleSettingsUpdate(settings: Settings): void {\r\n  setCurrentSettings(settings);\r\n  applyReceivedSettings(settings);\r\n}\r\n\r\nfunction scheduleSettingsReconnect(): void {\r\n  scheduleReconnect(\r\n    settingsReconnectDelay,\r\n    MAX_RECONNECT_DELAY,\r\n    connectSettingsWebSocket,\r\n    (delay) => { settingsReconnectDelay = delay; },\r\n    (timer) => { settingsReconnectTimer = timer; },\r\n    settingsReconnectTimer\r\n  );\r\n}\r\n\r\nexport function isSettingsWsConnected(): boolean {\r\n  return settingsWsConnected;\r\n}\r\n", "/**\r\n * Terminal Manager Module\r\n *\r\n * Handles xterm.js terminal lifecycle, creation, destruction,\r\n * and event binding for terminal sessions.\r\n */\r\n\r\nimport type { Session, TerminalState } from '../../types';\r\nimport { THEMES, MOBILE_BREAKPOINT, TERMINAL_FONT_STACK } from '../../constants';\r\nimport {\r\n  sessionTerminals,\r\n  currentSettings,\r\n  activeSessionId,\r\n  pendingOutputFrames,\r\n  fontsReadyPromise,\r\n  dom,\r\n  setFontsReadyPromise,\r\n  windowsBuildNumber,\r\n  sessions\r\n} from '../../state';\r\nimport { getClipboardStyle, parseOutputFrame } from '../../utils';\r\nimport { applyTerminalScaling, fitSessionToScreen } from './scaling';\r\nimport { setupFileDrop, handleClipboardPaste } from './fileDrop';\r\nimport { isBracketedPasteEnabled } from '../comms';\r\n\r\ndeclare const Terminal: any;\r\ndeclare const FitAddon: any;\r\ndeclare const WebglAddon: any;\r\ndeclare const WebLinksAddon: any;\r\ndeclare const SearchAddon: any;\r\n\r\nimport { initSearchForTerminal, showSearch, isSearchVisible, hideSearch, cleanupSearchForTerminal } from './search';\r\n\r\n// Forward declarations for functions from other modules\r\nlet sendInput: (sessionId: string, data: string) => void = () => {};\r\nlet showBellNotification: (sessionId: string) => void = () => {};\r\nlet requestBufferRefresh: (sessionId: string) => void = () => {};\r\n\r\n// Debounce timers for auto-rename from shell title\r\nconst pendingTitleUpdates = new Map<string, number>();\r\n\r\n/**\r\n * Auto-update session name from shell title (with debounce)\r\n */\r\nfunction updateSessionNameAuto(sessionId: string, name: string): void {\r\n  const session = sessions.find(s => s.id === sessionId);\r\n  if (session?.manuallyNamed) return;\r\n\r\n  const existing = pendingTitleUpdates.get(sessionId);\r\n  if (existing) {\r\n    window.clearTimeout(existing);\r\n  }\r\n\r\n  const timer = window.setTimeout(() => {\r\n    pendingTitleUpdates.delete(sessionId);\r\n    fetch(`/api/sessions/${sessionId}/name?auto=true`, {\r\n      method: 'PUT',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ name })\r\n    }).catch(() => {});\r\n  }, 500);\r\n\r\n  pendingTitleUpdates.set(sessionId, timer);\r\n}\r\n\r\n/**\r\n * Register callbacks from other modules\r\n */\r\nexport function registerTerminalCallbacks(callbacks: {\r\n  sendInput?: (sessionId: string, data: string) => void;\r\n  showBellNotification?: (sessionId: string) => void;\r\n  requestBufferRefresh?: (sessionId: string) => void;\r\n}): void {\r\n  if (callbacks.sendInput) sendInput = callbacks.sendInput;\r\n  if (callbacks.showBellNotification) showBellNotification = callbacks.showBellNotification;\r\n  if (callbacks.requestBufferRefresh) requestBufferRefresh = callbacks.requestBufferRefresh;\r\n}\r\n\r\n/**\r\n * Get terminal options based on current settings\r\n */\r\nexport function getTerminalOptions(): object {\r\n  const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;\r\n  const baseFontSize = currentSettings?.fontSize ?? 14;\r\n  const fontSize = isMobile ? Math.max(baseFontSize - 2, 10) : baseFontSize;\r\n  const themeName = currentSettings?.theme ?? 'dark';\r\n  const fontFamily = currentSettings?.fontFamily ?? 'Cascadia Code';\r\n\r\n  const options: Record<string, unknown> = {\r\n    cursorBlink: currentSettings?.cursorBlink ?? true,\r\n    cursorStyle: currentSettings?.cursorStyle ?? 'bar',\r\n    cursorInactiveStyle: 'none',\r\n    fontFamily: `'${fontFamily}', ${TERMINAL_FONT_STACK}`,\r\n    fontSize: fontSize,\r\n    letterSpacing: 0,\r\n    lineHeight: 1,\r\n    scrollback: currentSettings?.scrollbackLines ?? 10000,\r\n    minimumContrastRatio: currentSettings?.minimumContrastRatio ?? 1,\r\n    smoothScrollDuration: currentSettings?.smoothScrolling ? 150 : 0,\r\n    allowProposedApi: true,\r\n    customGlyphs: true,\r\n    rescaleOverlappingGlyphs: true,\r\n    theme: THEMES[themeName] ?? THEMES.dark\r\n  };\r\n\r\n  // Configure ConPTY for Windows - use server-provided build or detect from userAgent\r\n  const isWindows = /Windows|Win32|Win64/i.test(navigator.userAgent);\r\n  if (windowsBuildNumber !== null) {\r\n    options.windowsPty = {\r\n      backend: 'conpty',\r\n      buildNumber: windowsBuildNumber\r\n    };\r\n  } else if (isWindows) {\r\n    // Default to Windows 10 2004 (19041) which has stable ConPTY support\r\n    // This ensures proper VT sequence interpretation before health check completes\r\n    options.windowsPty = {\r\n      backend: 'conpty',\r\n      buildNumber: 19041\r\n    };\r\n  }\r\n\r\n  return options;\r\n}\r\n\r\n/**\r\n * Create a terminal instance for a session.\r\n * Returns existing state if terminal already exists.\r\n */\r\nexport function createTerminalForSession(\r\n  sessionId: string,\r\n  sessionInfo: Session | undefined\r\n): TerminalState {\r\n  const existing = sessionTerminals.get(sessionId);\r\n  if (existing) {\r\n    return existing;\r\n  }\r\n\r\n  // Create container\r\n  const container = document.createElement('div');\r\n  container.className = 'terminal-container hidden';\r\n  container.id = 'terminal-' + sessionId;\r\n  dom.terminalsArea?.appendChild(container);\r\n\r\n  // Set up file drop handler for drag-and-drop uploads\r\n  setupFileDrop(container);\r\n\r\n  // Initialize xterm.js\r\n  const terminal = new Terminal(getTerminalOptions());\r\n  const fitAddon = new FitAddon.FitAddon();\r\n  terminal.loadAddon(fitAddon);\r\n\r\n  // Get server dimensions from session info (if available)\r\n  const serverCols = sessionInfo && sessionInfo.cols > 0 ? sessionInfo.cols : 0;\r\n  const serverRows = sessionInfo && sessionInfo.rows > 0 ? sessionInfo.rows : 0;\r\n\r\n  const state: TerminalState = {\r\n    terminal: terminal,\r\n    fitAddon: fitAddon,\r\n    container: container,\r\n    serverCols: serverCols,\r\n    serverRows: serverRows,\r\n    opened: false\r\n  };\r\n\r\n  sessionTerminals.set(sessionId, state);\r\n\r\n  // Wait for fonts to be ready before opening terminal\r\n  // This ensures xterm.js measures the correct font for canvas rendering\r\n  (fontsReadyPromise ?? Promise.resolve()).then(() => {\r\n    if (!sessionTerminals.has(sessionId)) return; // Session was deleted\r\n    terminal.open(container);\r\n    state.opened = true;\r\n\r\n    // Load WebGL addon for GPU-accelerated rendering (with fallback)\r\n    if (currentSettings?.useWebGL !== false) {\r\n      try {\r\n        const webglAddon = new WebglAddon.WebglAddon();\r\n        webglAddon.onContextLost(() => {\r\n          webglAddon.dispose();\r\n        });\r\n        terminal.loadAddon(webglAddon);\r\n      } catch {\r\n        // WebGL not available, using canvas renderer\r\n      }\r\n    }\r\n\r\n    // Load Web-Links addon for clickable URLs\r\n    try {\r\n      const webLinksAddon = new WebLinksAddon.WebLinksAddon(\r\n        (_event: MouseEvent, uri: string) => {\r\n          if (uri.startsWith('http://') || uri.startsWith('https://')) {\r\n            window.open(uri, '_blank', 'noopener,noreferrer');\r\n          }\r\n        }\r\n      );\r\n      terminal.loadAddon(webLinksAddon);\r\n    } catch {\r\n      // Web-Links addon failed to load\r\n    }\r\n\r\n    // Load Search addon for Ctrl+F search\r\n    initSearchForTerminal(sessionId, terminal);\r\n\r\n    // Replay any WebSocket frames that arrived before terminal was opened\r\n    replayPendingFrames(sessionId, state);\r\n\r\n    // Defer resize to next frame - xterm.js needs a frame to fully initialize after open()\r\n    requestAnimationFrame(() => {\r\n      if (!sessionTerminals.has(sessionId)) return; // Session was deleted\r\n\r\n      // Fit terminal to current viewport using actual measured cell dimensions\r\n      fitSessionToScreen(sessionId);\r\n\r\n      setupTerminalEvents(sessionId, terminal, container);\r\n    });\r\n  });\r\n\r\n  return state;\r\n}\r\n\r\n/**\r\n * Replay pending output frames that arrived before terminal was opened\r\n */\r\nfunction replayPendingFrames(sessionId: string, state: TerminalState): void {\r\n  const frames = pendingOutputFrames.get(sessionId);\r\n  if (frames && frames.length > 0) {\r\n    frames.forEach((payload) => {\r\n      writeOutputFrame(sessionId, state, payload);\r\n    });\r\n    pendingOutputFrames.delete(sessionId);\r\n  }\r\n}\r\n\r\n/**\r\n * Write an output frame to the terminal, handling dimension updates\r\n */\r\nexport function writeOutputFrame(\r\n  sessionId: string,\r\n  state: TerminalState,\r\n  payload: Uint8Array\r\n): void {\r\n  const frame = parseOutputFrame(payload);\r\n\r\n  // Ensure terminal matches frame dimensions before writing\r\n  if (frame.valid && state.opened) {\r\n    const currentCols = state.terminal.cols;\r\n    const currentRows = state.terminal.rows;\r\n\r\n    if (currentCols !== frame.cols || currentRows !== frame.rows) {\r\n      try {\r\n        state.terminal.resize(frame.cols, frame.rows);\r\n        state.serverCols = frame.cols;\r\n        state.serverRows = frame.rows;\r\n        applyTerminalScaling(sessionId, state);\r\n      } catch {\r\n        // Ignore resize errors - terminal may not be fully initialized\r\n      }\r\n    }\r\n  }\r\n\r\n  // Write terminal data\r\n  if (frame.data.length > 0) {\r\n    state.terminal.write(frame.data);\r\n  }\r\n}\r\n\r\n/**\r\n * Set up terminal event handlers for input, bell, selection, etc.\r\n */\r\nexport function setupTerminalEvents(\r\n  sessionId: string,\r\n  terminal: any,\r\n  container: HTMLDivElement\r\n): void {\r\n  // Wire up events\r\n  terminal.onData((data: string) => {\r\n    sendInput(sessionId, data);\r\n  });\r\n\r\n  terminal.onBell(() => {\r\n    showBellNotification(sessionId);\r\n  });\r\n\r\n  terminal.onSelectionChange(() => {\r\n    if (currentSettings?.copyOnSelect && terminal.hasSelection()) {\r\n      navigator.clipboard.writeText(terminal.getSelection()).catch(() => {});\r\n    }\r\n  });\r\n\r\n  // Auto-update session name from shell title\r\n  terminal.onTitleChange((title: string) => {\r\n    if (title && title.trim()) {\r\n      updateSessionNameAuto(sessionId, title.trim());\r\n    }\r\n  });\r\n\r\n  // Keyboard shortcuts for copy/paste\r\n  terminal.attachCustomKeyEventHandler((e: KeyboardEvent) => {\r\n    if (e.type !== 'keydown') return true;\r\n\r\n    // Ctrl+Enter: Send LF (\\n) instead of CR (\\r) for TUI apps that use it for line breaks\r\n    if (e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey && e.key === 'Enter') {\r\n      sendInput(sessionId, '\\n');\r\n      return false;\r\n    }\r\n\r\n    const style = getClipboardStyle(currentSettings?.clipboardShortcuts ?? 'auto');\r\n\r\n    if (style === 'windows') {\r\n      // Ctrl+C: copy if selected, else let terminal handle (SIGINT)\r\n      if (e.ctrlKey && !e.shiftKey && e.key === 'c') {\r\n        if (terminal.hasSelection()) {\r\n          navigator.clipboard.writeText(terminal.getSelection()).catch(() => {});\r\n          terminal.clearSelection();\r\n          return false;\r\n        }\r\n        return true;\r\n      }\r\n      // Ctrl+V: paste (images uploaded, text pasted)\r\n      if (e.ctrlKey && !e.shiftKey && e.key === 'v') {\r\n        handleClipboardPaste(sessionId);\r\n        return false;\r\n      }\r\n    } else {\r\n      // Unix: Ctrl+Shift+C to copy\r\n      if (e.ctrlKey && e.shiftKey && (e.key === 'C' || e.key === 'c')) {\r\n        if (terminal.hasSelection()) {\r\n          navigator.clipboard.writeText(terminal.getSelection()).catch(() => {});\r\n          terminal.clearSelection();\r\n        }\r\n        return false;\r\n      }\r\n      // Unix: Ctrl+Shift+V to paste (images uploaded, text pasted)\r\n      if (e.ctrlKey && e.shiftKey && (e.key === 'V' || e.key === 'v')) {\r\n        handleClipboardPaste(sessionId);\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // Ctrl+F / Cmd+F: Open search\r\n    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {\r\n      showSearch();\r\n      return false;\r\n    }\r\n\r\n    // Escape: Close search if open\r\n    if (e.key === 'Escape' && isSearchVisible()) {\r\n      hideSearch();\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  });\r\n\r\n  // Prevent browser paste event - we handle it ourselves via handleClipboardPaste\r\n  // This prevents xterm.js from also handling paste via onData\r\n  // Use capture phase to intercept before xterm.js\r\n  const pasteHandler = (e: ClipboardEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    e.stopImmediatePropagation();\r\n  };\r\n  container.addEventListener('paste', pasteHandler, true);\r\n\r\n  // Right-click paste (images uploaded, text pasted)\r\n  const contextMenuHandler = (e: MouseEvent) => {\r\n    if (!currentSettings || currentSettings.rightClickPaste !== false) {\r\n      e.preventDefault();\r\n      handleClipboardPaste(sessionId);\r\n    }\r\n  };\r\n\r\n  container.addEventListener('contextmenu', contextMenuHandler);\r\n\r\n  // Store handler references for cleanup\r\n  const state = sessionTerminals.get(sessionId);\r\n  if (state) {\r\n    state.contextMenuHandler = contextMenuHandler;\r\n    state.pasteHandler = pasteHandler;\r\n  }\r\n}\r\n\r\n/**\r\n * Destroy a terminal for a session and clean up resources\r\n */\r\nexport function destroyTerminalForSession(sessionId: string): void {\r\n  const state = sessionTerminals.get(sessionId);\r\n  if (!state) return;\r\n\r\n  // Clean up event listeners\r\n  if (state.contextMenuHandler) {\r\n    state.container.removeEventListener('contextmenu', state.contextMenuHandler);\r\n  }\r\n  if (state.pasteHandler) {\r\n    state.container.removeEventListener('paste', state.pasteHandler, true);\r\n  }\r\n\r\n  // Clean up search addon state\r\n  cleanupSearchForTerminal(sessionId);\r\n\r\n  // Clean up pending title update timer\r\n  const titleTimer = pendingTitleUpdates.get(sessionId);\r\n  if (titleTimer) {\r\n    clearTimeout(titleTimer);\r\n    pendingTitleUpdates.delete(sessionId);\r\n  }\r\n\r\n  state.terminal.dispose();\r\n  state.container.remove();\r\n  sessionTerminals.delete(sessionId);\r\n  pendingOutputFrames.delete(sessionId);\r\n}\r\n\r\n/**\r\n * Paste text to a terminal, wrapping with bracketed paste markers if enabled.\r\n * BPM state is tracked in muxChannel from live WebSocket data.\r\n *\r\n * @param isFilePath - If true, wrap content in quotes for file path handling.\r\n *                     This helps TUI apps like Claude Code detect file paths with spaces.\r\n */\r\nexport function pasteToTerminal(sessionId: string, data: string, isFilePath: boolean = false): void {\r\n  const state = sessionTerminals.get(sessionId);\r\n  if (!state) return;\r\n\r\n  // Check BPM state from muxChannel (live WebSocket tracking) and xterm.js internal state\r\n  const muxBpm = isBracketedPasteEnabled(sessionId);\r\n  const xtermBpm = (state.terminal as any).modes?.bracketedPasteMode ?? false;\r\n  const bpmEnabled = muxBpm || xtermBpm;\r\n\r\n  if (bpmEnabled) {\r\n    // Manually wrap with bracketed paste sequences and send via input\r\n    // Only quote file paths (for Claude Code image detection with spaces in path)\r\n    const content = isFilePath ? '\"' + data + '\"' : data;\r\n    const wrapped = '\\x1b[200~' + content + '\\x1b[201~';\r\n    sendInput(sessionId, wrapped);\r\n  } else {\r\n    // No bracketed paste mode - use standard paste\r\n    state.terminal.paste(data);\r\n  }\r\n}\r\n\r\n/**\r\n * Apply current settings to all existing terminals\r\n */\r\nexport function applySettingsToTerminals(): void {\r\n  const options = getTerminalOptions();\r\n  sessionTerminals.forEach((state) => {\r\n    state.terminal.options.cursorBlink = (options as any).cursorBlink;\r\n    state.terminal.options.cursorStyle = (options as any).cursorStyle;\r\n    state.terminal.options.fontSize = (options as any).fontSize;\r\n    state.terminal.options.theme = (options as any).theme;\r\n  });\r\n}\r\n\r\n/**\r\n * Refresh the active terminal buffer by clearing and requesting via WebSocket.\r\n * Using WebSocket ensures the buffer arrives in-order with live terminal data.\r\n */\r\nexport function refreshActiveTerminalBuffer(): void {\r\n  if (!activeSessionId) return;\r\n  const state = sessionTerminals.get(activeSessionId);\r\n  if (state && state.opened) {\r\n    state.terminal.clear();\r\n    requestBufferRefresh(activeSessionId);\r\n  }\r\n}\r\n\r\n/**\r\n * Preload the terminal font for consistent rendering\r\n */\r\nexport function preloadTerminalFont(): Promise<void> {\r\n  const promise = document.fonts.ready.then(() => {\r\n    // Trigger font load by measuring with the font family\r\n    const testSpan = document.createElement('span');\r\n    testSpan.style.fontFamily = TERMINAL_FONT_STACK;\r\n    testSpan.style.position = 'absolute';\r\n    testSpan.style.left = '-9999px';\r\n    testSpan.textContent = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    document.body.appendChild(testSpan);\r\n\r\n    return new Promise<void>((resolve) => {\r\n      requestAnimationFrame(() => {\r\n        testSpan.remove();\r\n        resolve();\r\n      });\r\n    });\r\n  });\r\n\r\n  setFontsReadyPromise(promise);\r\n  return promise;\r\n}\r\n", "/**\r\n * Terminal Scaling Module\r\n *\r\n * Handles terminal scaling, fitting to screen, and viewport resize handling.\r\n * Terminals maintain server-side dimensions and are scaled to fit the viewport.\r\n */\r\n\r\nimport type { TerminalState } from '../../types';\r\nimport {\r\n  TERMINAL_PADDING,\r\n  MIN_TERMINAL_COLS,\r\n  MIN_TERMINAL_ROWS,\r\n  MAX_TERMINAL_COLS,\r\n  MAX_TERMINAL_ROWS\r\n} from '../../constants';\r\nimport {\r\n  sessionTerminals,\r\n  fontsReadyPromise,\r\n  dom\r\n} from '../../state';\r\n\r\n// Forward declarations for functions from other modules\r\nlet sendResize: (sessionId: string, terminal: any) => void = () => {};\r\n\r\n/**\r\n * Register callbacks from other modules\r\n */\r\nexport function registerScalingCallbacks(callbacks: {\r\n  sendResize?: (sessionId: string, terminal: any) => void;\r\n}): void {\r\n  if (callbacks.sendResize) sendResize = callbacks.sendResize;\r\n}\r\n\r\n/**\r\n * Fit a session's terminal to the current screen size.\r\n * This sends a resize request to the server.\r\n *\r\n * Uses direct measurement of terminalsArea via getBoundingClientRect() rather than\r\n * FitAddon's measurement of the terminal container. This avoids timing issues where\r\n * clearing zoom/scale causes layout to be in flux when measurements occur.\r\n */\r\nexport function fitSessionToScreen(sessionId: string): void {\r\n  const state = sessionTerminals.get(sessionId);\r\n  if (!state) return;\r\n\r\n  // Wait for terminal to be opened before fitting\r\n  if (!state.opened) {\r\n    (fontsReadyPromise ?? Promise.resolve()).then(() => {\r\n      fitSessionToScreen(sessionId);\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Clear any existing scaling first\r\n  const xterm = state.container.querySelector('.xterm') as HTMLElement | null;\r\n  if (xterm) {\r\n    (xterm.style as any).zoom = '';\r\n    xterm.style.transform = '';\r\n    state.container.classList.remove('scaled');\r\n  }\r\n\r\n  // Ensure terminal is visible for accurate measurement\r\n  const wasHidden = state.container.classList.contains('hidden');\r\n  if (wasHidden) {\r\n    state.container.classList.remove('hidden');\r\n  }\r\n\r\n  // Measure terminalsArea directly - this gives us the actual visible area\r\n  // regardless of any layout complexities with the terminal container\r\n  const rect = dom.terminalsArea?.getBoundingClientRect();\r\n  if (!rect || rect.width < 100 || rect.height < 100) {\r\n    if (wasHidden) {\r\n      state.container.classList.add('hidden');\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Get cell dimensions by measuring the terminal's rendered size\r\n  // This avoids depending on xterm.js internal APIs\r\n  const screen = state.container.querySelector('.xterm-screen') as HTMLElement | null;\r\n  const terminalCols = state.terminal.cols;\r\n  const terminalRows = state.terminal.rows;\r\n\r\n  let cellWidth: number | null = null;\r\n  let cellHeight: number | null = null;\r\n\r\n  if (screen && terminalCols > 0 && terminalRows > 0) {\r\n    cellWidth = screen.offsetWidth / terminalCols;\r\n    cellHeight = screen.offsetHeight / terminalRows;\r\n  }\r\n\r\n  if (!cellWidth || !cellHeight || cellWidth < 1 || cellHeight < 1) {\r\n    // Fallback to FitAddon if measurements aren't valid\r\n    requestAnimationFrame(() => {\r\n      try {\r\n        const dims = state.fitAddon.proposeDimensions();\r\n        if (dims?.cols && dims?.rows) {\r\n          state.fitAddon.fit();\r\n          sendResize(sessionId, state.terminal);\r\n        }\r\n      } catch {\r\n        // FitAddon may fail if terminal isn't fully initialized\r\n      }\r\n\r\n      if (wasHidden) {\r\n        state.container.classList.add('hidden');\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Calculate available space (accounting for container padding)\r\n  const availWidth = rect.width - TERMINAL_PADDING;\r\n  const availHeight = rect.height - TERMINAL_PADDING;\r\n\r\n  // Calculate cols/rows that fit in available space\r\n  let cols = Math.floor(availWidth / cellWidth);\r\n  let rows = Math.floor(availHeight / cellHeight);\r\n\r\n  // Clamp to valid range\r\n  cols = Math.max(MIN_TERMINAL_COLS, Math.min(cols, MAX_TERMINAL_COLS));\r\n  rows = Math.max(MIN_TERMINAL_ROWS, Math.min(rows, MAX_TERMINAL_ROWS));\r\n\r\n  // Resize terminal and notify server\r\n  requestAnimationFrame(() => {\r\n    try {\r\n      if (state.terminal.cols !== cols || state.terminal.rows !== rows) {\r\n        state.terminal.resize(cols, rows);\r\n        sendResize(sessionId, state.terminal);\r\n      }\r\n    } catch {\r\n      // Resize may fail if terminal is disposed\r\n    }\r\n\r\n    if (wasHidden) {\r\n      state.container.classList.add('hidden');\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Apply CSS scaling to a terminal to fit within its container.\r\n * Scales down terminals that are larger than the available space.\r\n * Uses CSS zoom instead of transform:scale for better pixel alignment.\r\n */\r\nexport function applyTerminalScaling(_sessionId: string, state: TerminalState): void {\r\n  const container = state.container;\r\n  const xterm = container.querySelector('.xterm') as HTMLElement | null;\r\n  if (!xterm) return;\r\n\r\n  // Use requestAnimationFrame for accurate measurements after resize\r\n  requestAnimationFrame(() => {\r\n    const availWidth = container.clientWidth - 8;\r\n    const availHeight = container.clientHeight - 8;\r\n    const termWidth = xterm.offsetWidth;\r\n    const termHeight = xterm.offsetHeight;\r\n\r\n    // Calculate scale (shrink only, never enlarge)\r\n    const scaleX = availWidth / termWidth;\r\n    const scaleY = availHeight / termHeight;\r\n    const scale = Math.min(scaleX, scaleY, 1);\r\n\r\n    if (scale < 0.99) {\r\n      // Use zoom instead of transform:scale for better pixel alignment\r\n      // zoom respects pixel boundaries, transform can cause subpixel rendering\r\n      (xterm.style as any).zoom = scale;\r\n      xterm.style.transform = '';\r\n      container.classList.add('scaled');\r\n    } else {\r\n      (xterm.style as any).zoom = '';\r\n      xterm.style.transform = '';\r\n      container.classList.remove('scaled');\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Recalculate scaling for all open terminals\r\n */\r\nexport function rescaleAllTerminals(): void {\r\n  sessionTerminals.forEach((state, sessionId) => {\r\n    if (state.opened) {\r\n      applyTerminalScaling(sessionId, state);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Set up resize observer to recalculate scaling when window resizes\r\n */\r\nexport function setupResizeObserver(): void {\r\n  window.addEventListener('resize', rescaleAllTerminals);\r\n}\r\n\r\n/**\r\n * Set up visual viewport handling for mobile keyboard appearance.\r\n * Updates viewport height CSS variable when visual viewport changes.\r\n */\r\nexport function setupVisualViewport(): void {\r\n  if (!window.visualViewport || !dom.terminalsArea) return;\r\n\r\n  let lastHeight = 0;\r\n\r\n  const updateViewportHeight = () => {\r\n    const vh = window.visualViewport!.height;\r\n    if (Math.abs(vh - lastHeight) < 1) return;\r\n    lastHeight = vh;\r\n\r\n    document.documentElement.style.setProperty('--visual-vh', vh + 'px');\r\n\r\n    const mobileHeader = document.querySelector('.mobile-header') as HTMLElement | null;\r\n    let headerHeight = 0;\r\n    if (mobileHeader && window.getComputedStyle(mobileHeader).display !== 'none') {\r\n      headerHeight = mobileHeader.offsetHeight;\r\n    }\r\n\r\n    const availableHeight = Math.floor((vh - headerHeight) * 0.99);\r\n    dom.terminalsArea!.style.height = availableHeight + 'px';\r\n  };\r\n\r\n  window.visualViewport.addEventListener('resize', updateViewportHeight);\r\n  updateViewportHeight();\r\n}\r\n", "/**\r\n * File Drop Module\r\n *\r\n * Handles drag-and-drop file uploads and clipboard image paste.\r\n * Files are uploaded to the server and the resulting path is inserted into the terminal.\r\n */\r\n\r\nimport { activeSessionId } from '../../state';\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst TEXT_FILE_SIZE_LIMIT = 40 * 1024; // 40KB\r\n\r\nconst IMAGE_EXTENSIONS = new Set([\r\n  '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp',\r\n  '.svg', '.ico', '.tiff', '.tif', '.heic', '.heif', '.avif'\r\n]);\r\n\r\nconst REJECTED_EXTENSIONS = new Set([\r\n  // Documents\r\n  '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx',\r\n  '.odt', '.ods', '.odp', '.rtf',\r\n  // Executables/binaries\r\n  '.exe', '.dll', '.so', '.dylib', '.app', '.msi', '.deb', '.rpm', '.dmg', '.iso',\r\n  // Archives\r\n  '.zip', '.tar', '.gz', '.7z', '.rar', '.bz2', '.xz', '.tgz',\r\n  // Binary data\r\n  '.bin', '.dat', '.db', '.sqlite', '.sqlite3',\r\n  // Media (non-image)\r\n  '.mp3', '.mp4', '.wav', '.avi', '.mov', '.mkv', '.flac', '.ogg', '.webm'\r\n]);\r\n\r\n// =============================================================================\r\n// Forward declarations for callbacks\r\n// =============================================================================\r\n\r\nlet pasteToTerminal: (sessionId: string, data: string, isFilePath?: boolean) => void = () => {};\r\n\r\n// =============================================================================\r\n// Helper Functions\r\n// =============================================================================\r\n\r\nfunction getFileExtension(filename: string): string {\r\n  const lastDot = filename.lastIndexOf('.');\r\n  return lastDot >= 0 ? filename.slice(lastDot).toLowerCase() : '';\r\n}\r\n\r\nfunction isImageFile(filename: string): boolean {\r\n  return IMAGE_EXTENSIONS.has(getFileExtension(filename));\r\n}\r\n\r\nfunction isRejectedFile(filename: string): boolean {\r\n  return REJECTED_EXTENSIONS.has(getFileExtension(filename));\r\n}\r\n\r\nfunction showDropToast(message: string): void {\r\n  const existing = document.querySelector('.drop-toast');\r\n  if (existing) existing.remove();\r\n\r\n  const toast = document.createElement('div');\r\n  toast.className = 'drop-toast error';\r\n  toast.textContent = message;\r\n  document.body.appendChild(toast);\r\n\r\n  setTimeout(() => {\r\n    toast.classList.add('hiding');\r\n    setTimeout(() => toast.remove(), 300);\r\n  }, 3000);\r\n}\r\n\r\nasync function readFileAsText(file: File): Promise<string> {\r\n  return new Promise((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    reader.onload = () => resolve(reader.result as string);\r\n    reader.onerror = () => reject(reader.error);\r\n    reader.readAsText(file);\r\n  });\r\n}\r\n\r\n/**\r\n * Sanitize pasted content to:\r\n * 1. Normalize line endings (CRLF/CR \u2192 LF) to prevent interleaved empty lines\r\n * 2. Strip all escape sequences to prevent \"appears then deleted\" bugs\r\n * 3. Remove BPM markers to prevent paste escape attacks\r\n *\r\n * BPM markers are re-added by pasteToTerminal() after sanitization.\r\n */\r\nfunction sanitizePasteContent(text: string): string {\r\n  return text\r\n    .replace(/\\r\\n/g, '\\n')                     // Normalize CRLF \u2192 LF first\r\n    .replace(/\\r(?!\\n)/g, '\\n')                 // Normalize CR \u2192 LF (Mac Classic)\r\n    .replace(/\\x1b\\[[0-9;]*[A-Za-z]/g, '')      // Remove CSI sequences (colors, cursor, clear)\r\n    .replace(/\\x1b\\][^\\x07]*\\x07/g, '')         // Remove OSC sequences (titles, hyperlinks)\r\n    .replace(/\\x1b[PX^_][^\\x1b]*\\x1b\\\\/g, '')   // Remove DCS/SOS/PM/APC sequences\r\n    .replace(/\\x1b[\\x20-\\x2F]*[\\x30-\\x7E]/g, ''); // Remove other escape sequences\r\n}\r\n\r\n/**\r\n * Register callbacks from mux channel and terminal manager\r\n */\r\nexport function registerFileDropCallbacks(callbacks: {\r\n  sendInput?: (sessionId: string, data: string) => void;\r\n  pasteToTerminal?: (sessionId: string, data: string, isFilePath?: boolean) => void;\r\n}): void {\r\n  if (callbacks.pasteToTerminal) pasteToTerminal = callbacks.pasteToTerminal;\r\n}\r\n\r\n/**\r\n * Upload a file to the server for the given session\r\n */\r\nasync function uploadFile(sessionId: string, file: File): Promise<string | null> {\r\n  const formData = new FormData();\r\n  formData.append('file', file);\r\n\r\n  try {\r\n    const response = await fetch(`/api/sessions/${sessionId}/upload`, {\r\n      method: 'POST',\r\n      body: formData\r\n    });\r\n\r\n    if (!response.ok) {\r\n      console.error('File upload failed:', response.status);\r\n      return null;\r\n    }\r\n\r\n    const result = await response.json();\r\n    return result.path;\r\n  } catch (error) {\r\n    console.error('File upload error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Handle file drop - routes to appropriate handler based on file type:\r\n * - Image files: upload and paste path\r\n * - Rejected files (pdf, exe, etc.): show error toast\r\n * - Text files: read content and paste (with 40KB limit)\r\n */\r\nasync function handleFileDrop(files: FileList): Promise<void> {\r\n  if (!activeSessionId || files.length === 0) return;\r\n\r\n  const imagePaths: string[] = [];\r\n\r\n  for (const file of Array.from(files)) {\r\n    // Image files: upload and collect path\r\n    if (isImageFile(file.name)) {\r\n      const path = await uploadFile(activeSessionId, file);\r\n      if (path) imagePaths.push(path);\r\n      continue;\r\n    }\r\n\r\n    // Rejected files: show error toast\r\n    if (isRejectedFile(file.name)) {\r\n      const ext = getFileExtension(file.name);\r\n      showDropToast(`Cannot paste ${ext} files`);\r\n      continue;\r\n    }\r\n\r\n    // Text files: check size limit\r\n    if (file.size > TEXT_FILE_SIZE_LIMIT) {\r\n      showDropToast(`File too large (max 40KB): ${file.name}`);\r\n      continue;\r\n    }\r\n\r\n    // Read and paste text content\r\n    try {\r\n      const content = await readFileAsText(file);\r\n      const sanitized = sanitizePasteContent(content);\r\n      pasteToTerminal(activeSessionId, sanitized, false);\r\n    } catch (err) {\r\n      console.error(`[FileDrop] Failed to read file: ${file.name}`, err);\r\n      showDropToast(`Failed to read: ${file.name}`);\r\n    }\r\n  }\r\n\r\n  // Paste collected image paths (if any)\r\n  if (imagePaths.length > 0) {\r\n    const joined = sanitizePasteContent(imagePaths.join(' '));\r\n    pasteToTerminal(activeSessionId, joined, true);\r\n  }\r\n}\r\n\r\n/**\r\n * Set up drag-and-drop handlers for a terminal container\r\n */\r\nexport function setupFileDrop(container: HTMLElement): void {\r\n  // Prevent default drag behaviors\r\n  container.addEventListener('dragover', (e) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    container.classList.add('drag-over');\r\n  });\r\n\r\n  container.addEventListener('dragleave', (e) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    container.classList.remove('drag-over');\r\n  });\r\n\r\n  container.addEventListener('dragend', () => {\r\n    container.classList.remove('drag-over');\r\n  });\r\n\r\n  // Handle drop\r\n  container.addEventListener('drop', async (e) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    container.classList.remove('drag-over');\r\n\r\n    const files = e.dataTransfer?.files;\r\n    if (files && files.length > 0) {\r\n      await handleFileDrop(files);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Handle clipboard paste - checks for images first, falls back to text\r\n * Used by the keyboard handler in manager.ts\r\n */\r\nexport async function handleClipboardPaste(sessionId: string): Promise<void> {\r\n  // Try to read clipboard items (images)\r\n  try {\r\n    const items = await navigator.clipboard.read();\r\n    for (const item of items) {\r\n      const imageType = item.types.find(t => t.startsWith('image/'));\r\n      if (imageType) {\r\n        const blob = await item.getType(imageType);\r\n        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\r\n        const file = new File([blob], `clipboard_${timestamp}.jpg`, { type: imageType });\r\n        const path = await uploadFile(sessionId, file);\r\n        if (path) {\r\n          pasteToTerminal(sessionId, sanitizePasteContent(path), true);\r\n          return; // Image handled, don't paste text\r\n        }\r\n      }\r\n    }\r\n  } catch {\r\n    // clipboard.read() not supported or failed, fall through to text paste\r\n  }\r\n\r\n  // No image found or image handling failed, paste text\r\n  try {\r\n    const text = await navigator.clipboard.readText();\r\n    if (text) {\r\n      const sanitized = sanitizePasteContent(text);\r\n      pasteToTerminal(sessionId, sanitized);\r\n    }\r\n  } catch {\r\n    // Text paste failed\r\n  }\r\n}\r\n", "/**\r\n * Terminal Search Module\r\n *\r\n * Handles xterm.js search addon functionality, including the search UI,\r\n * keyboard shortcuts, and search result navigation.\r\n */\r\n\r\nimport { sessionTerminals, activeSessionId } from '../../state';\r\n\r\ndeclare const SearchAddon: any;\r\n\r\ninterface SearchState {\r\n  addon: any;\r\n  currentIndex: number;\r\n  totalMatches: number;\r\n}\r\n\r\nconst searchStates = new Map<string, SearchState>();\r\n\r\nlet searchVisible = false;\r\nlet searchInput: HTMLInputElement | null = null;\r\nlet searchResults: HTMLElement | null = null;\r\nlet searchContainer: HTMLElement | null = null;\r\n\r\n/**\r\n * Initialize search addon for a terminal\r\n */\r\nexport function initSearchForTerminal(sessionId: string, terminal: any): void {\r\n  try {\r\n    const addon = new SearchAddon.SearchAddon();\r\n    terminal.loadAddon(addon);\r\n    searchStates.set(sessionId, { addon, currentIndex: 0, totalMatches: 0 });\r\n  } catch {\r\n    // Search addon failed to load\r\n  }\r\n}\r\n\r\n/**\r\n * Clean up search state for a session\r\n */\r\nexport function cleanupSearchForTerminal(sessionId: string): void {\r\n  searchStates.delete(sessionId);\r\n}\r\n\r\n/**\r\n * Show the search UI\r\n */\r\nexport function showSearch(): void {\r\n  if (!searchContainer) {\r\n    searchContainer = document.getElementById('terminal-search');\r\n    searchInput = document.getElementById('search-input') as HTMLInputElement;\r\n    searchResults = document.getElementById('search-results');\r\n  }\r\n\r\n  if (searchContainer && searchInput) {\r\n    searchContainer.classList.remove('hidden');\r\n    searchVisible = true;\r\n    searchInput.focus();\r\n    searchInput.select();\r\n  }\r\n}\r\n\r\n/**\r\n * Hide the search UI\r\n */\r\nexport function hideSearch(): void {\r\n  if (searchContainer) {\r\n    searchContainer.classList.add('hidden');\r\n    searchVisible = false;\r\n  }\r\n\r\n  // Clear decorations from active terminal\r\n  if (activeSessionId) {\r\n    const state = searchStates.get(activeSessionId);\r\n    if (state?.addon) {\r\n      state.addon.clearDecorations();\r\n    }\r\n  }\r\n\r\n  // Return focus to terminal\r\n  if (activeSessionId) {\r\n    const termState = sessionTerminals.get(activeSessionId);\r\n    if (termState) {\r\n      termState.terminal.focus();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Check if search is visible\r\n */\r\nexport function isSearchVisible(): boolean {\r\n  return searchVisible;\r\n}\r\n\r\n/**\r\n * Find next match\r\n */\r\nexport function findNext(): void {\r\n  if (!activeSessionId || !searchInput) return;\r\n\r\n  const query = searchInput.value;\r\n  if (!query) return;\r\n\r\n  const state = searchStates.get(activeSessionId);\r\n  if (!state?.addon) return;\r\n\r\n  const result = state.addon.findNext(query, { incremental: false });\r\n  updateSearchResults(result);\r\n}\r\n\r\n/**\r\n * Find previous match\r\n */\r\nexport function findPrevious(): void {\r\n  if (!activeSessionId || !searchInput) return;\r\n\r\n  const query = searchInput.value;\r\n  if (!query) return;\r\n\r\n  const state = searchStates.get(activeSessionId);\r\n  if (!state?.addon) return;\r\n\r\n  const result = state.addon.findPrevious(query);\r\n  updateSearchResults(result);\r\n}\r\n\r\n/**\r\n * Update search results display\r\n */\r\nfunction updateSearchResults(found: boolean): void {\r\n  if (searchResults) {\r\n    if (found) {\r\n      searchResults.textContent = 'Found';\r\n      searchResults.style.color = '';\r\n    } else {\r\n      searchResults.textContent = 'No matches';\r\n      searchResults.style.color = 'var(--accent-red)';\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Bind search UI event handlers\r\n */\r\nexport function bindSearchEvents(): void {\r\n  const searchInput = document.getElementById('search-input') as HTMLInputElement;\r\n  const prevBtn = document.getElementById('search-prev');\r\n  const nextBtn = document.getElementById('search-next');\r\n  const closeBtn = document.getElementById('search-close');\r\n\r\n  if (searchInput) {\r\n    searchInput.addEventListener('input', () => {\r\n      if (activeSessionId && searchInput.value) {\r\n        findNext();\r\n      } else if (searchResults) {\r\n        searchResults.textContent = '0/0';\r\n        searchResults.style.color = '';\r\n      }\r\n    });\r\n\r\n    searchInput.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        e.preventDefault();\r\n        if (e.shiftKey) {\r\n          findPrevious();\r\n        } else {\r\n          findNext();\r\n        }\r\n      } else if (e.key === 'Escape') {\r\n        e.preventDefault();\r\n        hideSearch();\r\n      }\r\n    });\r\n  }\r\n\r\n  if (prevBtn) {\r\n    prevBtn.addEventListener('click', findPrevious);\r\n  }\r\n\r\n  if (nextBtn) {\r\n    nextBtn.addEventListener('click', findNext);\r\n  }\r\n\r\n  if (closeBtn) {\r\n    closeBtn.addEventListener('click', hideSearch);\r\n  }\r\n}\r\n", "/**\r\n * Session List Module\r\n *\r\n * Handles rendering and updating the sidebar session list,\r\n * including empty state and mobile title updates.\r\n */\r\n\r\nimport type { Session } from '../../types';\r\nimport {\r\n  sessions,\r\n  activeSessionId,\r\n  settingsOpen,\r\n  pendingSessions,\r\n  dom\r\n} from '../../state';\r\nimport { icon } from '../../constants';\r\n\r\n// =============================================================================\r\n// Callback Types\r\n// =============================================================================\r\n\r\n/** Callbacks for session list interactions */\r\nexport interface SessionListCallbacks {\r\n  onSelect: (sessionId: string) => void;\r\n  onDelete: (sessionId: string) => void;\r\n  onRename: (sessionId: string) => void;\r\n  onResize: (sessionId: string) => void;\r\n  onCloseSidebar: () => void;\r\n}\r\n\r\nlet callbacks: SessionListCallbacks | null = null;\r\n\r\n// =============================================================================\r\n// Initialization\r\n// =============================================================================\r\n\r\n/**\r\n * Set callbacks for session list interactions\r\n */\r\nexport function setSessionListCallbacks(cbs: SessionListCallbacks): void {\r\n  callbacks = cbs;\r\n}\r\n\r\n// =============================================================================\r\n// Session Display\r\n// =============================================================================\r\n\r\ninterface SessionDisplayInfo {\r\n  primary: string;\r\n  secondary: string | null;\r\n}\r\n\r\n/**\r\n * Get display info for a session (primary title and optional secondary subtitle)\r\n */\r\nexport function getSessionDisplayInfo(session: Session): SessionDisplayInfo {\r\n  const termTitle = session.terminalTitle || session.shellType;\r\n  if (session.name) {\r\n    return { primary: session.name, secondary: termTitle };\r\n  }\r\n  return { primary: termTitle, secondary: null };\r\n}\r\n\r\n/**\r\n * Get the display name for a session (primary title only, for mobile/island)\r\n */\r\nexport function getSessionDisplayName(session: Session): string {\r\n  const info = getSessionDisplayInfo(session);\r\n  return info.primary;\r\n}\r\n\r\n// =============================================================================\r\n// Rendering\r\n// =============================================================================\r\n\r\n/**\r\n * Render the session list in the sidebar\r\n */\r\nexport function renderSessionList(): void {\r\n  if (!dom.sessionList) return;\r\n\r\n  dom.sessionList.innerHTML = '';\r\n\r\n  sessions.forEach((session) => {\r\n    const isPending = pendingSessions.has(session.id);\r\n    const item = document.createElement('div');\r\n    item.className = 'session-item' +\r\n      (session.id === activeSessionId ? ' active' : '') +\r\n      (isPending ? ' pending' : '');\r\n    item.dataset.sessionId = session.id;\r\n\r\n    if (!isPending) {\r\n      item.addEventListener('click', () => {\r\n        if (callbacks) {\r\n          callbacks.onSelect(session.id);\r\n          callbacks.onCloseSidebar();\r\n        }\r\n      });\r\n    }\r\n\r\n    const info = document.createElement('div');\r\n    info.className = 'session-info';\r\n\r\n    if (isPending) {\r\n      const spinner = document.createElement('span');\r\n      spinner.className = 'session-spinner';\r\n      info.appendChild(spinner);\r\n    }\r\n\r\n    const displayInfo = getSessionDisplayInfo(session);\r\n\r\n    const title = document.createElement('span');\r\n    title.className = 'session-title';\r\n    title.textContent = displayInfo.primary;\r\n    info.appendChild(title);\r\n\r\n    if (displayInfo.secondary) {\r\n      item.classList.add('two-line');\r\n      const subtitle = document.createElement('span');\r\n      subtitle.className = 'session-subtitle';\r\n      subtitle.textContent = displayInfo.secondary;\r\n      info.appendChild(subtitle);\r\n    }\r\n\r\n    const actions = document.createElement('div');\r\n    actions.className = 'session-actions';\r\n\r\n    if (!isPending) {\r\n      const resizeBtn = document.createElement('button');\r\n      resizeBtn.className = 'session-resize';\r\n      resizeBtn.innerHTML = icon('resize');\r\n      resizeBtn.title = 'Fit to screen';\r\n      resizeBtn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        if (callbacks) {\r\n          callbacks.onResize(session.id);\r\n        }\r\n      });\r\n\r\n      const renameBtn = document.createElement('button');\r\n      renameBtn.className = 'session-rename';\r\n      renameBtn.innerHTML = icon('rename');\r\n      renameBtn.title = 'Rename session';\r\n      renameBtn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        if (callbacks) {\r\n          callbacks.onRename(session.id);\r\n        }\r\n      });\r\n\r\n      const closeBtn = document.createElement('button');\r\n      closeBtn.className = 'session-close';\r\n      closeBtn.innerHTML = icon('close');\r\n      closeBtn.title = 'Close session';\r\n      closeBtn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        if (callbacks) {\r\n          callbacks.onDelete(session.id);\r\n        }\r\n      });\r\n\r\n      actions.appendChild(resizeBtn);\r\n      actions.appendChild(renameBtn);\r\n      actions.appendChild(closeBtn);\r\n    }\r\n\r\n    item.appendChild(info);\r\n    item.appendChild(actions);\r\n    dom.sessionList!.appendChild(item);\r\n  });\r\n\r\n  // Count only non-pending sessions\r\n  const realSessionCount = sessions.filter((s) => !pendingSessions.has(s.id)).length;\r\n  if (dom.sessionCount) {\r\n    dom.sessionCount.textContent = String(realSessionCount);\r\n  }\r\n}\r\n\r\n/**\r\n * Update the empty state visibility based on session count\r\n */\r\nexport function updateEmptyState(): void {\r\n  if (!dom.emptyState) return;\r\n\r\n  if (sessions.length === 0) {\r\n    dom.emptyState.classList.remove('hidden');\r\n    if (dom.settingsView) dom.settingsView.classList.add('hidden');\r\n  } else if (!settingsOpen) {\r\n    dom.emptyState.classList.add('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Update the mobile title bar with current session name.\r\n * Also updates the desktop collapsed title bar.\r\n */\r\nexport function updateMobileTitle(): void {\r\n  if (!dom.mobileTitle) return;\r\n\r\n  const session = sessions.find((s) => s.id === activeSessionId);\r\n  dom.mobileTitle.textContent = session ? getSessionDisplayName(session) : 'MidTerm';\r\n\r\n  if (dom.topbarActions) {\r\n    if (session) {\r\n      dom.topbarActions.classList.remove('no-terminal');\r\n    } else {\r\n      dom.topbarActions.classList.add('no-terminal');\r\n    }\r\n  }\r\n\r\n  // Also update the desktop collapsed title bar\r\n  updateTitleBar(session);\r\n}\r\n\r\n/**\r\n * Update the collapsed title bar with current session info\r\n */\r\nfunction updateTitleBar(session: Session | undefined): void {\r\n  if (!dom.titleBarCustom || !dom.titleBarTerminal || !dom.titleBarSeparator) return;\r\n\r\n  if (!session) {\r\n    dom.titleBarCustom.textContent = 'MidTerm';\r\n    dom.titleBarTerminal.textContent = '';\r\n    dom.titleBarSeparator.style.display = 'none';\r\n    return;\r\n  }\r\n\r\n  const info = getSessionDisplayInfo(session);\r\n\r\n  if (session.name) {\r\n    dom.titleBarCustom.textContent = info.primary;\r\n    dom.titleBarTerminal.textContent = info.secondary || '';\r\n    dom.titleBarSeparator.style.display = info.secondary ? '' : 'none';\r\n  } else {\r\n    dom.titleBarCustom.textContent = info.primary;\r\n    dom.titleBarTerminal.textContent = '';\r\n    dom.titleBarSeparator.style.display = 'none';\r\n  }\r\n}\r\n", "/**\r\n * Sidebar Collapse Module\r\n *\r\n * Handles sidebar visibility, collapse/expand state,\r\n * and island title updates for desktop view.\r\n */\r\n\r\nimport {\r\n  sidebarOpen,\r\n  setSidebarOpen,\r\n  setSidebarCollapsed,\r\n  dom\r\n} from '../../state';\r\nimport { getCookie, setCookie } from '../../utils';\r\nimport { updateMobileTitle } from './sessionList';\r\nimport { rescaleAllTerminals } from '../terminal/scaling';\r\n\r\n// =============================================================================\r\n// Cookie Constants\r\n// =============================================================================\r\n\r\nconst SIDEBAR_COLLAPSED_COOKIE = 'mm-sidebar-collapsed';\r\nconst SIDEBAR_WIDTH_COOKIE = 'mm-sidebar-width';\r\nconst DESKTOP_BREAKPOINT = 768;\r\nconst MIN_SIDEBAR_WIDTH = 180;\r\nconst MAX_SIDEBAR_WIDTH = 400;\r\n\r\n// =============================================================================\r\n// Mobile Sidebar Toggle\r\n// =============================================================================\r\n\r\n/**\r\n * Toggle mobile sidebar visibility\r\n */\r\nexport function toggleSidebar(): void {\r\n  setSidebarOpen(!sidebarOpen);\r\n  if (dom.app) dom.app.classList.toggle('sidebar-open', sidebarOpen);\r\n}\r\n\r\n/**\r\n * Close mobile sidebar\r\n */\r\nexport function closeSidebar(): void {\r\n  setSidebarOpen(false);\r\n  if (dom.app) dom.app.classList.remove('sidebar-open');\r\n}\r\n\r\n// =============================================================================\r\n// Desktop Sidebar Collapse\r\n// =============================================================================\r\n\r\n/**\r\n * Collapse sidebar to icon-only mode (desktop)\r\n */\r\nexport function collapseSidebar(): void {\r\n  setSidebarCollapsed(true);\r\n  if (dom.app) dom.app.classList.add('sidebar-collapsed');\r\n  setCookie(SIDEBAR_COLLAPSED_COOKIE, 'true');\r\n  updateMobileTitle();\r\n  requestAnimationFrame(rescaleAllTerminals);\r\n}\r\n\r\n/**\r\n * Expand sidebar to full width (desktop)\r\n */\r\nexport function expandSidebar(): void {\r\n  setSidebarCollapsed(false);\r\n  if (dom.app) dom.app.classList.remove('sidebar-collapsed');\r\n  setCookie(SIDEBAR_COLLAPSED_COOKIE, 'false');\r\n  requestAnimationFrame(rescaleAllTerminals);\r\n}\r\n\r\n// =============================================================================\r\n// State Restoration\r\n// =============================================================================\r\n\r\n/**\r\n * Restore sidebar collapsed state from cookie (desktop only)\r\n */\r\nexport function restoreSidebarState(): void {\r\n  if (getCookie(SIDEBAR_COLLAPSED_COOKIE) === 'true' && window.innerWidth > DESKTOP_BREAKPOINT) {\r\n    setSidebarCollapsed(true);\r\n    if (dom.app) dom.app.classList.add('sidebar-collapsed');\r\n  }\r\n\r\n  // Restore sidebar width\r\n  const savedWidth = getCookie(SIDEBAR_WIDTH_COOKIE);\r\n  if (savedWidth) {\r\n    const width = parseInt(savedWidth, 10);\r\n    if (width >= MIN_SIDEBAR_WIDTH && width <= MAX_SIDEBAR_WIDTH) {\r\n      const sidebar = document.getElementById('sidebar');\r\n      if (sidebar) {\r\n        sidebar.style.width = width + 'px';\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Sidebar Resize\r\n// =============================================================================\r\n\r\n/**\r\n * Set up sidebar resize grip functionality\r\n */\r\nexport function setupSidebarResize(): void {\r\n  const grip = document.getElementById('sidebar-resize-grip');\r\n  const sidebar = document.getElementById('sidebar');\r\n  if (!grip || !sidebar) return;\r\n\r\n  let isResizing = false;\r\n  let startX = 0;\r\n  let startWidth = 0;\r\n\r\n  grip.addEventListener('mousedown', (e: MouseEvent) => {\r\n    isResizing = true;\r\n    startX = e.clientX;\r\n    startWidth = sidebar.offsetWidth;\r\n    grip.classList.add('active');\r\n    document.body.style.cursor = 'ew-resize';\r\n    document.body.style.userSelect = 'none';\r\n    e.preventDefault();\r\n  });\r\n\r\n  document.addEventListener('mousemove', (e: MouseEvent) => {\r\n    if (!isResizing) return;\r\n\r\n    const delta = e.clientX - startX;\r\n    const newWidth = Math.max(MIN_SIDEBAR_WIDTH, Math.min(MAX_SIDEBAR_WIDTH, startWidth + delta));\r\n    sidebar.style.width = newWidth + 'px';\r\n    rescaleAllTerminals();\r\n  });\r\n\r\n  document.addEventListener('mouseup', () => {\r\n    if (!isResizing) return;\r\n\r\n    isResizing = false;\r\n    grip.classList.remove('active');\r\n    document.body.style.cursor = '';\r\n    document.body.style.userSelect = '';\r\n\r\n    // Save width to cookie\r\n    const currentWidth = sidebar.offsetWidth;\r\n    setCookie(SIDEBAR_WIDTH_COOKIE, String(currentWidth));\r\n  });\r\n}\r\n", "/**\r\n * MidTerm Terminal Client\r\n *\r\n * Web-based terminal multiplexer frontend using xterm.js.\r\n * Main entry point - wires together all modules.\r\n */\r\n\r\nimport { initThemeFromCookie } from './modules/theming';\r\nimport {\r\n  initLogStorage,\r\n  createLogger,\r\n  setLogLevel,\r\n  setConsoleLogging,\r\n  LogLevel\r\n} from './modules/logging';\r\nimport {\r\n  connectStateWebSocket,\r\n  connectMuxWebSocket,\r\n  connectSettingsWebSocket,\r\n  registerStateCallbacks,\r\n  registerMuxCallbacks,\r\n  registerSettingsCallbacks,\r\n  sendInput,\r\n  sendResize,\r\n  requestBufferRefresh,\r\n  sendActiveSessionHint\r\n} from './modules/comms';\r\nimport {\r\n  createTerminalForSession,\r\n  destroyTerminalForSession,\r\n  preloadTerminalFont,\r\n  registerTerminalCallbacks,\r\n  applyTerminalScaling,\r\n  fitSessionToScreen,\r\n  setupResizeObserver,\r\n  setupVisualViewport,\r\n  registerScalingCallbacks,\r\n  bindSearchEvents,\r\n  registerFileDropCallbacks,\r\n  pasteToTerminal\r\n} from './modules/terminal';\r\nimport {\r\n  renderSessionList,\r\n  updateEmptyState,\r\n  updateMobileTitle,\r\n  getSessionDisplayName,\r\n  setSessionListCallbacks,\r\n  toggleSidebar,\r\n  closeSidebar,\r\n  collapseSidebar,\r\n  expandSidebar,\r\n  restoreSidebarState,\r\n  setupSidebarResize\r\n} from './modules/sidebar';\r\nimport {\r\n  toggleSettings,\r\n  closeSettings,\r\n  checkSystemHealth,\r\n  fetchSettings,\r\n  applyReceivedSettings\r\n} from './modules/settings';\r\nimport {\r\n  checkAuthStatus,\r\n  bindAuthEvents\r\n} from './modules/auth';\r\nimport {\r\n  renderUpdatePanel,\r\n  applyUpdate,\r\n  checkForUpdates,\r\n  checkUpdateResult,\r\n  showChangelog,\r\n  closeChangelog\r\n} from './modules/updating';\r\nimport { initDiagnosticsPanel } from './modules/diagnostics';\r\nimport {\r\n  cacheDOMElements,\r\n  sessions,\r\n  activeSessionId,\r\n  sessionTerminals,\r\n  currentSettings,\r\n  stateWsConnected,\r\n  muxWsConnected,\r\n  dom,\r\n  setActiveSessionId,\r\n  setFontsReadyPromise,\r\n  newlyCreatedSessions,\r\n  pendingSessions\r\n} from './state';\r\nimport {\r\n  FONT_CHAR_WIDTH_RATIO,\r\n  FONT_LINE_HEIGHT_RATIO,\r\n  TERMINAL_PADDING,\r\n  MIN_TERMINAL_COLS,\r\n  MIN_TERMINAL_ROWS,\r\n  MAX_TERMINAL_COLS,\r\n  MAX_TERMINAL_ROWS\r\n} from './constants';\r\nimport { bindClick, escapeHtml } from './utils';\r\n\r\n// Create logger for main module\r\nconst log = createLogger('main');\r\n\r\n// Debug export for console access\r\n(window as any).mmDebug = {\r\n  get terminals() { return sessionTerminals; },\r\n  get activeId() { return activeSessionId; },\r\n  get settings() { return currentSettings; }\r\n};\r\n\r\n// =============================================================================\r\n// Initialization\r\n// =============================================================================\r\n\r\ninitThemeFromCookie();\r\n\r\ndocument.addEventListener('DOMContentLoaded', init);\r\n\r\nasync function init(): Promise<void> {\r\n  // Initialize logging first\r\n  await initLogStorage();\r\n  setLogLevel(LogLevel.Info);\r\n  setConsoleLogging(false);\r\n  log.info(() => 'MidTerm frontend initializing');\r\n\r\n  cacheDOMElements();\r\n  restoreSidebarState();\r\n  setupSidebarResize();\r\n\r\n  const fontPromise = preloadTerminalFont();\r\n  setFontsReadyPromise(fontPromise);\r\n\r\n  registerCallbacks();\r\n  connectStateWebSocket();\r\n  connectMuxWebSocket();\r\n  connectSettingsWebSocket();\r\n  checkSystemHealth();\r\n\r\n  bindEvents();\r\n  bindAuthEvents();\r\n  bindSearchEvents();\r\n  setupResizeObserver();\r\n  setupVisualViewport();\r\n\r\n  fetchVersion();\r\n  fetchNetworks();\r\n  fetchSettings();\r\n  checkAuthStatus();\r\n  checkUpdateResult();\r\n  requestNotificationPermission();\r\n  initDiagnosticsPanel();\r\n\r\n  setupVisibilityChangeHandler();\r\n  log.info(() => 'MidTerm frontend initialized');\r\n}\r\n\r\n// =============================================================================\r\n// Callback Registration\r\n// =============================================================================\r\n\r\nfunction registerCallbacks(): void {\r\n  registerStateCallbacks({\r\n    destroyTerminalForSession,\r\n    applyTerminalScaling,\r\n    renderSessionList,\r\n    updateEmptyState,\r\n    selectSession,\r\n    updateMobileTitle,\r\n    renderUpdatePanel\r\n  });\r\n\r\n  registerMuxCallbacks({\r\n    applyTerminalScaling\r\n  });\r\n\r\n  registerSettingsCallbacks({\r\n    applyReceivedSettings\r\n  });\r\n\r\n  registerTerminalCallbacks({\r\n    sendInput,\r\n    showBellNotification,\r\n    requestBufferRefresh\r\n  });\r\n\r\n  registerFileDropCallbacks({\r\n    sendInput,\r\n    pasteToTerminal\r\n  });\r\n\r\n  registerScalingCallbacks({\r\n    sendResize: (sessionId: string, terminal: { cols: number; rows: number }) => {\r\n      sendResize(sessionId, terminal.cols, terminal.rows);\r\n    }\r\n  });\r\n\r\n  setSessionListCallbacks({\r\n    onSelect: selectSession,\r\n    onDelete: deleteSession,\r\n    onRename: startInlineRename,\r\n    onResize: fitSessionToScreen,\r\n    onCloseSidebar: closeSidebar\r\n  });\r\n}\r\n\r\n// =============================================================================\r\n// Visibility Change Handler\r\n// =============================================================================\r\n\r\nfunction setupVisibilityChangeHandler(): void {\r\n  document.addEventListener('visibilitychange', () => {\r\n    if (document.visibilityState === 'visible') {\r\n      // Reconnect WebSockets if they were dropped while in background\r\n      // Buffer refresh is handled by muxChannel's reconnect handler if needed\r\n      if (!stateWsConnected) {\r\n        connectStateWebSocket();\r\n      }\r\n      if (!muxWsConnected) {\r\n        connectMuxWebSocket();\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n// =============================================================================\r\n// Session Management\r\n// =============================================================================\r\n\r\nfunction createSession(): void {\r\n  const rect = dom.terminalsArea?.getBoundingClientRect();\r\n  let cols = currentSettings?.defaultCols ?? 120;\r\n  let rows = currentSettings?.defaultRows ?? 30;\r\n\r\n  if (rect && rect.width > 100 && rect.height > 100) {\r\n    const fontSize = currentSettings?.fontSize ?? 14;\r\n    const charWidth = fontSize * FONT_CHAR_WIDTH_RATIO;\r\n    const lineHeight = fontSize * FONT_LINE_HEIGHT_RATIO;\r\n\r\n    const availWidth = rect.width - TERMINAL_PADDING;\r\n    const availHeight = rect.height - TERMINAL_PADDING;\r\n\r\n    const measuredCols = Math.floor(availWidth / charWidth);\r\n    const measuredRows = Math.floor(availHeight / lineHeight);\r\n\r\n    if (measuredCols > MIN_TERMINAL_COLS && measuredRows > MIN_TERMINAL_ROWS) {\r\n      cols = Math.min(measuredCols, MAX_TERMINAL_COLS);\r\n      rows = Math.min(measuredRows, MAX_TERMINAL_ROWS);\r\n    }\r\n  }\r\n\r\n  // Optimistic UI: add temporary session with spinner\r\n  const tempId = 'pending-' + crypto.randomUUID();\r\n  const tempSession = {\r\n    id: tempId,\r\n    name: null,\r\n    terminalTitle: null,\r\n    shellType: 'Loading...',\r\n    cols: cols,\r\n    rows: rows\r\n  };\r\n  sessions.push(tempSession);\r\n  pendingSessions.add(tempId);\r\n  renderSessionList();\r\n  closeSidebar();\r\n\r\n  fetch('/api/sessions', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ Cols: cols, Rows: rows })\r\n  })\r\n    .then((r) => r.json())\r\n    .then((session) => {\r\n      // Remove temporary session\r\n      pendingSessions.delete(tempId);\r\n      const idx = sessions.findIndex((s) => s.id === tempId);\r\n      if (idx >= 0) {\r\n        sessions.splice(idx, 1);\r\n      }\r\n\r\n      newlyCreatedSessions.add(session.id);\r\n      selectSession(session.id);\r\n    })\r\n    .catch((e) => {\r\n      // Remove temporary session on error\r\n      pendingSessions.delete(tempId);\r\n      const idx = sessions.findIndex((s) => s.id === tempId);\r\n      if (idx >= 0) {\r\n        sessions.splice(idx, 1);\r\n        renderSessionList();\r\n        updateEmptyState();\r\n      }\r\n      log.error(() => `Failed to create session: ${e}`);\r\n    });\r\n}\r\n\r\nfunction selectSession(sessionId: string): void {\r\n  closeSettings();\r\n  sessionTerminals.forEach((state) => {\r\n    state.container.classList.add('hidden');\r\n  });\r\n\r\n  setActiveSessionId(sessionId);\r\n  sendActiveSessionHint(sessionId);\r\n\r\n  const sessionInfo = sessions.find((s) => s.id === sessionId);\r\n  const state = createTerminalForSession(sessionId, sessionInfo);\r\n  const isNewlyCreated = newlyCreatedSessions.has(sessionId);\r\n  state.container.classList.remove('hidden');\r\n\r\n  requestAnimationFrame(() => {\r\n    state.terminal.focus();\r\n\r\n    // Server pushes all buffers on WS connect, no need to request again\r\n    if (isNewlyCreated) {\r\n      newlyCreatedSessions.delete(sessionId);\r\n    }\r\n  });\r\n\r\n  renderSessionList();\r\n  updateMobileTitle();\r\n  dom.emptyState?.classList.add('hidden');\r\n}\r\n\r\nfunction deleteSession(sessionId: string): void {\r\n  // Optimistic UI: remove session immediately for better UX\r\n  destroyTerminalForSession(sessionId);\r\n\r\n  // Remove from local sessions array\r\n  const idx = sessions.findIndex((s) => s.id === sessionId);\r\n  if (idx >= 0) {\r\n    sessions.splice(idx, 1);\r\n  }\r\n\r\n  // If this was the active session, select another\r\n  if (activeSessionId === sessionId) {\r\n    setActiveSessionId(null);\r\n    const firstSession = sessions[0];\r\n    if (firstSession) {\r\n      selectSession(firstSession.id);\r\n    }\r\n  }\r\n\r\n  renderSessionList();\r\n  updateEmptyState();\r\n  updateMobileTitle();\r\n\r\n  // Send delete request to server\r\n  fetch('/api/sessions/' + sessionId, { method: 'DELETE' }).catch((e) => {\r\n    log.error(() => `Failed to delete session ${sessionId}: ${e}`);\r\n  });\r\n}\r\n\r\nfunction renameSession(sessionId: string, newName: string | null): void {\r\n  const session = sessions.find((s) => s.id === sessionId);\r\n  if (!session) return;\r\n\r\n  const trimmedName = (newName || '').trim();\r\n  const nameToSend = trimmedName === '' || trimmedName === session.shellType ? null : trimmedName;\r\n\r\n  fetch('/api/sessions/' + sessionId + '/name', {\r\n    method: 'PUT',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ name: nameToSend })\r\n  })\r\n    .then(() => {\r\n      session.manuallyNamed = true;\r\n    })\r\n    .catch((e) => {\r\n      log.error(() => `Failed to rename session ${sessionId}: ${e}`);\r\n    });\r\n}\r\n\r\nfunction startInlineRename(sessionId: string): void {\r\n  const item = dom.sessionList?.querySelector(`[data-session-id=\"${sessionId}\"]`);\r\n  if (!item) return;\r\n\r\n  const titleSpan = item.querySelector('.session-title');\r\n  if (!titleSpan) return;\r\n\r\n  const session = sessions.find((s) => s.id === sessionId);\r\n  const currentName = session ? (session.name || session.shellType) : '';\r\n\r\n  const input = document.createElement('input');\r\n  input.type = 'text';\r\n  input.className = 'session-rename-input';\r\n  input.value = currentName;\r\n\r\n  function finishRename(): void {\r\n    renameSession(sessionId, input.value);\r\n    input.replaceWith(titleSpan as Node);\r\n  }\r\n\r\n  input.addEventListener('blur', finishRename);\r\n  input.addEventListener('keydown', (e) => {\r\n    if (e.key === 'Enter') {\r\n      e.preventDefault();\r\n      input.blur();\r\n    } else if (e.key === 'Escape') {\r\n      e.preventDefault();\r\n      input.replaceWith(titleSpan);\r\n    }\r\n  });\r\n\r\n  titleSpan.replaceWith(input);\r\n  input.focus();\r\n  input.select();\r\n}\r\n\r\nfunction promptRenameSession(sessionId: string): void {\r\n  const session = sessions.find((s) => s.id === sessionId);\r\n  if (!session) return;\r\n\r\n  const currentName = session.name || session.shellType;\r\n  const newName = prompt('Rename terminal:', currentName);\r\n\r\n  if (newName !== null) {\r\n    renameSession(sessionId, newName);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Notifications\r\n// =============================================================================\r\n\r\nfunction requestNotificationPermission(): void {\r\n  if (!('Notification' in window)) return;\r\n  if (Notification.permission === 'default') {\r\n    Notification.requestPermission().catch(() => {});\r\n  }\r\n}\r\n\r\nfunction showBellNotification(sessionId: string): void {\r\n  if (!currentSettings) return;\r\n\r\n  const bellStyle = currentSettings.bellStyle || 'notification';\r\n  const session = sessions.find((s) => s.id === sessionId);\r\n  const title = session ? getSessionDisplayName(session) : 'Terminal';\r\n\r\n  if ((bellStyle === 'notification' || bellStyle === 'both') &&\r\n      Notification.permission === 'granted' && document.hidden) {\r\n    new Notification('Bell: ' + title, {\r\n      body: 'Terminal bell triggered',\r\n      icon: '/favicon.ico'\r\n    });\r\n  }\r\n\r\n  if (bellStyle === 'visual' || bellStyle === 'both') {\r\n    const state = sessionTerminals.get(sessionId);\r\n    if (state) {\r\n      state.container.classList.add('bell-flash');\r\n      setTimeout(() => {\r\n        state.container.classList.remove('bell-flash');\r\n      }, 200);\r\n    }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// API Helpers\r\n// =============================================================================\r\n\r\nfunction fetchVersion(): void {\r\n  fetch('/api/version')\r\n    .then((r) => r.text())\r\n    .then((v) => {\r\n      // Strip git hash suffix but preserve (DEV) indicator\r\n      const version = v.replace(/[+-][a-f0-9]+$/i, '');\r\n      const el = document.getElementById('app-version');\r\n      if (el) el.textContent = 'v' + version;\r\n    })\r\n    .catch(() => {});\r\n}\r\n\r\nfunction fetchNetworks(): void {\r\n  fetch('/api/networks')\r\n    .then((r) => r.json())\r\n    .then((networks) => {\r\n      const list = document.getElementById('network-list');\r\n      if (!list) return;\r\n\r\n      const protocol = location.protocol;\r\n      const port = location.port;\r\n      list.innerHTML = networks.map((n: { name: string; ip: string }) => {\r\n        const url = protocol + '//' + n.ip + ':' + port;\r\n        return '<div class=\"network-item\">' +\r\n          '<span class=\"network-name\" title=\"' + escapeHtml(n.name) + '\">' +\r\n          escapeHtml(n.name) + '</span>' +\r\n          '<a class=\"network-url\" href=\"' + url + '\" target=\"_blank\">' +\r\n          escapeHtml(n.ip) + ':' + port + '</a>' +\r\n          '</div>';\r\n      }).join('');\r\n    })\r\n    .catch(() => {});\r\n}\r\n\r\n// =============================================================================\r\n// Event Binding\r\n// =============================================================================\r\n\r\nfunction bindEvents(): void {\r\n  bindClick('btn-new-session', createSession);\r\n  bindClick('btn-new-session-mobile', createSession);\r\n  bindClick('btn-create-terminal', createSession);\r\n\r\n  bindClick('btn-hamburger', toggleSidebar);\r\n  bindClick('btn-collapse-sidebar', collapseSidebar);\r\n  bindClick('btn-expand-sidebar', expandSidebar);\r\n\r\n  if (dom.sidebarOverlay) {\r\n    dom.sidebarOverlay.addEventListener('click', closeSidebar);\r\n  }\r\n\r\n  bindClick('btn-ctrlc-mobile', () => {\r\n    if (activeSessionId) sendInput(activeSessionId, '\\x03');\r\n  });\r\n  bindClick('btn-resize-mobile', () => {\r\n    if (activeSessionId) fitSessionToScreen(activeSessionId);\r\n  });\r\n  bindClick('btn-resize-titlebar', () => {\r\n    if (activeSessionId) fitSessionToScreen(activeSessionId);\r\n  });\r\n  bindClick('btn-rename-mobile', () => {\r\n    if (activeSessionId) promptRenameSession(activeSessionId);\r\n  });\r\n  bindClick('btn-rename-titlebar', () => {\r\n    if (activeSessionId) promptRenameSession(activeSessionId);\r\n  });\r\n  bindClick('btn-close-mobile', () => {\r\n    if (activeSessionId) deleteSession(activeSessionId);\r\n  });\r\n\r\n  if (dom.settingsBtn) {\r\n    dom.settingsBtn.addEventListener('click', toggleSettings);\r\n  }\r\n\r\n  bindClick('update-btn', applyUpdate);\r\n  bindClick('btn-check-updates', checkForUpdates);\r\n  bindClick('btn-apply-update', applyUpdate);\r\n  bindClick('btn-show-changelog', showChangelog);\r\n  bindClick('btn-close-changelog', closeChangelog);\r\n\r\n  const changelogBackdrop = document.querySelector('#changelog-modal .modal-backdrop');\r\n  if (changelogBackdrop) {\r\n    changelogBackdrop.addEventListener('click', closeChangelog);\r\n  }\r\n\r\n  import('./modules/settings').then((mod) => {\r\n    mod.bindSettingsAutoSave();\r\n  });\r\n}\r\n", "/**\r\n * Auth Status Module\r\n *\r\n * Handles authentication status checking and security warning display.\r\n */\r\n\r\nimport { authStatus, setAuthStatus } from '../../state';\r\nimport type { AuthStatus } from '../../types';\r\n\r\n/**\r\n * Check authentication status from server\r\n */\r\nexport async function checkAuthStatus(): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/auth/status');\r\n\r\n    if (response.status === 401) {\r\n      window.location.href = '/login.html';\r\n      return;\r\n    }\r\n\r\n    const status: AuthStatus = await response.json();\r\n    setAuthStatus(status);\r\n    updateSecurityWarning();\r\n    updatePasswordStatus();\r\n  } catch (e) {\r\n    console.error('Auth status error:', e);\r\n  }\r\n}\r\n\r\n/**\r\n * Update security warning visibility based on auth status\r\n */\r\nexport function updateSecurityWarning(): void {\r\n  const warning = document.getElementById('security-warning');\r\n  if (!warning) return;\r\n\r\n  if (authStatus && authStatus.authenticationEnabled && !authStatus.passwordSet) {\r\n    warning.classList.remove('hidden');\r\n  } else {\r\n    warning.classList.add('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Update password status text in settings panel\r\n */\r\nexport function updatePasswordStatus(): void {\r\n  const statusEl = document.getElementById('password-status-text');\r\n  if (!statusEl) return;\r\n\r\n  if (!authStatus) {\r\n    statusEl.textContent = 'Checking...';\r\n    statusEl.className = '';\r\n    return;\r\n  }\r\n\r\n  if (authStatus.passwordSet) {\r\n    statusEl.textContent = 'Password is set';\r\n    statusEl.className = 'status-set';\r\n  } else {\r\n    statusEl.textContent = 'No password set';\r\n    statusEl.className = 'status-missing';\r\n  }\r\n}\r\n\r\n/**\r\n * Dismiss the security warning banner\r\n */\r\nexport function dismissSecurityWarning(): void {\r\n  const warning = document.getElementById('security-warning');\r\n  if (warning) {\r\n    warning.classList.add('hidden');\r\n  }\r\n}\r\n", "/**\r\n * Password Modal Module\r\n *\r\n * Handles password set/change modal and form submission.\r\n */\r\n\r\nimport { authStatus } from '../../state';\r\nimport { bindClick } from '../../utils';\r\nimport { checkAuthStatus, dismissSecurityWarning } from './status';\r\n\r\nlet passwordModalHasPassword = false;\r\n\r\n/**\r\n * Show the password modal for setting or changing password\r\n */\r\nexport function showPasswordModal(_isInitialSetup: boolean): void {\r\n  const modal = document.getElementById('password-modal');\r\n  const title = document.getElementById('password-modal-title');\r\n  const currentGroup = document.getElementById('current-password-group');\r\n  const errorEl = document.getElementById('password-error');\r\n\r\n  if (!modal) return;\r\n\r\n  passwordModalHasPassword = authStatus?.passwordSet ?? false;\r\n\r\n  if (title) {\r\n    title.textContent = passwordModalHasPassword ? 'Change Password' : 'Set Password';\r\n  }\r\n\r\n  if (currentGroup) {\r\n    currentGroup.style.display = passwordModalHasPassword ? 'block' : 'none';\r\n  }\r\n\r\n  if (errorEl) {\r\n    errorEl.classList.add('hidden');\r\n    errorEl.textContent = '';\r\n  }\r\n\r\n  const form = document.getElementById('password-form') as HTMLFormElement | null;\r\n  if (form) {\r\n    form.reset();\r\n  }\r\n\r\n  modal.classList.remove('hidden');\r\n\r\n  const focusFieldId = passwordModalHasPassword ? 'current-password' : 'new-password';\r\n  const field = document.getElementById(focusFieldId) as HTMLInputElement | null;\r\n  if (field) {\r\n    field.focus();\r\n  }\r\n}\r\n\r\n/**\r\n * Hide the password modal\r\n */\r\nexport function hidePasswordModal(): void {\r\n  const modal = document.getElementById('password-modal');\r\n  if (modal) {\r\n    modal.classList.add('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Handle password form submission\r\n */\r\nexport function handlePasswordSubmit(e: Event): void {\r\n  e.preventDefault();\r\n\r\n  const currentPw = document.getElementById('current-password') as HTMLInputElement | null;\r\n  const newPw = document.getElementById('new-password') as HTMLInputElement | null;\r\n  const confirmPw = document.getElementById('confirm-password') as HTMLInputElement | null;\r\n  const saveBtn = document.getElementById('btn-save-password') as HTMLButtonElement | null;\r\n\r\n  const newPassword = newPw?.value ?? '';\r\n  const confirmPassword = confirmPw?.value ?? '';\r\n\r\n  if (!newPassword) {\r\n    showPasswordError('New password is required');\r\n    return;\r\n  }\r\n\r\n  if (newPassword !== confirmPassword) {\r\n    showPasswordError('Passwords do not match');\r\n    return;\r\n  }\r\n\r\n  if (newPassword.length < 4) {\r\n    showPasswordError('Password must be at least 4 characters');\r\n    return;\r\n  }\r\n\r\n  const payload = {\r\n    currentPassword: passwordModalHasPassword && currentPw ? currentPw.value : null,\r\n    newPassword: newPassword\r\n  };\r\n\r\n  if (saveBtn) {\r\n    saveBtn.disabled = true;\r\n    saveBtn.textContent = 'Saving...';\r\n  }\r\n\r\n  fetch('/api/auth/change-password', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload)\r\n  })\r\n    .then(r => r.json().then(data => ({ ok: r.ok, data })))\r\n    .then(result => {\r\n      if (saveBtn) {\r\n        saveBtn.disabled = false;\r\n        saveBtn.textContent = 'Save';\r\n      }\r\n\r\n      if (result.ok && result.data.success) {\r\n        hidePasswordModal();\r\n        checkAuthStatus();\r\n      } else {\r\n        showPasswordError(result.data.error || 'Failed to change password');\r\n      }\r\n    })\r\n    .catch(() => {\r\n      if (saveBtn) {\r\n        saveBtn.disabled = false;\r\n        saveBtn.textContent = 'Save';\r\n      }\r\n      showPasswordError('Connection error');\r\n    });\r\n}\r\n\r\n/**\r\n * Show an error message in the password modal\r\n */\r\nexport function showPasswordError(msg: string): void {\r\n  const errorEl = document.getElementById('password-error');\r\n  if (errorEl) {\r\n    errorEl.textContent = msg;\r\n    errorEl.classList.remove('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Bind all auth-related event handlers\r\n */\r\nexport function bindAuthEvents(): void {\r\n  bindClick('btn-set-password-warning', () => {\r\n    showPasswordModal(true);\r\n  });\r\n  bindClick('btn-dismiss-warning', dismissSecurityWarning);\r\n\r\n  bindClick('btn-change-password', () => {\r\n    showPasswordModal(false);\r\n  });\r\n  bindClick('btn-close-password', hidePasswordModal);\r\n  bindClick('btn-cancel-password', hidePasswordModal);\r\n\r\n  const passwordBackdrop = document.querySelector('#password-modal .modal-backdrop');\r\n  if (passwordBackdrop) {\r\n    passwordBackdrop.addEventListener('click', hidePasswordModal);\r\n  }\r\n\r\n  const passwordForm = document.getElementById('password-form');\r\n  if (passwordForm) {\r\n    passwordForm.addEventListener('submit', handlePasswordSubmit);\r\n  }\r\n}\r\n", "/**\r\n * Update Checker Module\r\n *\r\n * Handles checking for updates, rendering the update panel,\r\n * and applying updates with server restart.\r\n */\r\n\r\nimport type { UpdateInfo } from '../../types';\r\nimport { updateInfo, setUpdateInfo } from '../../state';\r\n\r\nconst MAX_RELOAD_ATTEMPTS = 30;\r\nconst RELOAD_INTERVAL_MS = 2000;\r\nconst INITIAL_RESTART_DELAY_MS = 3000;\r\n\r\n/**\r\n * Render the update panel based on current update info\r\n */\r\nexport function renderUpdatePanel(): void {\r\n  const panel = document.getElementById('update-panel');\r\n  if (!panel) return;\r\n\r\n  if (!updateInfo || !updateInfo.available) {\r\n    panel.classList.add('hidden');\r\n    return;\r\n  }\r\n\r\n  panel.classList.remove('hidden');\r\n  const currentEl = panel.querySelector('.update-current');\r\n  const latestEl = panel.querySelector('.update-latest');\r\n  const noteEl = panel.querySelector('.update-note');\r\n  const headerEl = panel.querySelector('.update-header');\r\n\r\n  if (currentEl) currentEl.textContent = updateInfo.currentVersion;\r\n  if (latestEl) latestEl.textContent = updateInfo.latestVersion;\r\n\r\n  if (updateInfo.sessionsPreserved) {\r\n    if (headerEl) headerEl.textContent = 'Quick Update';\r\n    if (noteEl) {\r\n      noteEl.textContent = 'Sessions will stay alive';\r\n      noteEl.classList.add('update-note-safe');\r\n      noteEl.classList.remove('update-note-warning');\r\n    }\r\n  } else {\r\n    if (headerEl) headerEl.textContent = 'Update Available';\r\n    if (noteEl) {\r\n      noteEl.textContent = 'Save your work - sessions will restart';\r\n      noteEl.classList.add('update-note-warning');\r\n      noteEl.classList.remove('update-note-safe');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Apply the available update and restart the server\r\n */\r\nexport function applyUpdate(): void {\r\n  if (!updateInfo || !updateInfo.available) return;\r\n\r\n  const panel = document.getElementById('update-panel');\r\n  const btn = panel?.querySelector('.update-btn') as HTMLButtonElement | null;\r\n\r\n  if (btn) {\r\n    btn.disabled = true;\r\n    btn.textContent = 'Updating...';\r\n  }\r\n\r\n  fetch('/api/update/apply', { method: 'POST' })\r\n    .then((r) => {\r\n      if (r.ok) {\r\n        if (btn) btn.textContent = 'Restarting...';\r\n        waitForServerAndReload();\r\n      } else {\r\n        if (btn) {\r\n          btn.disabled = false;\r\n          btn.textContent = 'Update & Restart';\r\n        }\r\n        console.error('Update failed');\r\n      }\r\n    })\r\n    .catch((e) => {\r\n      if (btn) {\r\n        btn.disabled = false;\r\n        btn.textContent = 'Update & Restart';\r\n      }\r\n      console.error('Update error:', e);\r\n    });\r\n}\r\n\r\n/**\r\n * Wait for the server to restart after an update, then reload the page\r\n */\r\nexport function waitForServerAndReload(): void {\r\n  let attempts = 0;\r\n\r\n  function checkServer(): void {\r\n    attempts++;\r\n    fetch('/api/version', { cache: 'no-store' })\r\n      .then((r) => {\r\n        if (r.ok) {\r\n          location.reload();\r\n        } else if (attempts < MAX_RELOAD_ATTEMPTS) {\r\n          setTimeout(checkServer, RELOAD_INTERVAL_MS);\r\n        }\r\n      })\r\n      .catch(() => {\r\n        if (attempts < MAX_RELOAD_ATTEMPTS) {\r\n          setTimeout(checkServer, RELOAD_INTERVAL_MS);\r\n        }\r\n      });\r\n  }\r\n\r\n  setTimeout(checkServer, INITIAL_RESTART_DELAY_MS);\r\n}\r\n\r\n/**\r\n * Manually check for updates and update the UI\r\n */\r\nexport function checkForUpdates(): void {\r\n  const btn = document.getElementById('btn-check-updates') as HTMLButtonElement | null;\r\n\r\n  if (btn) {\r\n    btn.disabled = true;\r\n    btn.textContent = 'Checking...';\r\n  }\r\n\r\n  fetch('/api/update/check')\r\n    .then((r) => r.json())\r\n    .then((update: UpdateInfo) => {\r\n      if (btn) {\r\n        btn.disabled = false;\r\n        btn.textContent = 'Check for Updates';\r\n      }\r\n\r\n      setUpdateInfo(update);\r\n      renderUpdatePanel();\r\n      renderUpdateCards(update);\r\n    })\r\n    .catch((e) => {\r\n      if (btn) {\r\n        btn.disabled = false;\r\n        btn.textContent = 'Check for Updates';\r\n      }\r\n      renderUpdateCards(null, 'Failed to check for updates');\r\n      console.error('Update check error:', e);\r\n    });\r\n}\r\n\r\n/**\r\n * Render both GitHub and Local update cards\r\n */\r\nfunction renderUpdateCards(update: UpdateInfo | null, error?: string): void {\r\n  const container = document.getElementById('update-cards');\r\n  const statusNone = document.getElementById('update-status-none');\r\n  if (!container) return;\r\n\r\n  container.innerHTML = '';\r\n\r\n  // Error state\r\n  if (error) {\r\n    if (statusNone) statusNone.classList.add('hidden');\r\n    container.innerHTML = `<div class=\"update-status-error\">${error}</div>`;\r\n    return;\r\n  }\r\n\r\n  const hasGitHub = update?.available ?? false;\r\n  const hasLocal = update?.environment && update?.localUpdate?.available;\r\n\r\n  // No updates available\r\n  if (!hasGitHub && !hasLocal) {\r\n    if (statusNone) statusNone.classList.remove('hidden');\r\n    return;\r\n  }\r\n\r\n  if (statusNone) statusNone.classList.add('hidden');\r\n\r\n  // GitHub update card\r\n  if (hasGitHub && update) {\r\n    const card = createUpdateCard({\r\n      type: 'github',\r\n      title: 'GitHub Release',\r\n      version: update.latestVersion,\r\n      sessionsPreserved: update.sessionsPreserved,\r\n      onApply: applyUpdate\r\n    });\r\n    container.appendChild(card);\r\n  }\r\n\r\n  // Local update card (only in dev environment)\r\n  if (hasLocal && update?.localUpdate) {\r\n    const card = createUpdateCard({\r\n      type: 'local',\r\n      title: 'Local Build',\r\n      version: update.localUpdate.version,\r\n      sessionsPreserved: update.localUpdate.sessionsPreserved,\r\n      onApply: applyLocalUpdate\r\n    });\r\n    container.appendChild(card);\r\n  }\r\n}\r\n\r\ninterface UpdateCardOptions {\r\n  type: 'github' | 'local';\r\n  title: string;\r\n  version: string;\r\n  sessionsPreserved: boolean;\r\n  onApply: () => void;\r\n}\r\n\r\n/**\r\n * Create an update card element\r\n */\r\nfunction createUpdateCard(opts: UpdateCardOptions): HTMLElement {\r\n  const card = document.createElement('div');\r\n  card.className = `update-card ${opts.type}`;\r\n  card.id = `update-card-${opts.type}`;\r\n\r\n  const warningClass = opts.sessionsPreserved ? 'safe' : 'warn';\r\n  const warningText = opts.sessionsPreserved\r\n    ? 'Sessions will stay alive'\r\n    : 'Sessions will restart';\r\n\r\n  card.innerHTML = `\r\n    <div class=\"update-card-header\">\r\n      <span class=\"update-card-title\">${opts.title}</span>\r\n      <span class=\"update-card-version\">v${opts.version}</span>\r\n    </div>\r\n    <div class=\"update-card-footer\">\r\n      <span class=\"update-card-warning ${warningClass}\">${warningText}</span>\r\n      <button class=\"btn-update\">Apply</button>\r\n    </div>\r\n  `;\r\n\r\n  const btn = card.querySelector('.btn-update') as HTMLButtonElement;\r\n  if (btn) {\r\n    btn.addEventListener('click', () => {\r\n      btn.disabled = true;\r\n      btn.textContent = 'Applying...';\r\n      opts.onApply();\r\n    });\r\n  }\r\n\r\n  return card;\r\n}\r\n\r\n/**\r\n * Apply local update from C:\\temp\\mtlocalrelease\r\n */\r\nexport function applyLocalUpdate(): void {\r\n  fetch('/api/update/apply?source=local', { method: 'POST' })\r\n    .then((r) => {\r\n      const btn = document.querySelector('#update-card-local .btn-update') as HTMLButtonElement | null;\r\n      if (r.ok) {\r\n        if (btn) btn.textContent = 'Restarting...';\r\n        waitForServerAndReload();\r\n      } else {\r\n        if (btn) {\r\n          btn.disabled = false;\r\n          btn.textContent = 'Apply';\r\n        }\r\n        console.error('Local update failed');\r\n      }\r\n    })\r\n    .catch((e) => {\r\n      const btn = document.querySelector('#update-card-local .btn-update') as HTMLButtonElement | null;\r\n      if (btn) {\r\n        btn.disabled = false;\r\n        btn.textContent = 'Apply';\r\n      }\r\n      console.error('Local update error:', e);\r\n    });\r\n}\r\n\r\n/**\r\n * Handle incoming update info from WebSocket\r\n */\r\nexport function handleUpdateInfo(update: UpdateInfo): void {\r\n  setUpdateInfo(update);\r\n  renderUpdatePanel();\r\n}\r\n\r\ninterface UpdateResult {\r\n  found: boolean;\r\n  success: boolean;\r\n  message: string;\r\n  details: string;\r\n  timestamp: string;\r\n  logFile: string;\r\n}\r\n\r\n/**\r\n * Check for update results on startup and clear the result file.\r\n * The update result is shown in the settings panel, not as a notification.\r\n */\r\nexport function checkUpdateResult(): void {\r\n  fetch('/api/update/result')\r\n    .then((r) => r.json())\r\n    .then((result: UpdateResult) => {\r\n      if (!result.found) return;\r\n\r\n      // Clear the result file - the result is shown in the settings/sidebar panels\r\n      fetch('/api/update/result', { method: 'DELETE' }).catch(() => {});\r\n    })\r\n    .catch(() => {});\r\n}\r\n", "/**\r\n * Changelog Module\r\n *\r\n * Fetches and displays the changelog from GitHub releases.\r\n */\r\n\r\nimport { escapeHtml } from '../../utils';\r\n\r\nconst GITHUB_RELEASES_BASE = 'https://api.github.com/repos/AiTlbx/MidTerm/releases';\r\nconst PER_PAGE = 30;\r\nconst GITHUB_RELEASES_PAGE = 'https://github.com/AiTlbx/MidTerm/releases';\r\n\r\ninterface GitHubRelease {\r\n  tag_name?: string;\r\n  published_at?: string;\r\n  body?: string;\r\n}\r\n\r\n// Pagination state\r\nlet currentPage = 1;\r\nlet hasMoreReleases = true;\r\nlet isLoading = false;\r\n\r\n/**\r\n * Show the changelog modal and fetch releases from GitHub\r\n */\r\nexport function showChangelog(): void {\r\n  const modal = document.getElementById('changelog-modal');\r\n  const body = document.getElementById('changelog-body');\r\n\r\n  // Reset pagination state\r\n  currentPage = 1;\r\n  hasMoreReleases = true;\r\n  isLoading = false;\r\n\r\n  if (modal) modal.classList.remove('hidden');\r\n  if (body) body.innerHTML = '<div class=\"changelog-loading\">Loading changelog...</div>';\r\n\r\n  fetchReleases(true);\r\n}\r\n\r\n/**\r\n * Fetch releases from GitHub API\r\n */\r\nfunction fetchReleases(isInitial: boolean): void {\r\n  if (isLoading) return;\r\n  isLoading = true;\r\n\r\n  const body = document.getElementById('changelog-body');\r\n  if (!body) return;\r\n\r\n  const url = `${GITHUB_RELEASES_BASE}?per_page=${PER_PAGE}&page=${currentPage}`;\r\n\r\n  fetch(url)\r\n    .then((r) => r.json())\r\n    .then((releases: GitHubRelease[]) => {\r\n      isLoading = false;\r\n\r\n      if (!releases || !Array.isArray(releases)) {\r\n        if (isInitial) {\r\n          body.innerHTML = '<p>No releases found.</p>';\r\n        }\r\n        hasMoreReleases = false;\r\n        return;\r\n      }\r\n\r\n      // Check if there are more pages\r\n      hasMoreReleases = releases.length === PER_PAGE;\r\n\r\n      if (releases.length === 0) {\r\n        if (isInitial) {\r\n          body.innerHTML = '<p>No releases found.</p>';\r\n        }\r\n        hasMoreReleases = false;\r\n        return;\r\n      }\r\n\r\n      // Build HTML for releases\r\n      let html = '';\r\n      releases.forEach((release) => {\r\n        const version = release.tag_name || 'Unknown';\r\n        const date = release.published_at\r\n          ? new Date(release.published_at).toLocaleDateString()\r\n          : '';\r\n        // Strip version prefix from body since version is already shown in header\r\n        const rawNotes = release.body || 'No release notes.';\r\n        const notes = stripVersionPrefix(rawNotes, version);\r\n\r\n        html += '<div class=\"changelog-release\">';\r\n        html += '<div class=\"changelog-version\">' + escapeHtml(version) + '</div>';\r\n        if (date) html += '<div class=\"changelog-date\">' + escapeHtml(date) + '</div>';\r\n        html += '<div class=\"changelog-notes\">' + formatMarkdown(notes) + '</div>';\r\n        html += '</div>';\r\n      });\r\n\r\n      if (isInitial) {\r\n        body.innerHTML = html;\r\n      } else {\r\n        // Remove existing load more button before appending\r\n        const existingBtn = body.querySelector('.changelog-load-more');\r\n        if (existingBtn) existingBtn.remove();\r\n        body.insertAdjacentHTML('beforeend', html);\r\n      }\r\n\r\n      // Add load more button if there are more releases\r\n      if (hasMoreReleases) {\r\n        const loadMoreBtn = document.createElement('button');\r\n        loadMoreBtn.className = 'changelog-load-more';\r\n        loadMoreBtn.textContent = 'Load older releases';\r\n        loadMoreBtn.addEventListener('click', () => {\r\n          currentPage++;\r\n          loadMoreBtn.textContent = 'Loading...';\r\n          loadMoreBtn.disabled = true;\r\n          fetchReleases(false);\r\n        });\r\n        body.appendChild(loadMoreBtn);\r\n      }\r\n    })\r\n    .catch((e) => {\r\n      isLoading = false;\r\n      if (isInitial) {\r\n        body.innerHTML =\r\n          '<p class=\"changelog-error\">Failed to load changelog. ' +\r\n          '<a href=\"' + GITHUB_RELEASES_PAGE + '\" target=\"_blank\">View on GitHub</a></p>';\r\n      }\r\n      console.error('Changelog error:', e);\r\n    });\r\n}\r\n\r\n/**\r\n * Close the changelog modal\r\n */\r\nexport function closeChangelog(): void {\r\n  const modal = document.getElementById('changelog-modal');\r\n  if (modal) modal.classList.add('hidden');\r\n}\r\n\r\n/**\r\n * Strip version prefix from release notes\r\n *\r\n * Removes patterns like \"v5.3.0: \" or \"5.3.0: \" from the start of text\r\n * since the version is already shown in the header.\r\n */\r\nfunction stripVersionPrefix(text: string, version: string): string {\r\n  // Remove leading \"v\" from version if present for matching\r\n  const versionNum = version.replace(/^v/, '');\r\n  // Match \"v5.3.0: \" or \"5.3.0: \" at start of text\r\n  const pattern = new RegExp(`^v?${escapeRegex(versionNum)}:\\\\s*`, 'i');\r\n  return text.replace(pattern, '').trim();\r\n}\r\n\r\n/**\r\n * Escape special regex characters in a string\r\n */\r\nfunction escapeRegex(str: string): string {\r\n  return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n}\r\n\r\n/**\r\n * Format markdown text to HTML (basic subset)\r\n *\r\n * Supports: headers (## and ###), bold (**text**),\r\n * links [text](url), and bullet lists (- item)\r\n */\r\nexport function formatMarkdown(text: string): string {\r\n  return escapeHtml(text)\r\n    .replace(/^### (.+)$/gm, '<h4>$1</h4>')\r\n    .replace(/^## (.+)$/gm, '<h3>$1</h3>')\r\n    .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\r\n    .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" target=\"_blank\">$1</a>')\r\n    .replace(/^- (.+)$/gm, '<li>$1</li>')\r\n    .replace(/(<li>.*<\\/li>)/s, '<ul>$1</ul>')\r\n    .replace(/\\n{3,}/g, '\\n\\n') // Collapse 3+ newlines to 2\r\n    .replace(/\\n\\n/g, '<br><br>') // Double newline = paragraph break\r\n    .replace(/\\n/g, '<br>'); // Single newline = line break\r\n}\r\n", "/**\r\n * Logs Channel Module\r\n *\r\n * WebSocket connection for streaming backend logs (mt.exe and mthost sessions).\r\n */\r\n\r\nimport { createLogger } from '../logging';\r\n\r\nconst log = createLogger('logs-ws');\r\n\r\nexport interface ServerLogEntry {\r\n  messageType: 'log';\r\n  source: string;\r\n  sessionId?: string;\r\n  timestamp: string;\r\n  level: string;\r\n  message: string;\r\n}\r\n\r\nexport interface LogHistoryResponse {\r\n  messageType: 'history';\r\n  source: string;\r\n  sessionId?: string;\r\n  entries: ServerLogEntry[];\r\n  hasMore: boolean;\r\n}\r\n\r\nexport interface LogSessionInfo {\r\n  id: string;\r\n  active: boolean;\r\n  logCount: number;\r\n}\r\n\r\nexport interface LogSessionsResponse {\r\n  messageType: 'sessions';\r\n  sessions: LogSessionInfo[];\r\n}\r\n\r\ninterface PingMessage {\r\n  messageType: 'ping';\r\n}\r\n\r\ntype LogMessage = ServerLogEntry | LogHistoryResponse | LogSessionsResponse | PingMessage;\r\n\r\nlet ws: WebSocket | null = null;\r\nlet reconnectTimer: number | null = null;\r\nlet reconnectDelay = 1000;\r\nconst MAX_RECONNECT_DELAY = 30000;\r\n\r\n// Callbacks\r\nlet onLogEntry: ((entry: ServerLogEntry) => void) | null = null;\r\nlet onHistory: ((response: LogHistoryResponse) => void) | null = null;\r\nlet onSessions: ((response: LogSessionsResponse) => void) | null = null;\r\nlet onConnectionChange: ((connected: boolean) => void) | null = null;\r\n\r\n/**\r\n * Set callback for individual log entries\r\n */\r\nexport function setOnLogEntry(callback: (entry: ServerLogEntry) => void): void {\r\n  onLogEntry = callback;\r\n}\r\n\r\n/**\r\n * Set callback for history responses\r\n */\r\nexport function setOnHistory(callback: (response: LogHistoryResponse) => void): void {\r\n  onHistory = callback;\r\n}\r\n\r\n/**\r\n * Set callback for sessions list responses\r\n */\r\nexport function setOnSessions(callback: (response: LogSessionsResponse) => void): void {\r\n  onSessions = callback;\r\n}\r\n\r\n/**\r\n * Set callback for connection state changes\r\n */\r\nexport function setOnConnectionChange(callback: (connected: boolean) => void): void {\r\n  onConnectionChange = callback;\r\n}\r\n\r\n/**\r\n * Connect to the logs WebSocket\r\n */\r\nexport function connectLogsWebSocket(): void {\r\n  if (ws && ws.readyState === WebSocket.OPEN) return;\r\n\r\n  if (ws) {\r\n    ws.onclose = null;\r\n    ws.close();\r\n  }\r\n\r\n  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n  ws = new WebSocket(`${protocol}//${location.host}/ws/logs`);\r\n\r\n  ws.onopen = () => {\r\n    log.info(() => 'Connected to logs WebSocket');\r\n    reconnectDelay = 1000;\r\n    onConnectionChange?.(true);\r\n  };\r\n\r\n  ws.onmessage = (event) => {\r\n    try {\r\n      const message = JSON.parse(event.data) as LogMessage;\r\n      handleMessage(message);\r\n    } catch (e) {\r\n      log.error(() => `Failed to parse log message: ${e}`);\r\n    }\r\n  };\r\n\r\n  ws.onclose = () => {\r\n    log.info(() => 'Logs WebSocket closed');\r\n    onConnectionChange?.(false);\r\n    scheduleReconnect();\r\n  };\r\n\r\n  ws.onerror = () => {\r\n    log.error(() => 'Logs WebSocket error');\r\n  };\r\n}\r\n\r\n/**\r\n * Disconnect from the logs WebSocket\r\n */\r\nexport function disconnectLogsWebSocket(): void {\r\n  if (reconnectTimer) {\r\n    clearTimeout(reconnectTimer);\r\n    reconnectTimer = null;\r\n  }\r\n\r\n  if (ws) {\r\n    ws.onclose = null;\r\n    ws.close();\r\n    ws = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Subscribe to mt.exe logs\r\n */\r\nexport function subscribeMt(): void {\r\n  sendMessage({ action: 'subscribe', type: 'mt' });\r\n}\r\n\r\n/**\r\n * Unsubscribe from mt.exe logs\r\n */\r\nexport function unsubscribeMt(): void {\r\n  sendMessage({ action: 'unsubscribe', type: 'mt' });\r\n}\r\n\r\n/**\r\n * Subscribe to a session's logs\r\n */\r\nexport function subscribeSession(sessionId: string): void {\r\n  sendMessage({ action: 'subscribe', type: 'mthost', sessionId });\r\n}\r\n\r\n/**\r\n * Unsubscribe from a session's logs\r\n */\r\nexport function unsubscribeSession(sessionId: string): void {\r\n  sendMessage({ action: 'unsubscribe', type: 'mthost', sessionId });\r\n}\r\n\r\n/**\r\n * Request log history\r\n */\r\nexport function requestHistory(type: 'mt' | 'mthost', sessionId?: string, limit = 100): void {\r\n  sendMessage({ action: 'history', type, sessionId, limit });\r\n}\r\n\r\n/**\r\n * Request list of sessions with logs\r\n */\r\nexport function requestSessions(): void {\r\n  sendMessage({ action: 'sessions' });\r\n}\r\n\r\n/**\r\n * Check if connected\r\n */\r\nexport function isConnected(): boolean {\r\n  return ws !== null && ws.readyState === WebSocket.OPEN;\r\n}\r\n\r\nfunction sendMessage(message: object): void {\r\n  if (!ws || ws.readyState !== WebSocket.OPEN) return;\r\n  ws.send(JSON.stringify(message));\r\n}\r\n\r\nfunction handleMessage(message: LogMessage): void {\r\n  switch (message.messageType) {\r\n    case 'log':\r\n      onLogEntry?.(message);\r\n      break;\r\n    case 'history':\r\n      onHistory?.(message);\r\n      break;\r\n    case 'sessions':\r\n      onSessions?.(message);\r\n      break;\r\n    case 'ping':\r\n      // Server keepalive - no action needed\r\n      break;\r\n  }\r\n}\r\n\r\nfunction scheduleReconnect(): void {\r\n  if (reconnectTimer) return;\r\n\r\n  reconnectTimer = window.setTimeout(() => {\r\n    reconnectTimer = null;\r\n    reconnectDelay = Math.min(reconnectDelay * 2, MAX_RECONNECT_DELAY);\r\n    connectLogsWebSocket();\r\n  }, reconnectDelay);\r\n}\r\n", "/**\r\n * Diagnostics Panel Module\r\n *\r\n * Handles the diagnostics log viewer UI in the settings panel.\r\n * Supports Frontend (IndexedDB), Server (WebSocket), and Session logs.\r\n */\r\n\r\nimport { LogLevel, LOG_LEVEL_NAMES } from '../logging';\r\nimport { readLogEntries, clearLogs } from '../logging';\r\nimport {\r\n  connectLogsWebSocket,\r\n  disconnectLogsWebSocket,\r\n  setOnLogEntry,\r\n  setOnHistory,\r\n  setOnSessions,\r\n  setOnConnectionChange,\r\n  subscribeMt,\r\n  unsubscribeMt,\r\n  subscribeSession,\r\n  unsubscribeSession,\r\n  requestHistory,\r\n  requestSessions,\r\n  isConnected,\r\n  type ServerLogEntry,\r\n  type LogHistoryResponse,\r\n  type LogSessionsResponse,\r\n  type LogSessionInfo\r\n} from './logsChannel';\r\n\r\ntype DiagnosticsTab = 'frontend' | 'server' | 'sessions';\r\n\r\ninterface DisplayEntry {\r\n  timestamp: string;\r\n  level: string;\r\n  module: string;\r\n  message: string;\r\n}\r\n\r\nlet currentTab: DiagnosticsTab = 'frontend';\r\nlet minLevel: LogLevel = LogLevel.Warn;\r\nlet searchFilter = '';\r\nlet liveTail = true;\r\nlet displayedEntries: DisplayEntry[] = [];\r\nlet refreshInterval: number | null = null;\r\nlet selectedSessionId: string | null = null;\r\nlet sessionsList: LogSessionInfo[] = [];\r\n\r\n/**\r\n * Initialize the diagnostics panel\r\n */\r\nexport function initDiagnosticsPanel(): void {\r\n  bindTabEvents();\r\n  bindControlEvents();\r\n  setupWebSocketCallbacks();\r\n  startRefreshLoop();\r\n}\r\n\r\n/**\r\n * Setup WebSocket callbacks\r\n */\r\nfunction setupWebSocketCallbacks(): void {\r\n  setOnLogEntry(handleLogEntry);\r\n  setOnHistory(handleHistory);\r\n  setOnSessions(handleSessions);\r\n  setOnConnectionChange((connected) => {\r\n    if (connected) {\r\n      // Re-subscribe on reconnect\r\n      if (currentTab === 'server') {\r\n        subscribeMt();\r\n        requestHistory('mt');\r\n      } else if (currentTab === 'sessions' && selectedSessionId) {\r\n        subscribeSession(selectedSessionId);\r\n        requestHistory('mthost', selectedSessionId);\r\n      }\r\n      requestSessions();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Bind tab switching events\r\n */\r\nfunction bindTabEvents(): void {\r\n  const tabs = document.querySelectorAll('.diag-tab');\r\n  tabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      const tabName = tab.getAttribute('data-tab') as DiagnosticsTab;\r\n      if (tabName) {\r\n        switchTab(tabName);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Switch to a different tab\r\n */\r\nfunction switchTab(tab: DiagnosticsTab): void {\r\n  // Unsubscribe from current tab's streams\r\n  if (currentTab === 'server') {\r\n    unsubscribeMt();\r\n  } else if (currentTab === 'sessions' && selectedSessionId) {\r\n    unsubscribeSession(selectedSessionId);\r\n  }\r\n\r\n  currentTab = tab;\r\n\r\n  // Update tab UI\r\n  document.querySelectorAll('.diag-tab').forEach((t) => {\r\n    t.classList.toggle('active', t.getAttribute('data-tab') === tab);\r\n  });\r\n\r\n  // Show/hide session picker\r\n  const sessionSelect = document.getElementById('diag-session-select');\r\n  if (sessionSelect) {\r\n    sessionSelect.classList.toggle('hidden', tab !== 'sessions');\r\n  }\r\n\r\n  // Show/hide clear button (only for frontend)\r\n  const clearBtn = document.getElementById('diag-clear');\r\n  if (clearBtn) {\r\n    clearBtn.style.display = tab === 'frontend' ? '' : 'none';\r\n  }\r\n\r\n  // Clear and refresh\r\n  displayedEntries = [];\r\n\r\n  // Connect/subscribe based on tab\r\n  if (tab === 'server' || tab === 'sessions') {\r\n    if (!isConnected()) {\r\n      connectLogsWebSocket();\r\n    }\r\n\r\n    if (tab === 'server') {\r\n      subscribeMt();\r\n      requestHistory('mt');\r\n    } else if (tab === 'sessions') {\r\n      requestSessions();\r\n      if (selectedSessionId) {\r\n        subscribeSession(selectedSessionId);\r\n        requestHistory('mthost', selectedSessionId);\r\n      }\r\n    }\r\n  }\r\n\r\n  refreshLogs();\r\n}\r\n\r\n/**\r\n * Bind control events (filter, search, etc.)\r\n */\r\nfunction bindControlEvents(): void {\r\n  const levelFilter = document.getElementById('diag-level-filter') as HTMLSelectElement | null;\r\n  if (levelFilter) {\r\n    levelFilter.addEventListener('change', () => {\r\n      minLevel = parseInt(levelFilter.value, 10) as LogLevel;\r\n      refreshLogs();\r\n    });\r\n  }\r\n\r\n  const searchInput = document.getElementById('diag-search') as HTMLInputElement | null;\r\n  if (searchInput) {\r\n    let searchTimeout: number | null = null;\r\n    searchInput.addEventListener('input', () => {\r\n      if (searchTimeout) clearTimeout(searchTimeout);\r\n      searchTimeout = window.setTimeout(() => {\r\n        searchFilter = searchInput.value.toLowerCase();\r\n        refreshLogs();\r\n      }, 200);\r\n    });\r\n  }\r\n\r\n  const liveTailCheckbox = document.getElementById('diag-live-tail') as HTMLInputElement | null;\r\n  if (liveTailCheckbox) {\r\n    liveTailCheckbox.addEventListener('change', () => {\r\n      liveTail = liveTailCheckbox.checked;\r\n      if (liveTail) {\r\n        scrollToBottom();\r\n      }\r\n    });\r\n  }\r\n\r\n  const copyBtn = document.getElementById('diag-copy-all');\r\n  if (copyBtn) {\r\n    copyBtn.addEventListener('click', copyAllLogs);\r\n  }\r\n\r\n  const clearBtn = document.getElementById('diag-clear');\r\n  if (clearBtn) {\r\n    clearBtn.addEventListener('click', async () => {\r\n      if (currentTab === 'frontend') {\r\n        await clearLogs();\r\n        displayedEntries = [];\r\n        refreshLogs();\r\n      }\r\n    });\r\n  }\r\n\r\n  const sessionPicker = document.getElementById('diag-session-picker') as HTMLSelectElement | null;\r\n  if (sessionPicker) {\r\n    sessionPicker.addEventListener('change', () => {\r\n      // Unsubscribe from old session\r\n      if (selectedSessionId) {\r\n        unsubscribeSession(selectedSessionId);\r\n      }\r\n\r\n      selectedSessionId = sessionPicker.value || null;\r\n      displayedEntries = [];\r\n\r\n      if (selectedSessionId) {\r\n        subscribeSession(selectedSessionId);\r\n        requestHistory('mthost', selectedSessionId);\r\n      }\r\n      refreshLogs();\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Handle incoming log entry from WebSocket\r\n */\r\nfunction handleLogEntry(entry: ServerLogEntry): void {\r\n  if (currentTab === 'server' && entry.source === 'mt') {\r\n    addDisplayEntry(entry);\r\n  } else if (currentTab === 'sessions' && entry.source === 'mthost' &&\r\n             entry.sessionId === selectedSessionId) {\r\n    addDisplayEntry(entry);\r\n  }\r\n}\r\n\r\n/**\r\n * Add an entry to displayed logs\r\n */\r\nfunction addDisplayEntry(entry: ServerLogEntry): void {\r\n  const levelNum = levelStringToNumber(entry.level);\r\n  if (levelNum > minLevel) return;\r\n\r\n  const displayEntry: DisplayEntry = {\r\n    timestamp: entry.timestamp,\r\n    level: entry.level,\r\n    module: entry.source === 'mt' ? 'mt' : `mthost-${entry.sessionId?.slice(0, 4) || ''}`,\r\n    message: entry.message\r\n  };\r\n\r\n  if (searchFilter && !matchesSearch(displayEntry)) return;\r\n\r\n  displayedEntries.push(displayEntry);\r\n  updateDisplay();\r\n\r\n  if (liveTail) {\r\n    scrollToBottom();\r\n  }\r\n}\r\n\r\n/**\r\n * Handle history response from WebSocket\r\n */\r\nfunction handleHistory(response: LogHistoryResponse): void {\r\n  const entries = response.entries.filter((e) => {\r\n    const levelNum = levelStringToNumber(e.level);\r\n    if (levelNum > minLevel) return false;\r\n    const displayEntry: DisplayEntry = {\r\n      timestamp: e.timestamp,\r\n      level: e.level,\r\n      module: e.source === 'mt' ? 'mt' : `mthost-${e.sessionId?.slice(0, 4) || ''}`,\r\n      message: e.message\r\n    };\r\n    return !searchFilter || matchesSearch(displayEntry);\r\n  });\r\n\r\n  displayedEntries = entries.map((e) => ({\r\n    timestamp: e.timestamp,\r\n    level: e.level,\r\n    module: e.source === 'mt' ? 'mt' : `mthost-${e.sessionId?.slice(0, 4) || ''}`,\r\n    message: e.message\r\n  }));\r\n\r\n  updateDisplay();\r\n  if (liveTail) {\r\n    scrollToBottom();\r\n  }\r\n}\r\n\r\n/**\r\n * Handle sessions list response from WebSocket\r\n */\r\nfunction handleSessions(response: LogSessionsResponse): void {\r\n  sessionsList = response.sessions;\r\n  updateSessionPicker();\r\n}\r\n\r\n/**\r\n * Update the session picker dropdown\r\n */\r\nfunction updateSessionPicker(): void {\r\n  const picker = document.getElementById('diag-session-picker') as HTMLSelectElement | null;\r\n  if (!picker) return;\r\n\r\n  const currentValue = picker.value;\r\n  picker.innerHTML = '<option value=\"\">Select session...</option>';\r\n\r\n  sessionsList.forEach((session) => {\r\n    const option = document.createElement('option');\r\n    option.value = session.id;\r\n    option.textContent = `${session.id} ${session.active ? '(active)' : ''} - ${session.logCount} entries`;\r\n    if (session.id === currentValue) {\r\n      option.selected = true;\r\n    }\r\n    picker.appendChild(option);\r\n  });\r\n}\r\n\r\n/**\r\n * Convert level string to number\r\n */\r\nfunction levelStringToNumber(level: string): number {\r\n  switch (level.toLowerCase()) {\r\n    case 'exception': return LogLevel.Exception;\r\n    case 'error': return LogLevel.Error;\r\n    case 'warn': return LogLevel.Warn;\r\n    case 'info': return LogLevel.Info;\r\n    case 'verbose': return LogLevel.Verbose;\r\n    default: return LogLevel.Verbose;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if entry matches search filter\r\n */\r\nfunction matchesSearch(entry: DisplayEntry): boolean {\r\n  return entry.message.toLowerCase().includes(searchFilter) ||\r\n         entry.module.toLowerCase().includes(searchFilter);\r\n}\r\n\r\n/**\r\n * Start the refresh loop for live updates (frontend only)\r\n */\r\nfunction startRefreshLoop(): void {\r\n  if (refreshInterval) return;\r\n  refreshInterval = window.setInterval(() => {\r\n    if (liveTail && currentTab === 'frontend') {\r\n      refreshLogs();\r\n    }\r\n  }, 1000);\r\n}\r\n\r\n/**\r\n * Refresh logs from the current source\r\n */\r\nasync function refreshLogs(): Promise<void> {\r\n  const content = document.getElementById('diag-log-content');\r\n  const countEl = document.getElementById('diag-entry-count');\r\n  if (!content) return;\r\n\r\n  if (currentTab === 'frontend') {\r\n    try {\r\n      const entries = await readLogEntries({ minLevel, limit: 500 });\r\n\r\n      // Apply search filter\r\n      let filtered = entries;\r\n      if (searchFilter) {\r\n        filtered = entries.filter((e) =>\r\n          e.message.toLowerCase().includes(searchFilter) ||\r\n          e.module.toLowerCase().includes(searchFilter)\r\n        );\r\n      }\r\n\r\n      // Convert to display format and reverse for oldest first\r\n      displayedEntries = filtered.reverse().map((e) => ({\r\n        timestamp: new Date(e.timestamp).toISOString(),\r\n        level: LOG_LEVEL_NAMES[e.level].toLowerCase(),\r\n        module: e.module,\r\n        message: e.message\r\n      }));\r\n    } catch {\r\n      displayedEntries = [];\r\n    }\r\n  } else if (currentTab === 'server') {\r\n    if (!isConnected()) {\r\n      content.innerHTML = '<div class=\"diag-connecting\">Connecting to server...</div>';\r\n      if (countEl) countEl.textContent = '0 entries';\r\n      return;\r\n    }\r\n  } else if (currentTab === 'sessions') {\r\n    if (!selectedSessionId) {\r\n      content.innerHTML = '<div class=\"diag-empty\">Select a session to view logs</div>';\r\n      if (countEl) countEl.textContent = '0 entries';\r\n      return;\r\n    }\r\n    if (!isConnected()) {\r\n      content.innerHTML = '<div class=\"diag-connecting\">Connecting to server...</div>';\r\n      if (countEl) countEl.textContent = '0 entries';\r\n      return;\r\n    }\r\n  }\r\n\r\n  updateDisplay();\r\n}\r\n\r\n/**\r\n * Update the display with current entries\r\n */\r\nfunction updateDisplay(): void {\r\n  const content = document.getElementById('diag-log-content');\r\n  const countEl = document.getElementById('diag-entry-count');\r\n  if (!content) return;\r\n\r\n  if (displayedEntries.length === 0) {\r\n    content.innerHTML = '<div class=\"diag-empty\">No log entries</div>';\r\n    if (countEl) countEl.textContent = '0 entries';\r\n    return;\r\n  }\r\n\r\n  content.innerHTML = displayedEntries.map(renderDisplayEntry).join('');\r\n  if (countEl) countEl.textContent = `${displayedEntries.length} entries`;\r\n}\r\n\r\n/**\r\n * Render a single display entry to HTML\r\n */\r\nfunction renderDisplayEntry(entry: DisplayEntry): string {\r\n  const time = entry.timestamp.slice(11, 23);\r\n  const levelName = entry.level.toLowerCase();\r\n  const escapedMessage = escapeHtml(entry.message);\r\n  const escapedModule = escapeHtml(entry.module);\r\n\r\n  return `<div class=\"diag-log-entry\">\r\n    <span class=\"diag-log-time\">${time}</span>\r\n    <span class=\"diag-log-level ${levelName}\">${entry.level.toUpperCase()}</span>\r\n    <span class=\"diag-log-module\">${escapedModule}</span>\r\n    <span class=\"diag-log-message\">${escapedMessage}</span>\r\n  </div>`;\r\n}\r\n\r\n/**\r\n * Escape HTML entities\r\n */\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Scroll log viewer to bottom\r\n */\r\nfunction scrollToBottom(): void {\r\n  const content = document.getElementById('diag-log-content');\r\n  if (content) {\r\n    content.scrollTop = content.scrollHeight;\r\n  }\r\n}\r\n\r\n/**\r\n * Copy all displayed logs to clipboard\r\n */\r\nasync function copyAllLogs(): Promise<void> {\r\n  const lines = displayedEntries.map((entry) => {\r\n    return `[${entry.timestamp}] [${entry.level.toUpperCase()}] [${entry.module}] ${entry.message}`;\r\n  });\r\n\r\n  const text = lines.join('\\n');\r\n  try {\r\n    await navigator.clipboard.writeText(text);\r\n  } catch {\r\n    const textarea = document.createElement('textarea');\r\n    textarea.value = text;\r\n    document.body.appendChild(textarea);\r\n    textarea.select();\r\n    document.execCommand('copy');\r\n    document.body.removeChild(textarea);\r\n  }\r\n}\r\n\r\n/**\r\n * Stop the refresh loop (call when settings panel closes)\r\n */\r\nexport function stopDiagnosticsRefresh(): void {\r\n  if (refreshInterval) {\r\n    clearInterval(refreshInterval);\r\n    refreshInterval = null;\r\n  }\r\n  disconnectLogsWebSocket();\r\n}\r\n"],
  "mappings": "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",
  "names": ["icon", "name", "ICONS", "JS_BUILD_VERSION", "MUX_HEADER_SIZE", "MUX_TYPE_OUTPUT", "MUX_TYPE_INPUT", "MUX_TYPE_RESIZE", "MUX_TYPE_RESYNC", "MUX_TYPE_BUFFER_REQUEST", "MUX_TYPE_COMPRESSED_OUTPUT", "MUX_TYPE_ACTIVE_HINT", "THEMES", "INITIAL_RECONNECT_DELAY", "MAX_RECONNECT_DELAY", "TERMINAL_FONT_STACK", "FONT_CHAR_WIDTH_RATIO", "FONT_LINE_HEIGHT_RATIO", "TERMINAL_PADDING", "MIN_TERMINAL_COLS", "MIN_TERMINAL_ROWS", "MAX_TERMINAL_COLS", "MAX_TERMINAL_ROWS", "MAX_FRAME_DIMENSION", "MOBILE_BREAKPOINT", "init_constants", "__esmMin", "setSessions", "newSessions", "sessions", "setActiveSessionId", "id", "activeSessionId", "setCurrentSettings", "settings", "currentSettings", "setUpdateInfo", "info", "updateInfo", "setAuthStatus", "status", "authStatus", "setSettingsOpen", "open", "settingsOpen", "setSidebarOpen", "sidebarOpen", "setSidebarCollapsed", "collapsed", "sidebarCollapsed", "setStateWs", "ws", "stateWs", "setStateReconnectTimer", "timer", "stateReconnectTimer", "setStateReconnectDelay", "delay", "stateReconnectDelay", "setStateWsConnected", "connected", "stateWsConnected", "setMuxWs", "muxWs", "setMuxReconnectTimer", "muxReconnectTimer", "setMuxReconnectDelay", "muxReconnectDelay", "setMuxWsConnected", "muxWsConnected", "setMuxHasConnected", "muxHasConnected", "setFontsReadyPromise", "promise", "fontsReadyPromise", "setWindowsBuildNumber", "build", "windowsBuildNumber", "cacheDOMElements", "dom", "sessionTerminals", "newlyCreatedSessions", "pendingSessions", "pendingOutputFrames", "init_state", "__esmMin", "escapeHtml", "text", "div", "bindClick", "id", "handler", "el", "init_dom", "__esmMin", "getCookie", "name", "value", "setCookie", "days", "expires", "getClipboardStyle", "setting", "ua", "init_cookies", "__esmMin", "parseOutputFrame", "payload", "cols", "rows", "data", "valid", "MAX_FRAME_DIMENSION", "parseCompressedOutputFrame", "compressedData", "decompressGzip", "e", "compressed", "stream", "init_protocol", "__esmMin", "init_constants", "scheduleReconnect", "currentDelay", "maxDelay", "connect", "setDelay", "setTimer", "existingTimer", "timer", "init_reconnect", "__esmMin", "init_utils", "__esmMin", "init_dom", "init_cookies", "init_protocol", "init_reconnect", "setElementValue", "id", "value", "el", "setElementChecked", "checked", "getElementValue", "defaultValue", "getElementChecked", "populateVersionInfo", "serverVersion", "hostVersion", "frontendVersion", "formatVersion", "v", "serverEl", "frontendEl", "hostEl", "populateUserDropdown", "users", "selectedUser", "select", "user", "option", "populateSettingsForm", "settings", "fetchSettings", "version", "health", "r", "setCurrentSettings", "JS_BUILD_VERSION", "applySettingsToTerminals", "currentSettings", "theme", "THEMES", "fontFamily", "TERMINAL_FONT_STACK", "sessionTerminals", "state", "dims", "applyReceivedSettings", "settingsOpen", "setCookie", "saveAllSettings", "runAsUserValue", "e", "bindSettingsAutoSave", "settingsView", "dom", "wrapper", "input", "saveBtn", "originalValue", "init_persistence", "__esmMin", "init_constants", "init_state", "init_utils", "closeSidebar", "app", "dom", "toggleSettings", "settingsOpen", "closeSettings", "openSettings", "setSettingsOpen", "activeSessionId", "state", "sessionTerminals", "fetchSettings", "fetchSystemStatus", "sessions", "formatUptime", "seconds", "hours", "mins", "updateTtyHostWarning", "health", "banner", "header", "container", "response", "statusClass", "statusText", "uptimeStr", "ttyHostHtml", "err", "message", "checkSystemHealth", "setWindowsBuildNumber", "init_panel", "__esmMin", "init_state", "init_persistence", "settings_exports", "__export", "applyReceivedSettings", "applySettingsToTerminals", "bindSettingsAutoSave", "checkSystemHealth", "closeSettings", "fetchSettings", "fetchSystemStatus", "formatUptime", "getElementChecked", "getElementValue", "openSettings", "populateSettingsForm", "populateUserDropdown", "populateVersionInfo", "saveAllSettings", "setElementChecked", "setElementValue", "toggleSettings", "updateTtyHostWarning", "init_settings", "__esmMin", "init_panel", "init_persistence", "init_constants", "init_state", "init_utils", "initThemeFromCookie", "savedTheme", "THEMES", "LOG_LEVEL_NAMES", "DB_NAME", "DB_VERSION", "STORE_NAME", "MAX_ENTRIES", "MAX_AGE_MS", "db", "initPromise", "initDb", "resolve", "reject", "request", "event", "database", "store", "writeLogEntry", "entry", "readLogEntries", "options", "index", "entries", "limit", "skipped", "offset", "cursor", "clearLogs", "cleanupOldEntries", "store", "initDb", "STORE_NAME", "index", "resolve", "deleted", "cutoff", "MAX_AGE_MS", "countRequest", "count", "excessCount", "MAX_ENTRIES", "ageRequest", "cursor", "excessDeleted", "excessRequest", "initLogStorage", "minLevel", "consoleEnabled", "setLogLevel", "level", "setConsoleLogging", "enabled", "consoleEnabled", "formatConsoleMessage", "entry", "LOG_LEVEL_NAMES", "writeLog", "level", "module", "message", "data", "writeLogEntry", "formatted", "createLogger", "error", "context", "messageFactory", "minLevel", "init_constants", "init_utils", "init_state", "log", "createLogger", "destroyTerminalForSession", "applyTerminalScaling", "renderSessionList", "updateEmptyState", "selectSession", "updateMobileTitle", "renderUpdatePanel", "registerStateCallbacks", "callbacks", "connectStateWebSocket", "stateWs", "setStateWs", "protocol", "ws", "setStateReconnectDelay", "INITIAL_RECONNECT_DELAY", "setStateWsConnected", "updateConnectionStatus", "event", "data", "sessionList", "handleStateUpdate", "handleUpdateInfo", "e", "message", "scheduleStateReconnect", "newSessions", "newIds", "s", "sessionTerminals", "_", "id", "newlyCreatedSessions", "session", "state", "setSessions", "firstSession", "sessions", "activeSessionId", "settingsOpen", "setActiveSessionId", "nextSession", "update", "setUpdateInfo", "scheduleReconnect", "stateReconnectDelay", "MAX_RECONNECT_DELAY", "setStateReconnectTimer", "stateReconnectTimer", "indicator", "status", "text", "stateWsConnected", "muxWsConnected", "init_constants", "init_utils", "init_state", "log", "createLogger", "applyTerminalScaling", "registerMuxCallbacks", "callbacks", "MAX_QUEUE_SIZE", "outputQueue", "processingQueue", "queueOutputFrame", "sessionId", "payload", "compressed", "processOutputQueue", "item", "processOneFrame", "cols", "rows", "data", "frame", "parseCompressedOutputFrame", "parseOutputFrame", "state", "sessionTerminals", "writeToTerminal", "bufferedPayload", "pendingOutputFrames", "e", "bracketedPasteState", "isBracketedPasteEnabled", "text", "currentCols", "currentRows", "message", "connectMuxWebSocket", "muxWs", "setMuxWs", "protocol", "ws", "isReconnect", "muxHasConnected", "setMuxReconnectDelay", "INITIAL_RECONNECT_DELAY", "setMuxWsConnected", "setMuxHasConnected", "updateConnectionStatus", "activeSessionId", "sendActiveSessionHint", "event", "MUX_HEADER_SIZE", "type", "decodeSessionId", "MUX_TYPE_RESYNC", "MUX_TYPE_OUTPUT", "MUX_TYPE_COMPRESSED_OUTPUT", "scheduleMuxReconnect", "sendInput", "MUX_TYPE_INPUT", "encodeSessionId", "sendResize", "MUX_TYPE_RESIZE", "requestBufferRefresh", "MUX_TYPE_BUFFER_REQUEST", "MUX_TYPE_ACTIVE_HINT", "buffer", "offset", "i", "chars", "byte", "scheduleReconnect", "muxReconnectDelay", "MAX_RECONNECT_DELAY", "setMuxReconnectTimer", "muxReconnectTimer", "init_constants", "init_utils", "init_state", "log", "createLogger", "settingsWs", "settingsReconnectTimer", "settingsReconnectDelay", "INITIAL_RECONNECT_DELAY", "settingsWsConnected", "applyReceivedSettings", "registerSettingsCallbacks", "callbacks", "connectSettingsWebSocket", "protocol", "ws", "event", "settings", "handleSettingsUpdate", "e", "message", "scheduleSettingsReconnect", "setCurrentSettings", "scheduleReconnect", "MAX_RECONNECT_DELAY", "delay", "timer", "init_constants", "init_state", "init_utils", "init_constants", "init_state", "sendResize", "registerScalingCallbacks", "callbacks", "fitSessionToScreen", "sessionId", "state", "sessionTerminals", "fontsReadyPromise", "xterm", "wasHidden", "rect", "dom", "screen", "terminalCols", "terminalRows", "cellWidth", "cellHeight", "dims", "availWidth", "TERMINAL_PADDING", "availHeight", "cols", "rows", "MIN_TERMINAL_COLS", "MAX_TERMINAL_COLS", "MIN_TERMINAL_ROWS", "MAX_TERMINAL_ROWS", "applyTerminalScaling", "_sessionId", "container", "termWidth", "termHeight", "scaleX", "scaleY", "scale", "rescaleAllTerminals", "setupResizeObserver", "setupVisualViewport", "lastHeight", "updateViewportHeight", "vh", "mobileHeader", "headerHeight", "availableHeight", "init_state", "TEXT_FILE_SIZE_LIMIT", "IMAGE_EXTENSIONS", "REJECTED_EXTENSIONS", "pasteToTerminal", "getFileExtension", "filename", "lastDot", "isImageFile", "isRejectedFile", "showDropToast", "message", "existing", "toast", "readFileAsText", "file", "resolve", "reject", "reader", "sanitizePasteContent", "text", "registerFileDropCallbacks", "callbacks", "uploadFile", "sessionId", "formData", "response", "error", "handleFileDrop", "files", "activeSessionId", "imagePaths", "path", "ext", "content", "sanitized", "err", "joined", "setupFileDrop", "container", "e", "handleClipboardPaste", "items", "item", "imageType", "t", "blob", "timestamp", "init_state", "searchStates", "searchVisible", "searchInput", "searchResults", "searchContainer", "initSearchForTerminal", "sessionId", "terminal", "addon", "cleanupSearchForTerminal", "showSearch", "hideSearch", "activeSessionId", "state", "termState", "sessionTerminals", "isSearchVisible", "findNext", "query", "result", "updateSearchResults", "findPrevious", "found", "bindSearchEvents", "prevBtn", "nextBtn", "closeBtn", "e", "sendInput", "showBellNotification", "requestBufferRefresh", "pendingTitleUpdates", "updateSessionNameAuto", "sessionId", "name", "sessions", "s", "existing", "timer", "registerTerminalCallbacks", "callbacks", "getTerminalOptions", "isMobile", "MOBILE_BREAKPOINT", "baseFontSize", "currentSettings", "fontSize", "themeName", "fontFamily", "options", "TERMINAL_FONT_STACK", "THEMES", "isWindows", "windowsBuildNumber", "createTerminalForSession", "sessionInfo", "sessionTerminals", "container", "dom", "setupFileDrop", "terminal", "fitAddon", "serverCols", "serverRows", "state", "fontsReadyPromise", "webglAddon", "webLinksAddon", "_event", "uri", "initSearchForTerminal", "replayPendingFrames", "fitSessionToScreen", "setupTerminalEvents", "frames", "pendingOutputFrames", "payload", "writeOutputFrame", "frame", "parseOutputFrame", "currentCols", "currentRows", "applyTerminalScaling", "data", "title", "e", "getClipboardStyle", "handleClipboardPaste", "showSearch", "isSearchVisible", "hideSearch", "pasteHandler", "contextMenuHandler", "destroyTerminalForSession", "cleanupSearchForTerminal", "titleTimer", "pasteToTerminal", "isFilePath", "muxBpm", "isBracketedPasteEnabled", "xtermBpm", "wrapped", "preloadTerminalFont", "promise", "testSpan", "TERMINAL_FONT_STACK", "resolve", "setFontsReadyPromise", "init_state", "init_constants", "callbacks", "setSessionListCallbacks", "cbs", "getSessionDisplayInfo", "session", "termTitle", "getSessionDisplayName", "renderSessionList", "dom", "sessions", "isPending", "pendingSessions", "item", "activeSessionId", "info", "spinner", "displayInfo", "title", "subtitle", "actions", "resizeBtn", "icon", "e", "renameBtn", "closeBtn", "realSessionCount", "s", "updateEmptyState", "settingsOpen", "updateMobileTitle", "updateTitleBar", "init_state", "init_utils", "SIDEBAR_COLLAPSED_COOKIE", "SIDEBAR_WIDTH_COOKIE", "DESKTOP_BREAKPOINT", "MIN_SIDEBAR_WIDTH", "MAX_SIDEBAR_WIDTH", "toggleSidebar", "setSidebarOpen", "sidebarOpen", "dom", "closeSidebar", "collapseSidebar", "setSidebarCollapsed", "setCookie", "updateMobileTitle", "rescaleAllTerminals", "expandSidebar", "restoreSidebarState", "getCookie", "savedWidth", "width", "sidebar", "setupSidebarResize", "grip", "isResizing", "startX", "startWidth", "e", "delta", "newWidth", "currentWidth", "init_settings", "init_state", "checkAuthStatus", "response", "status", "setAuthStatus", "updateSecurityWarning", "updatePasswordStatus", "warning", "authStatus", "statusEl", "dismissSecurityWarning", "init_state", "init_utils", "passwordModalHasPassword", "showPasswordModal", "_isInitialSetup", "modal", "title", "currentGroup", "errorEl", "authStatus", "form", "focusFieldId", "field", "hidePasswordModal", "handlePasswordSubmit", "currentPw", "newPw", "confirmPw", "saveBtn", "newPassword", "confirmPassword", "showPasswordError", "payload", "r", "data", "result", "checkAuthStatus", "msg", "bindAuthEvents", "bindClick", "dismissSecurityWarning", "passwordBackdrop", "passwordForm", "init_state", "MAX_RELOAD_ATTEMPTS", "RELOAD_INTERVAL_MS", "INITIAL_RESTART_DELAY_MS", "renderUpdatePanel", "panel", "updateInfo", "currentEl", "latestEl", "noteEl", "headerEl", "applyUpdate", "btn", "r", "waitForServerAndReload", "e", "attempts", "checkServer", "checkForUpdates", "update", "setUpdateInfo", "renderUpdateCards", "error", "container", "statusNone", "hasGitHub", "hasLocal", "card", "createUpdateCard", "applyLocalUpdate", "opts", "warningClass", "warningText", "checkUpdateResult", "r", "result", "init_utils", "GITHUB_RELEASES_BASE", "PER_PAGE", "GITHUB_RELEASES_PAGE", "currentPage", "hasMoreReleases", "isLoading", "showChangelog", "modal", "body", "fetchReleases", "isInitial", "url", "r", "releases", "html", "release", "version", "date", "rawNotes", "notes", "stripVersionPrefix", "escapeHtml", "formatMarkdown", "existingBtn", "loadMoreBtn", "e", "closeChangelog", "text", "versionNum", "pattern", "escapeRegex", "str", "log", "createLogger", "ws", "reconnectTimer", "reconnectDelay", "MAX_RECONNECT_DELAY", "onLogEntry", "onHistory", "onSessions", "onConnectionChange", "setOnLogEntry", "callback", "setOnHistory", "setOnSessions", "setOnConnectionChange", "connectLogsWebSocket", "protocol", "event", "message", "handleMessage", "e", "scheduleReconnect", "subscribeMt", "sendMessage", "unsubscribeMt", "subscribeSession", "sessionId", "unsubscribeSession", "requestHistory", "type", "limit", "requestSessions", "isConnected", "ws", "message", "handleMessage", "onLogEntry", "onHistory", "onSessions", "scheduleReconnect", "reconnectTimer", "reconnectDelay", "MAX_RECONNECT_DELAY", "connectLogsWebSocket", "currentTab", "minLevel", "searchFilter", "liveTail", "displayedEntries", "refreshInterval", "selectedSessionId", "sessionsList", "initDiagnosticsPanel", "bindTabEvents", "bindControlEvents", "setupWebSocketCallbacks", "startRefreshLoop", "setOnLogEntry", "handleLogEntry", "setOnHistory", "handleHistory", "setOnSessions", "handleSessions", "setOnConnectionChange", "connected", "subscribeMt", "requestHistory", "subscribeSession", "requestSessions", "tab", "tabName", "switchTab", "unsubscribeMt", "unsubscribeSession", "t", "sessionSelect", "clearBtn", "isConnected", "connectLogsWebSocket", "refreshLogs", "levelFilter", "searchInput", "searchTimeout", "liveTailCheckbox", "scrollToBottom", "copyBtn", "copyAllLogs", "clearLogs", "sessionPicker", "entry", "addDisplayEntry", "levelStringToNumber", "displayEntry", "matchesSearch", "updateDisplay", "response", "e", "updateSessionPicker", "picker", "currentValue", "session", "option", "level", "content", "countEl", "entries", "readLogEntries", "filtered", "LOG_LEVEL_NAMES", "renderDisplayEntry", "time", "levelName", "escapedMessage", "escapeHtml", "escapedModule", "text", "div", "textarea", "init_state", "init_constants", "init_utils", "log", "createLogger", "sessionTerminals", "activeSessionId", "currentSettings", "initThemeFromCookie", "init", "initLogStorage", "setLogLevel", "setConsoleLogging", "cacheDOMElements", "restoreSidebarState", "setupSidebarResize", "fontPromise", "preloadTerminalFont", "setFontsReadyPromise", "registerCallbacks", "connectStateWebSocket", "connectMuxWebSocket", "connectSettingsWebSocket", "checkSystemHealth", "bindEvents", "bindAuthEvents", "bindSearchEvents", "setupResizeObserver", "setupVisualViewport", "fetchVersion", "fetchNetworks", "fetchSettings", "checkAuthStatus", "checkUpdateResult", "requestNotificationPermission", "initDiagnosticsPanel", "setupVisibilityChangeHandler", "registerStateCallbacks", "destroyTerminalForSession", "applyTerminalScaling", "renderSessionList", "updateEmptyState", "selectSession", "updateMobileTitle", "renderUpdatePanel", "registerMuxCallbacks", "registerSettingsCallbacks", "applyReceivedSettings", "registerTerminalCallbacks", "sendInput", "showBellNotification", "requestBufferRefresh", "registerFileDropCallbacks", "pasteToTerminal", "registerScalingCallbacks", "sessionId", "terminal", "sendResize", "setSessionListCallbacks", "deleteSession", "startInlineRename", "fitSessionToScreen", "closeSidebar", "stateWsConnected", "muxWsConnected", "createSession", "rect", "dom", "cols", "rows", "fontSize", "charWidth", "FONT_CHAR_WIDTH_RATIO", "lineHeight", "FONT_LINE_HEIGHT_RATIO", "availWidth", "TERMINAL_PADDING", "availHeight", "measuredCols", "measuredRows", "MIN_TERMINAL_COLS", "MIN_TERMINAL_ROWS", "MAX_TERMINAL_COLS", "MAX_TERMINAL_ROWS", "tempId", "tempSession", "sessions", "pendingSessions", "r", "session", "idx", "s", "newlyCreatedSessions", "e", "closeSettings", "state", "setActiveSessionId", "sendActiveSessionHint", "sessionInfo", "createTerminalForSession", "isNewlyCreated", "firstSession", "renameSession", "newName", "trimmedName", "nameToSend", "item", "titleSpan", "currentName", "input", "finishRename", "promptRenameSession", "bellStyle", "title", "getSessionDisplayName", "v", "version", "el", "networks", "list", "protocol", "port", "n", "url", "escapeHtml", "bindClick", "toggleSidebar", "collapseSidebar", "expandSidebar", "toggleSettings", "applyUpdate", "checkForUpdates", "showChangelog", "closeChangelog", "changelogBackdrop", "mod"]
}
