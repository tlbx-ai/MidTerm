"use strict";(()=>{var wn=Object.defineProperty;var b=(e,t)=>()=>(e&&(t=e(e=0)),t);var gt=(e,t)=>{for(var n in t)wn(e,n,{get:t[n],enumerable:!0})};var w,G,ce,q=b(()=>{"use strict";w={dark:{background:"#16161E",foreground:"#C0CAF5",cursor:"#C0CAF5",cursorAccent:"#16161E",selectionBackground:"#283457"},light:{background:"#D5D6DB",foreground:"#343B58",cursor:"#343B58",cursorAccent:"#D5D6DB",selectionBackground:"#9FA0A5"},solarizedDark:{background:"#002B36",foreground:"#839496",cursor:"#839496",cursorAccent:"#002B36",selectionBackground:"#073642"},solarizedLight:{background:"#FDF6E3",foreground:"#657B83",cursor:"#657B83",cursorAccent:"#FDF6E3",selectionBackground:"#EEE8D5"}},G=1e3,ce=3e4});function ht(e){u=e}function Q(e){c=e}function Ae(e){m=e}function ge(e){C=e}function vt(e){L=e}function Be(e){U=e}function Ie(e){de=e}function he(e){Tn=e}function St(e){Cn=e}function yt(e){ue=e}function Re(e){me=e}function Pe(e){$=e}function bt(e){P=e}function xt(e){pe=e}function He(e){J=e}function Ne(e){W=e}function ve(e){Z=e}function Et(e){fe=e}function wt(){r.sessionList=document.getElementById("session-list"),r.sessionCount=document.getElementById("session-count"),r.terminalsArea=document.querySelector(".terminals-area"),r.emptyState=document.getElementById("empty-state"),r.mobileTitle=document.getElementById("mobile-title"),r.topbarActions=document.getElementById("topbar-actions"),r.app=document.getElementById("app"),r.sidebarOverlay=document.getElementById("sidebar-overlay"),r.settingsView=document.getElementById("settings-view"),r.settingsBtn=document.getElementById("btn-settings"),r.islandTitle=document.getElementById("island-title")}var u,c,m,C,L,U,de,Tn,Cn,ue,me,$,P,pe,J,W,fe,p,j,F,k,Z,r,y=b(()=>{"use strict";u=[],c=null,m=null,C=null,L=null,U=!1,de=!1,Tn=!1,Cn=null,me=1e3,$=!1,P=null,J=1e3,W=!1,fe=null,p=new Map,j=new Set,F=new Set,k=new Map,Z=null,r={sessionList:null,sessionCount:null,terminalsArea:null,emptyState:null,mobileTitle:null,topbarActions:null,app:null,sidebarOverlay:null,settingsView:null,settingsBtn:null,islandTitle:null}});function H(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function g(e,t){let n=document.getElementById(e);n&&n.addEventListener("click",t)}function Tt(e,t){let n;return(...o)=>{n!==void 0&&clearTimeout(n),n=window.setTimeout(()=>e(...o),t)}}var Ct=b(()=>{"use strict"});function De(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):null}function _(e,t,n=365){let o=new Date(Date.now()+n*24*60*60*1e3).toUTCString();document.cookie=`${e}=${encodeURIComponent(t)}; expires=${o}; path=/`}function Lt(e){if(e!=="auto")return e;let t=navigator.userAgent||"";return/Windows|Win32|Win64/i.test(t)?"windows":"unix"}var kt=b(()=>{"use strict"});var M=b(()=>{"use strict";Ct();kt()});function Fe(e){e.sendResize&&(Ot=e.sendResize)}function te(e){let t=p.get(e);if(!t)return;if(!t.opened){(Z??Promise.resolve()).then(()=>{te(e)});return}let n=t.container.querySelector(".xterm");n&&(n.style.zoom="",n.style.transform="",t.container.classList.remove("scaled"));let o=t.container.classList.contains("hidden");o&&t.container.classList.remove("hidden"),requestAnimationFrame(()=>{t.fitAddon.fit(),Ot(e,t.terminal),o&&t.container.classList.add("hidden")})}function N(e,t){let n=t.container,o=n.querySelector(".xterm");o&&requestAnimationFrame(()=>{let s=n.clientWidth-8,i=n.clientHeight-8,l=o.offsetWidth,a=o.offsetHeight,d=s/l,f=i/a,v=Math.min(d,f,1);v<.99?(o.style.zoom=v,o.style.transform="",n.classList.add("scaled")):(o.style.zoom="",o.style.transform="",n.classList.remove("scaled"))})}function _e(){window.addEventListener("resize",Tt(()=>{p.forEach((e,t)=>{e.opened&&N(t,e)})},100))}function Oe(){if(!window.visualViewport||!r.terminalsArea)return;let e=0,t=()=>{let n=window.visualViewport.height;if(Math.abs(n-e)<1)return;e=n,document.documentElement.style.setProperty("--visual-vh",n+"px");let o=document.querySelector(".mobile-header"),s=0;o&&window.getComputedStyle(o).display!=="none"&&(s=o.offsetHeight);let i=Math.floor((n-s)*.99);r.terminalsArea.style.height=i+"px"};window.visualViewport.addEventListener("resize",t),t()}var Ot,ze=b(()=>{"use strict";y();M();Ot=()=>{}});function $e(e,t){try{let n=new SearchAddon.SearchAddon;t.loadAddon(n),oe.set(e,{addon:n,currentIndex:0,totalMatches:0})}catch{}}function Dn(e){oe.delete(e)}function je(){X||(X=document.getElementById("terminal-search"),D=document.getElementById("search-input"),B=document.getElementById("search-results")),X&&D&&(X.classList.remove("hidden"),qe=!0,D.focus(),D.select())}function ne(){if(X&&(X.classList.add("hidden"),qe=!1),c){let e=oe.get(c);e?.addon&&e.addon.clearDecorations()}if(c){let e=p.get(c);e&&e.terminal.focus()}}function Xe(){return qe}function be(){if(!c||!D)return;let e=D.value;if(!e)return;let t=oe.get(c);if(!t?.addon)return;let n=t.addon.findNext(e,{incremental:!1});zt(n)}function Ve(){if(!c||!D)return;let e=D.value;if(!e)return;let t=oe.get(c);if(!t?.addon)return;let n=t.addon.findPrevious(e);zt(n)}function zt(e){B&&(e?(B.textContent="Found",B.style.color=""):(B.textContent="No matches",B.style.color="var(--accent-red)"))}function Ye(){let e=document.getElementById("search-input"),t=document.getElementById("search-prev"),n=document.getElementById("search-next"),o=document.getElementById("search-close");e&&(e.addEventListener("input",()=>{c&&e.value?be():B&&(B.textContent="0/0",B.style.color="")}),e.addEventListener("keydown",s=>{s.key==="Enter"?(s.preventDefault(),s.shiftKey?Ve():be()):s.key==="Escape"&&(s.preventDefault(),ne())})),t&&t.addEventListener("click",Ve),n&&n.addEventListener("click",be),o&&o.addEventListener("click",ne)}var oe,qe,D,B,X,Ke=b(()=>{"use strict";y();oe=new Map,qe=!1,D=null,B=null,X=null});function Un(e,t){if(u.find(i=>i.id===e)?.manuallyNamed)return;let o=Ge.get(e);o&&window.clearTimeout(o);let s=window.setTimeout(()=>{Ge.delete(e),fetch(`/api/sessions/${e}/name?auto=true`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}).catch(()=>{})},500);Ge.set(e,s)}function Je(e){e.sendInput&&(se=e.sendInput),e.showBellNotification&&(Vt=e.showBellNotification)}function Ze(){let e=window.innerWidth<=768,t=m?.fontSize??14,n=e?Math.max(t-2,10):t,o=m?.theme??"dark",s=m?.fontFamily??"Cascadia Code",i={cursorBlink:m?.cursorBlink??!0,cursorStyle:m?.cursorStyle??"bar",fontFamily:`'${s}', 'Cascadia Mono', Consolas, 'Courier New', monospace`,fontSize:n,letterSpacing:0,lineHeight:1,scrollback:m?.scrollbackLines??1e4,minimumContrastRatio:m?.minimumContrastRatio??1,smoothScrollDuration:m?.smoothScrolling?150:0,allowProposedApi:!0,customGlyphs:!0,rescaleOverlappingGlyphs:!0,theme:w[o]??w.dark};return fe!==null&&(i.windowsPty={backend:"conpty",buildNumber:fe}),i}function Qe(e,t){let n=p.get(e);if(n)return n;let o=document.createElement("div");o.className="terminal-container hidden",o.id="terminal-"+e,r.terminalsArea?.appendChild(o);let s=new Terminal(Ze()),i=new FitAddon.FitAddon;s.loadAddon(i);let l=t&&t.cols>0?t.cols:0,a=t&&t.rows>0?t.rows:0,d={terminal:s,fitAddon:i,container:o,serverCols:l,serverRows:a,opened:!1};return p.set(e,d),(Z??Promise.resolve()).then(()=>{if(p.has(e)){if(s.open(o),d.opened=!0,_n(s),m?.useWebGL!==!1)try{let f=new WebglAddon.WebglAddon;f.onContextLost(()=>{f.dispose()}),s.loadAddon(f)}catch{}try{let f=new WebLinksAddon.WebLinksAddon((v,h)=>{(h.startsWith("http://")||h.startsWith("https://"))&&window.open(h,"_blank","noopener,noreferrer")});s.loadAddon(f)}catch{}$e(e,s),Wn(e,d),requestAnimationFrame(()=>{p.has(e)&&(d.serverCols>0&&d.serverRows>0&&(s.resize(d.serverCols,d.serverRows),N(e,d)),$t(e,s,o))})}}),d}function Wn(e,t){let n=k.get(e);n&&n.length>0&&(n.forEach(o=>{qt(e,t,o)}),k.delete(e))}function qt(e,t,n){let o=n[0]|n[1]<<8,s=n[2]|n[3]<<8,i=n.slice(4);if(o>0&&o<=500&&s>0&&s<=500&&t.terminal._core&&t.terminal._core._renderService){let a=t.terminal.cols,d=t.terminal.rows;if(a!==o||d!==s)try{t.terminal.resize(o,s),t.serverCols=o,t.serverRows=s,N(e,t)}catch{}}i.length>0&&t.terminal.write(i)}function $t(e,t,n){t.onData(i=>{se(e,i)}),t.onBell(()=>{Vt(e)}),t.onSelectionChange(()=>{m?.copyOnSelect&&t.hasSelection()&&navigator.clipboard.writeText(t.getSelection()).catch(()=>{})}),t.onTitleChange(i=>{i&&i.trim()&&Un(e,i.trim())}),t.attachCustomKeyEventHandler(i=>{if(i.type!=="keydown")return!0;if(Lt(m?.clipboardShortcuts??"auto")==="windows"){if(i.ctrlKey&&!i.shiftKey&&i.key==="c")return t.hasSelection()?(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection(),!1):!0;if(i.ctrlKey&&!i.shiftKey&&i.key==="v")return navigator.clipboard.readText().then(a=>{a&&se(e,a)}).catch(()=>{}),!1}else{if(i.ctrlKey&&i.shiftKey&&(i.key==="C"||i.key==="c"))return t.hasSelection()&&(navigator.clipboard.writeText(t.getSelection()).catch(()=>{}),t.clearSelection()),!1;if(i.ctrlKey&&i.shiftKey&&(i.key==="V"||i.key==="v"))return navigator.clipboard.readText().then(a=>{a&&se(e,a)}).catch(()=>{}),!1}return(i.ctrlKey||i.metaKey)&&i.key==="f"?(je(),!1):i.key==="Escape"&&Xe()?(ne(),!1):!0});let o=i=>{(!m||m.rightClickPaste!==!1)&&(i.preventDefault(),navigator.clipboard.readText().then(l=>{l&&se(e,l)}).catch(()=>{}))};n.addEventListener("contextmenu",o);let s=p.get(e);s&&(s.contextMenuHandler=o)}function xe(e){let t=p.get(e);t&&(t.contextMenuHandler&&t.container.removeEventListener("contextmenu",t.contextMenuHandler),t.terminal.dispose(),t.container.remove(),p.delete(e),k.delete(e))}function Fn(){let e=Ze();p.forEach(t=>{t.terminal.options.cursorBlink=e.cursorBlink,t.terminal.options.cursorStyle=e.cursorStyle,t.terminal.options.fontSize=e.fontSize,t.terminal.options.theme=e.theme})}function jt(e,t){fetch("/api/sessions/"+e+"/buffer").then(n=>n.ok?n.text():"").then(n=>{n&&t.write(n)}).catch(n=>{console.error("Error fetching buffer:",n)})}function Ee(){if(!c)return;let e=p.get(c);e&&e.opened&&(e.terminal.clear(),jt(c,e.terminal))}function et(){let e=document.fonts.ready.then(()=>{let t=document.createElement("span");return t.style.fontFamily="'Cascadia Code', 'Cascadia Mono', Consolas, monospace",t.style.position="absolute",t.style.left="-9999px",t.textContent="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",document.body.appendChild(t),new Promise(n=>{requestAnimationFrame(()=>{t.remove(),n()})})});return ve(e),e}function _n(e){try{if(!e._core)return;let n=e.element?.querySelectorAll("canvas");if(!n)return;n.forEach(o=>{let s=o.getContext("2d");if(!s||s._patchedForPixelPerfect)return;s._patchedForPixelPerfect=!0;let i=s.fillRect.bind(s);s.fillRect=(h,S,I,R)=>{i(Math.round(h),Math.round(S),Math.round(I),Math.round(R))};let l=s.strokeRect.bind(s);s.strokeRect=(h,S,I,R)=>{l(Math.round(h),Math.round(S),Math.round(I),Math.round(R))};let a=s.fillText.bind(s);s.fillText=(h,S,I,R)=>{R!==void 0?a(h,Math.round(S),Math.round(I),R):a(h,Math.round(S),Math.round(I))};let d=s.clearRect.bind(s);s.clearRect=(h,S,I,R)=>{d(Math.round(h),Math.round(S),Math.round(I),Math.round(R))};let f=s.moveTo.bind(s);s.moveTo=(h,S)=>{f(Math.round(h)+.5,Math.round(S)+.5)};let v=s.lineTo.bind(s);s.lineTo=(h,S)=>{v(Math.round(h)+.5,Math.round(S)+.5)}})}catch{}}var se,Vt,Ge,Xt=b(()=>{"use strict";q();y();M();ze();Ke();se=()=>{},Vt=()=>{},Ge=new Map});var Yt={};gt(Yt,{applySettingsToTerminals:()=>Fn,applyTerminalScaling:()=>N,bindSearchEvents:()=>Ye,cleanupSearchForTerminal:()=>Dn,createTerminalForSession:()=>Qe,destroyTerminalForSession:()=>xe,fetchAndWriteBuffer:()=>jt,findNext:()=>be,findPrevious:()=>Ve,fitSessionToScreen:()=>te,getTerminalOptions:()=>Ze,hideSearch:()=>ne,initSearchForTerminal:()=>$e,isSearchVisible:()=>Xe,preloadTerminalFont:()=>et,refreshActiveTerminalBuffer:()=>Ee,registerScalingCallbacks:()=>Fe,registerTerminalCallbacks:()=>Je,setupResizeObserver:()=>_e,setupTerminalEvents:()=>$t,setupVisualViewport:()=>Oe,showSearch:()=>je,writeOutputFrame:()=>qt});var tt=b(()=>{"use strict";Xt();ze();Ke()});function x(e,t){let n=document.getElementById(e);n&&(n.value=String(t))}function z(e,t){let n=document.getElementById(e);n&&(n.checked=t)}function E(e,t){let n=document.getElementById(e);return n?n.value:t}function V(e){let t=document.getElementById(e);return t?t.checked:!1}function sn(e){let t=document.getElementById("version-web");if(t&&e){let n=e.split(/[+-]/)[0].split(".").slice(0,3).join(".");t.textContent="v"+n}}function rn(e,t){let n=document.getElementById("setting-run-as-user");n&&(n.innerHTML='<option value="">Process Owner (default)</option>',e.forEach(o=>{let s=document.createElement("option");s.value=o.username,s.textContent=o.username,o.username===t&&(s.selected=!0),n.appendChild(s)}))}function an(e){x("setting-default-shell",e.defaultShell||"Pwsh"),x("setting-working-dir",e.defaultWorkingDirectory||""),x("setting-font-size",e.fontSize||14),x("setting-font-family",e.fontFamily||"Cascadia Code"),x("setting-cursor-style",e.cursorStyle||"bar"),z("setting-cursor-blink",e.cursorBlink!==!1),x("setting-theme",e.theme||"dark"),x("setting-contrast",String(e.minimumContrastRatio||1)),x("setting-scrollback",e.scrollbackLines||1e4),x("setting-bell-style",e.bellStyle||"notification"),z("setting-copy-on-select",e.copyOnSelect===!0),z("setting-right-click-paste",e.rightClickPaste!==!1),x("setting-clipboard-shortcuts",e.clipboardShortcuts||"auto"),z("setting-smooth-scrolling",e.smoothScrolling===!0),z("setting-webgl",e.useWebGL!==!1),x("setting-run-as-user",e.runAsUser||""),z("setting-debug-logging",e.debugLogging===!0)}async function ie(){try{let[e,t,n]=await Promise.all([fetch("/api/settings").then(o=>o.json()),fetch("/api/users").then(o=>o.json()).catch(()=>[]),fetch("/api/version").then(o=>o.text()).catch(()=>null)]);Ae(e),rn(t,e.runAsUser),an(e),sn(n),ln()}catch(e){console.error("Error fetching settings:",e)}}function ln(){if(!m)return;let e=w[m.theme]||w.dark,t=`'${m.fontFamily||"Cascadia Code"}', 'Cascadia Mono', Consolas, 'Courier New', monospace`;p.forEach(n=>{n.terminal.options.cursorBlink=m.cursorBlink,n.terminal.options.cursorStyle=m.cursorStyle,n.terminal.options.fontFamily=t,n.terminal.options.fontSize=m.fontSize,n.terminal.options.theme=e,n.terminal.options.minimumContrastRatio=m.minimumContrastRatio,n.terminal.options.smoothScrollDuration=m.smoothScrolling?150:0,n.opened&&n.fitAddon.fit()})}function Le(){let e=E("setting-run-as-user",""),t={defaultShell:E("setting-default-shell","Pwsh"),defaultWorkingDirectory:E("setting-working-dir",""),fontSize:parseInt(E("setting-font-size","14"),10)||14,fontFamily:E("setting-font-family","Cascadia Code"),cursorStyle:E("setting-cursor-style","bar"),cursorBlink:V("setting-cursor-blink"),theme:E("setting-theme","dark"),minimumContrastRatio:parseFloat(E("setting-contrast","1"))||1,smoothScrolling:V("setting-smooth-scrolling"),useWebGL:V("setting-webgl"),scrollbackLines:parseInt(E("setting-scrollback","10000"),10)||1e4,bellStyle:E("setting-bell-style","notification"),copyOnSelect:V("setting-copy-on-select"),rightClickPaste:V("setting-right-click-paste"),clipboardShortcuts:E("setting-clipboard-shortcuts","auto"),runAsUser:e||null,debugLogging:V("setting-debug-logging")};_("mm-theme",t.theme),fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(n=>{if(n.ok){Ae(t);let o=w[t.theme]||w.dark;document.documentElement.style.setProperty("--terminal-bg",o.background),ln()}}).catch(n=>{console.error("Error saving settings:",n)})}function Vn(){let e=r.settingsView;e&&(e.querySelectorAll('select, input[type="checkbox"]').forEach(t=>{t.addEventListener("change",Le)}),e.querySelectorAll(".text-input-wrapper").forEach(t=>{let n=t.querySelector("input"),o=t.querySelector(".inline-save-btn");if(!n||!o)return;let s="";n.addEventListener("focus",()=>{s=n.value}),n.addEventListener("input",()=>{t.classList.toggle("unsaved",n.value!==s)}),o.addEventListener("click",()=>{Le(),t.classList.remove("unsaved"),s=n.value}),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),Le(),t.classList.remove("unsaved"),s=n.value)})}))}var ot=b(()=>{"use strict";q();y();M()});function qn(){let e=r.app;e&&e.classList.remove("sidebar-open")}function st(){U?ke():cn()}function cn(){if(Be(!0),r.settingsBtn&&r.settingsBtn.classList.add("active"),qn(),c){let e=p.get(c);e&&e.container.classList.add("hidden")}r.emptyState&&r.emptyState.classList.add("hidden"),r.settingsView&&r.settingsView.classList.remove("hidden"),ie(),un()}function ke(){if(Be(!1),r.settingsBtn&&r.settingsBtn.classList.remove("active"),r.settingsView&&r.settingsView.classList.add("hidden"),c){let e=p.get(c);e&&(e.container.classList.remove("hidden"),requestAnimationFrame(()=>{e.terminal.focus()}))}else u.length===0&&r.emptyState&&r.emptyState.classList.remove("hidden")}function dn(e){if(e<60)return e+"s";if(e<3600)return Math.floor(e/60)+"m "+e%60+"s";let t=Math.floor(e/3600),n=Math.floor(e%3600/60);return t<24?t+"h "+n+"m":Math.floor(t/24)+"d "+t%24+"h"}function it(e){let t=document.getElementById("conhost-warning");if(!t){t=document.createElement("div"),t.id="conhost-warning",t.className="warning-banner";let o=document.querySelector(".app-header");o&&o.parentNode&&o.parentNode.insertBefore(t,o.nextSibling)}let n=e;e.conHostVersion&&n.conHostCompatible===!1?(t.innerHTML="<strong>Version mismatch:</strong> mmttyhost is "+e.conHostVersion+", expected "+n.conHostExpected+". Terminals may not work correctly. Please update mmttyhost.exe or restart the service.",t.style.display="block"):t.style.display="none"}function un(){let e=document.getElementById("system-status-content");e&&fetch("/api/health").then(t=>t.json()).then(t=>{let n=t.healthy?"status-healthy":"status-error",o=t.healthy?"Healthy":"Unhealthy",s=dn(t.uptimeSeconds||0),i="";t.conHostVersion!==null&&t.conHostVersion!==void 0&&(i='<div class="status-detail-row"><span class="detail-label">mmttyhost</span><span class="detail-value '+(t.conHostCompatible?"":"status-error")+'">'+t.conHostVersion+(t.conHostCompatible?"":" expected "+t.conHostExpected)+"</span></div>"),e.innerHTML='<div class="status-grid"><div class="status-item"><span class="status-label">Status</span><span class="status-value '+n+'">'+o+'</span></div><div class="status-item"><span class="status-label">Mode</span><span class="status-value">'+(t.mode||"")+'</span></div><div class="status-item"><span class="status-label">Sessions</span><span class="status-value">'+t.sessionCount+'</span></div><div class="status-item"><span class="status-label">Uptime</span><span class="status-value">'+s+'</span></div></div><div class="status-details"><div class="status-detail-row"><span class="detail-label">Platform</span><span class="detail-value">'+(t.platform||"")+'</span></div><div class="status-detail-row"><span class="detail-label">Process ID</span><span class="detail-value">'+(t.webProcessId||"")+"</span></div>"+i+"</div>",it(t)}).catch(t=>{e.innerHTML='<div class="status-error-msg">Failed to load system status: '+t.message+"</div>"})}function rt(){fetch("/api/health").then(e=>e.json()).then(e=>{it(e),e.windowsBuildNumber!==void 0&&Et(e.windowsBuildNumber)}).catch(()=>{})}var mn=b(()=>{"use strict";y();ot()});var pn={};gt(pn,{bindSettingsAutoSave:()=>Vn,checkSystemHealth:()=>rt,closeSettings:()=>ke,fetchSettings:()=>ie,fetchSystemStatus:()=>un,formatUptime:()=>dn,getElementChecked:()=>V,getElementValue:()=>E,openSettings:()=>cn,populateSettingsForm:()=>an,populateUserDropdown:()=>rn,populateVersionInfo:()=>sn,saveAllSettings:()=>Le,setElementChecked:()=>z,setElementValue:()=>x,toggleSettings:()=>st,updateConHostWarning:()=>it});var at=b(()=>{"use strict";mn();ot()});q();y();M();function Mt(){let e=document.cookie.match(/mm-theme=([^;]+)/)?.[1];e&&w[e]&&document.documentElement.style.setProperty("--terminal-bg",w[e].background)}q();y();var At=()=>{},Bt=()=>{},It=()=>{},Rt=()=>{},Ue=()=>{},Pt=()=>{},Ht=()=>{};function Nt(e){e.destroyTerminalForSession&&(At=e.destroyTerminalForSession),e.applyTerminalScaling&&(Bt=e.applyTerminalScaling),e.renderSessionList&&(It=e.renderSessionList),e.updateEmptyState&&(Rt=e.updateEmptyState),e.selectSession&&(Ue=e.selectSession),e.updateMobileTitle&&(Pt=e.updateMobileTitle),e.renderUpdatePanel&&(Ht=e.renderUpdatePanel)}function Se(){let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/state`);St(t),t.onopen=()=>{Re(G),Pe(!0),ee()},t.onmessage=n=>{try{let o=JSON.parse(n.data),s=o.sessions?.sessions??[];Ln(s),kn(o.update)}catch(o){console.error("Error parsing state:",o)}},t.onclose=()=>{Pe(!1),ee(),Mn()},t.onerror=n=>{console.error("State WebSocket error:",n)}}function Ln(e){let t=new Set(e.map(n=>n.id));p.forEach((n,o)=>{t.has(o)||(At(o),j.delete(o))}),e.forEach(n=>{let o=p.get(n.id);o&&o.opened?(o.serverCols!==n.cols||o.serverRows!==n.rows)&&(o.serverCols=n.cols,o.serverRows=n.rows,o.terminal.resize(n.cols,n.rows),Bt(n.id,o)):o&&(o.serverCols=n.cols,o.serverRows=n.rows)}),ht(e),It(),Rt(),!c&&u.length>0&&Ue(u[0].id),c&&!u.find(n=>n.id===c)&&(Q(null),u.length>0&&Ue(u[0].id)),Pt()}function kn(e){ge(e),Ht()}function Mn(){ue!==void 0&&clearTimeout(ue);let e=me,t=window.setTimeout(()=>{Re(Math.min(me*1.5,ce)),Se()},e);yt(t)}function ee(){let e=document.getElementById("connection-status");if(!e)return;let t,n;$&&W?(t="connected",n=""):!$&&!W?(t="disconnected",n="Server disconnected"):(t="reconnecting",n="Reconnecting..."),e.className=`connection-status ${t}`,e.textContent=n}q();y();var Dt=()=>{},Ut=()=>{};function Wt(e){e.applyTerminalScaling&&(Dt=e.applyTerminalScaling),e.refreshActiveTerminalBuffer&&(Ut=e.refreshActiveTerminalBuffer)}function ye(){let e=location.protocol==="https:"?"wss:":"ws:",t=new WebSocket(`${e}//${location.host}/ws/mux`);t.binaryType="arraybuffer",bt(t),t.onopen=()=>{let n=J>G;He(G),Ne(!0),ee(),n&&Ut()},t.onmessage=n=>{if(!(n.data instanceof ArrayBuffer))return;let o=new Uint8Array(n.data);if(o.length<9)return;let s=o[0],i=Pn(o,1),l=o.slice(9);if(s===5){console.log("[Resync] Clearing terminals for buffer refresh"),p.forEach(a=>{a.opened&&a.terminal.clear()}),k.clear();return}if(s===1){let a=p.get(i);a&&a.opened&&l.length>=4?Nn(i,a,l):l.length>=4&&(k.has(i)||k.set(i,[]),k.get(i).push(l.slice()))}},t.onclose=()=>{Ne(!1),ee(),Hn()},t.onerror=n=>{console.error("Mux WebSocket error:",n)}}function We(e,t){if(!P||P.readyState!==WebSocket.OPEN)return;let n=new TextEncoder().encode(t),o=new Uint8Array(9+n.length);o[0]=2,_t(o,1,e),o.set(n,9),P.send(o)}function Ft(e,t,n){if(!P||P.readyState!==WebSocket.OPEN)return;let o=new Uint8Array(13);o[0]=3,_t(o,1,e),o[9]=t&255,o[10]=t>>8&255,o[11]=n&255,o[12]=n>>8&255,P.send(o);let s=p.get(e);s&&(s.serverCols=t,s.serverRows=n)}function _t(e,t,n){for(let o=0;o<8;o++)e[t+o]=o<n.length?n.charCodeAt(o):0}function Pn(e,t){let n=[];for(let o=0;o<8;o++)e[t+o]!==0&&n.push(String.fromCharCode(e[t+o]));return n.join("")}function Hn(){pe!==void 0&&clearTimeout(pe);let e=J,t=window.setTimeout(()=>{He(Math.min(J*1.5,ce)),ye()},e);xt(t)}function Nn(e,t,n){let o=n[0]|n[1]<<8,s=n[2]|n[3]<<8,i=n.slice(4),l=o>0&&o<=500&&s>0&&s<=500,a=t.terminal._core;if(l&&a&&a._renderService){let d=t.terminal.cols,f=t.terminal.rows;if(d!==o||f!==s)try{t.terminal.resize(o,s),t.serverCols=o,t.serverRows=s,Dt(e,t)}catch(v){console.warn("Terminal resize deferred:",v.message)}}i.length>0&&t.terminal.write(i)}tt();y();var T=null;function Kt(e){T=e}function O(e){return e.name||e.shellType}function Y(){if(!r.sessionList)return;r.sessionList.innerHTML="",u.forEach(t=>{let n=F.has(t.id),o=document.createElement("div");o.className="session-item"+(t.id===c?" active":"")+(n?" pending":""),o.dataset.sessionId=t.id,n||o.addEventListener("click",()=>{T&&(T.onSelect(t.id),T.onCloseSidebar())});let s=document.createElement("div");if(s.className="session-info",n){let a=document.createElement("span");a.className="session-spinner",s.appendChild(a)}let i=document.createElement("span");i.className="session-title",i.textContent=O(t),s.appendChild(i);let l=document.createElement("div");if(l.className="session-actions",!n){let a=document.createElement("button");a.className="session-resize",a.innerHTML="\u2922",a.title="Fit to screen",a.addEventListener("click",v=>{v.stopPropagation(),T&&T.onResize(t.id)});let d=document.createElement("button");d.className="session-rename",d.innerHTML="\u270F\uFE0F",d.title="Rename session",d.addEventListener("click",v=>{v.stopPropagation(),T&&T.onRename(t.id)});let f=document.createElement("button");f.className="session-close",f.innerHTML="&times;",f.title="Close session",f.addEventListener("click",v=>{v.stopPropagation(),T&&T.onDelete(t.id)}),l.appendChild(a),l.appendChild(d),l.appendChild(f)}o.appendChild(s),o.appendChild(l),r.sessionList.appendChild(o)});let e=u.filter(t=>!F.has(t.id)).length;r.sessionCount&&(r.sessionCount.textContent=String(e))}function we(){r.emptyState&&(u.length===0?(r.emptyState.classList.remove("hidden"),r.settingsView&&r.settingsView.classList.add("hidden")):U||r.emptyState.classList.add("hidden"))}function Te(){if(!r.mobileTitle)return;let e=u.find(t=>t.id===c);r.mobileTitle.textContent=e?O(e):"MiddleManager",r.topbarActions&&(e?r.topbarActions.classList.remove("no-terminal"):r.topbarActions.classList.add("no-terminal")),r.islandTitle&&(r.islandTitle.textContent=e?O(e):"MiddleManager")}y();M();var nt="mm-sidebar-collapsed",Gt="mm-sidebar-width",On=768,Jt=180,Zt=400;function Qt(){Ie(!de),r.app&&r.app.classList.toggle("sidebar-open",de)}function Ce(){Ie(!1),r.app&&r.app.classList.remove("sidebar-open")}function en(){he(!0),r.app&&r.app.classList.add("sidebar-collapsed"),_(nt,"true"),zn()}function tn(){he(!1),r.app&&r.app.classList.remove("sidebar-collapsed"),_(nt,"false")}function zn(){if(!r.islandTitle)return;let e=u.find(t=>t.id===c);r.islandTitle.textContent=e?O(e):"MiddleManager"}function nn(){De(nt)==="true"&&window.innerWidth>On&&(he(!0),r.app&&r.app.classList.add("sidebar-collapsed"));let e=De(Gt);if(e){let t=parseInt(e,10);if(t>=Jt&&t<=Zt){let n=document.getElementById("sidebar");n&&(n.style.width=t+"px")}}}function on(){let e=document.getElementById("sidebar-resize-grip"),t=document.getElementById("sidebar");if(!e||!t)return;let n=!1,o=0,s=0;e.addEventListener("mousedown",i=>{n=!0,o=i.clientX,s=t.offsetWidth,e.classList.add("active"),document.body.style.cursor="ew-resize",document.body.style.userSelect="none",i.preventDefault()}),document.addEventListener("mousemove",i=>{if(!n)return;let l=i.clientX-o,a=Math.max(Jt,Math.min(Zt,s+l));t.style.width=a+"px"}),document.addEventListener("mouseup",()=>{if(!n)return;n=!1,e.classList.remove("active"),document.body.style.cursor="",document.body.style.userSelect="";let i=t.offsetWidth;_(Gt,String(i))})}at();y();async function re(){try{let e=await fetch("/api/auth/status");if(e.status===401){window.location.href="/login.html";return}let t=await e.json();vt(t),fn(),gn()}catch(e){console.error("Auth status error:",e)}}function fn(){let e=document.getElementById("security-warning");e&&(L&&L.authenticationEnabled&&!L.passwordSet?e.classList.remove("hidden"):e.classList.add("hidden"))}function gn(){let e=document.getElementById("password-status-text");if(e){if(!L){e.textContent="Checking...",e.className="";return}L.passwordSet?(e.textContent="Password is set",e.className="status-set"):(e.textContent="No password set",e.className="status-missing")}}function lt(){let e=document.getElementById("security-warning");e&&e.classList.add("hidden")}y();M();var ae=!1;function ct(e){let t=document.getElementById("password-modal"),n=document.getElementById("password-modal-title"),o=document.getElementById("current-password-group"),s=document.getElementById("password-error");if(!t)return;ae=L?.passwordSet??!1,n&&(n.textContent=ae?"Change Password":"Set Password"),o&&(o.style.display=ae?"block":"none"),s&&(s.classList.add("hidden"),s.textContent="");let i=document.getElementById("password-form");i&&i.reset(),t.classList.remove("hidden");let l=ae?"current-password":"new-password",a=document.getElementById(l);a&&a.focus()}function le(){let e=document.getElementById("password-modal");e&&e.classList.add("hidden")}function hn(e){e.preventDefault();let t=document.getElementById("current-password"),n=document.getElementById("new-password"),o=document.getElementById("confirm-password"),s=document.getElementById("btn-save-password"),i=n?.value??"",l=o?.value??"";if(!i){K("New password is required");return}if(i!==l){K("Passwords do not match");return}if(i.length<4){K("Password must be at least 4 characters");return}let a={currentPassword:ae&&t?t.value:null,newPassword:i};s&&(s.disabled=!0,s.textContent="Saving..."),fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(d=>d.json().then(f=>({ok:d.ok,data:f}))).then(d=>{s&&(s.disabled=!1,s.textContent="Save"),d.ok&&d.data.success?(le(),re()):K(d.data.error||"Failed to change password")}).catch(()=>{s&&(s.disabled=!1,s.textContent="Save"),K("Connection error")})}function K(e){let t=document.getElementById("password-error");t&&(t.textContent=e,t.classList.remove("hidden"))}function dt(){g("btn-set-password-warning",()=>{ct(!0)}),g("btn-dismiss-warning",lt),g("btn-change-password",()=>{ct(!1)}),g("btn-close-password",le),g("btn-cancel-password",le);let e=document.querySelector("#password-modal .modal-backdrop");e&&e.addEventListener("click",le);let t=document.getElementById("password-form");t&&t.addEventListener("submit",hn)}y();var vn=30,Sn=2e3,$n=3e3;function ut(){let e=document.getElementById("update-panel");if(!e)return;if(!C||!C.available){e.classList.add("hidden");return}e.classList.remove("hidden");let t=e.querySelector(".update-current"),n=e.querySelector(".update-latest"),o=e.querySelector(".update-note"),s=e.querySelector(".update-header");t&&(t.textContent=C.currentVersion),n&&(n.textContent=C.latestVersion),C.sessionsPreserved?(s&&(s.textContent="Quick Update"),o&&(o.textContent="Sessions will stay alive",o.classList.add("update-note-safe"),o.classList.remove("update-note-warning"))):(s&&(s.textContent="Update Available"),o&&(o.textContent="Save your work - sessions will restart",o.classList.add("update-note-warning"),o.classList.remove("update-note-safe")))}function mt(){if(!C||!C.available)return;let t=document.getElementById("update-panel")?.querySelector(".update-btn");t&&(t.disabled=!0,t.textContent="Updating..."),fetch("/api/update/apply",{method:"POST"}).then(n=>{n.ok?(t&&(t.textContent="Restarting..."),jn()):(t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update failed"))}).catch(n=>{t&&(t.disabled=!1,t.textContent="Update & Restart"),console.error("Update error:",n)})}function jn(){let e=0;function t(){e++,fetch("/api/version",{cache:"no-store"}).then(n=>{n.ok?location.reload():e<vn&&setTimeout(t,Sn)}).catch(()=>{e<vn&&setTimeout(t,Sn)})}setTimeout(t,$n)}function yn(){let e=document.getElementById("btn-check-updates"),t=document.getElementById("update-status");e&&(e.disabled=!0,e.textContent="Checking..."),fetch("/api/update/check").then(n=>n.json()).then(n=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),ge(n),ut();let o=document.getElementById("btn-apply-update");if(t)if(t.classList.remove("hidden"),n&&n.available){t.className="update-status update-status-available";let s="Update available: v"+n.latestVersion;n.sessionsPreserved?s+=" (sessions will stay alive)":s+=" (sessions will restart)",t.textContent=s,o&&o.classList.remove("hidden")}else t.className="update-status update-status-current",t.textContent="You are running the latest version",o&&o.classList.add("hidden")}).catch(n=>{e&&(e.disabled=!1,e.textContent="Check for Updates"),t&&(t.classList.remove("hidden"),t.className="update-status update-status-error",t.textContent="Failed to check for updates"),console.error("Update check error:",n)})}M();var Xn="https://api.github.com/repos/AiTlbx/MiddleManager/releases?per_page=10",Yn="https://github.com/AiTlbx/MiddleManager/releases";function bn(){let e=document.getElementById("changelog-modal"),t=document.getElementById("changelog-body");e&&e.classList.remove("hidden"),t&&(t.innerHTML='<div class="changelog-loading">Loading changelog...</div>'),fetch(Xn).then(n=>n.json()).then(n=>{if(!t)return;if(!n||n.length===0){t.innerHTML="<p>No releases found.</p>";return}let o="";n.forEach(s=>{let i=s.tag_name||"Unknown",l=s.published_at?new Date(s.published_at).toLocaleDateString():"",a=s.body||"No release notes.";o+='<div class="changelog-release">',o+='<div class="changelog-version">'+H(i)+"</div>",l&&(o+='<div class="changelog-date">'+H(l)+"</div>"),o+='<div class="changelog-notes">'+Kn(a)+"</div>",o+="</div>"}),t.innerHTML=o}).catch(n=>{t&&(t.innerHTML='<p class="changelog-error">Failed to load changelog. <a href="'+Yn+'" target="_blank">View on GitHub</a></p>'),console.error("Changelog error:",n)})}function pt(){let e=document.getElementById("changelog-modal");e&&e.classList.add("hidden")}function Kn(e){return H(e).replace(/^### (.+)$/gm,"<h4>$1</h4>").replace(/^## (.+)$/gm,"<h3>$1</h3>").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^- (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}y();M();window.mmDebug={get terminals(){return p},get activeId(){return c},get settings(){return m}};Mt();document.addEventListener("DOMContentLoaded",Gn);function Gn(){wt(),nn(),on();let e=et();ve(e),Jn(),Se(),ye(),rt(),io(),dt(),Ye(),_e(),Oe(),oo(),so(),ie(),re(),to(),Zn()}function Jn(){Nt({destroyTerminalForSession:xe,applyTerminalScaling:N,renderSessionList:Y,updateEmptyState:we,selectSession:Me,updateMobileTitle:Te,renderUpdatePanel:ut}),Wt({applyTerminalScaling:N,refreshActiveTerminalBuffer:Ee}),Je({sendInput:We,showBellNotification:no}),Fe({sendResize:(e,t)=>{Ft(e,t.cols,t.rows)}}),Kt({onSelect:Me,onDelete:xn,onRename:Qn,onResize:te,onCloseSidebar:Ce})}function Zn(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&($||Se(),W||ye(),W&&c&&setTimeout(Ee,200))})}function ft(){let e=r.terminalsArea?.getBoundingClientRect(),t=m?.defaultCols??120,n=m?.defaultRows??30;if(e&&e.width>100&&e.height>100){let i=m?.fontSize??14,l=i*.6,a=i*1.2,d=8,f=e.width-d,v=e.height-d,h=Math.floor(f/l),S=Math.floor(v/a);h>10&&S>5&&(t=Math.min(h,300),n=Math.min(S,100))}let o="pending-"+Date.now(),s={id:o,name:null,shellType:"Loading...",cols:t,rows:n};u.push(s),F.add(o),Y(),Ce(),fetch("/api/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Cols:t,Rows:n})}).then(i=>i.json()).then(i=>{F.delete(o);let l=u.findIndex(a=>a.id===o);l>=0&&u.splice(l,1),j.add(i.id),Me(i.id)}).catch(i=>{F.delete(o);let l=u.findIndex(a=>a.id===o);l>=0&&(u.splice(l,1),Y(),we()),console.error("Error creating session:",i)})}function Me(e){U&&ke(),p.forEach(i=>{i.container.classList.add("hidden")}),Q(e);let t=u.find(i=>i.id===e),n=Qe(e,t),o=n.serverCols===0,s=j.has(e);n.container.classList.remove("hidden"),requestAnimationFrame(()=>{n.terminal.focus(),o&&!s&&Promise.resolve().then(()=>(tt(),Yt)).then(i=>{i.fetchAndWriteBuffer(e,n.terminal)}),s&&j.delete(e)}),Y(),Te(),r.emptyState?.classList.add("hidden")}function xn(e){xe(e);let t=u.findIndex(n=>n.id===e);t>=0&&u.splice(t,1),c===e&&(Q(null),u.length>0&&Me(u[0].id)),Y(),we(),Te(),fetch("/api/sessions/"+e,{method:"DELETE"}).catch(n=>{console.error("Error deleting session:",n)})}function En(e,t){let n=u.find(i=>i.id===e);if(!n)return;let o=(t||"").trim(),s=o===""||o===n.shellType?null:o;fetch("/api/sessions/"+e+"/name",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})}).then(()=>{n.manuallyNamed=!0}).catch(i=>{console.error("Error renaming session:",i)})}function Qn(e){let t=r.sessionList?.querySelector(`[data-session-id="${e}"]`);if(!t)return;let n=t.querySelector(".session-title");if(!n)return;let o=u.find(a=>a.id===e),s=o?o.name||o.shellType:"",i=document.createElement("input");i.type="text",i.className="session-rename-input",i.value=s;function l(){En(e,i.value),i.replaceWith(n)}i.addEventListener("blur",l),i.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),i.blur()):a.key==="Escape"&&(a.preventDefault(),i.replaceWith(n))}),n.replaceWith(i),i.focus(),i.select()}function eo(e){let t=u.find(s=>s.id===e);if(!t)return;let n=t.name||t.shellType,o=prompt("Rename terminal:",n);o!==null&&En(e,o)}function to(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().catch(()=>{})}function no(e){if(!m)return;let t=m.bellStyle||"notification",n=u.find(s=>s.id===e),o=n?O(n):"Terminal";if((t==="notification"||t==="both")&&Notification.permission==="granted"&&document.hidden&&new Notification("Bell: "+o,{body:"Terminal bell triggered",icon:"/favicon.ico"}),t==="visual"||t==="both"){let s=p.get(e);s&&(s.container.classList.add("bell-flash"),setTimeout(()=>{s.container.classList.remove("bell-flash")},200))}}function oo(){fetch("/api/version").then(e=>e.text()).then(e=>{let t=e.split(/[+-]/)[0].split(".").slice(0,3).join("."),n=document.getElementById("app-version");n&&(n.textContent="v"+t)}).catch(()=>{})}function so(){fetch("/api/networks").then(e=>e.json()).then(e=>{let t=document.getElementById("network-list");t&&(t.innerHTML=e.map(n=>'<div class="network-item"><span class="network-name" title="'+H(n.name)+'">'+H(n.name)+'</span><span class="network-ip">'+H(n.ip)+":"+location.port+"</span></div>").join(""))}).catch(()=>{})}function io(){g("btn-new-session",ft),g("btn-new-session-mobile",ft),g("btn-create-terminal",ft),g("btn-hamburger",Qt),g("btn-collapse-sidebar",en),g("btn-expand-sidebar",tn),r.sidebarOverlay&&r.sidebarOverlay.addEventListener("click",Ce),g("btn-ctrlc-mobile",()=>{c&&We(c,"")}),g("btn-resize-mobile",()=>{c&&te(c)}),g("btn-rename-mobile",()=>{c&&eo(c)}),g("btn-close-mobile",()=>{c&&xn(c)}),r.settingsBtn&&r.settingsBtn.addEventListener("click",st),g("update-btn",mt),g("btn-check-updates",yn),g("btn-apply-update",mt),g("btn-show-changelog",bn),g("btn-close-changelog",pt);let e=document.querySelector("#changelog-modal .modal-backdrop");e&&e.addEventListener("click",pt),Promise.resolve().then(()=>(at(),pn)).then(t=>{t.bindSettingsAutoSave()})}})();
